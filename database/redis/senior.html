<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.11" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.43" />
    <style>
      html {
        background: var(--bg-color, #fff);
      }

      html[data-theme="dark"] {
        background: var(--bg-color, #1d1e1f);
      }

      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="icon" href="/kd/favicon.ico"><title>é«˜é˜¶ç¯‡ | æ²–ç”°ã•ã‚“ã®çŸ¥è­˜ãƒ™ãƒ¼ã‚¹</title><meta name="description" content="2023é«˜é˜¶ç¯‡">
    <link rel="preload" href="/kd/assets/style-KpshHaNI.css" as="style"><link rel="stylesheet" href="/kd/assets/style-KpshHaNI.css">
    <link rel="modulepreload" href="/kd/assets/app-CJZ--YWM.js"><link rel="modulepreload" href="/kd/assets/senior.html-DuJMZtj6.js"><link rel="modulepreload" href="/kd/assets/plugin-vue_export-helper-DlAUqK2U.js">
    <link rel="prefetch" href="/kd/assets/index.html-CR5XXC39.js" as="script"><link rel="prefetch" href="/kd/assets/index.html-aSW_RQJX.js" as="script"><link rel="prefetch" href="/kd/assets/MongoDB.html-Ctx4LXZG.js" as="script"><link rel="prefetch" href="/kd/assets/MySQL.html-Dwe8L_D2.js" as="script"><link rel="prefetch" href="/kd/assets/index.html-nZaA4nxr.js" as="script"><link rel="prefetch" href="/kd/assets/index.html-ClzQbk84.js" as="script"><link rel="prefetch" href="/kd/assets/Axios.html-CD8LMUBC.js" as="script"><link rel="prefetch" href="/kd/assets/React.html-CYbV5CoG.js" as="script"><link rel="prefetch" href="/kd/assets/index.html-DgCaYk5D.js" as="script"><link rel="prefetch" href="/kd/assets/TypeScript.html-E3BgxsQp.js" as="script"><link rel="prefetch" href="/kd/assets/Vue.html-BTOsl5nv.js" as="script"><link rel="prefetch" href="/kd/assets/functional-programming.html-Cs72yBde.js" as="script"><link rel="prefetch" href="/kd/assets/grammar.html-CEqbEfDr.js" as="script"><link rel="prefetch" href="/kd/assets/JDK17.html-13JkKm1u.js" as="script"><link rel="prefetch" href="/kd/assets/JDK18-20.html-CcuoMJ1i.js" as="script"><link rel="prefetch" href="/kd/assets/JDK21.html-eaPli6qj.js" as="script"><link rel="prefetch" href="/kd/assets/JDK22-.html-DCc5pysJ.js" as="script"><link rel="prefetch" href="/kd/assets/JDK8.html-DetrwumP.js" as="script"><link rel="prefetch" href="/kd/assets/JDK9-16.html-CHacGy-z.js" as="script"><link rel="prefetch" href="/kd/assets/index.html-EnO3-X1c.js" as="script"><link rel="prefetch" href="/kd/assets/basic.html-DNey6xdc.js" as="script"><link rel="prefetch" href="/kd/assets/pattern.html-BzoynZ3x.js" as="script"><link rel="prefetch" href="/kd/assets/principle.html-DMxtVSJ8.js" as="script"><link rel="prefetch" href="/kd/assets/index.html-DRrQYQG7.js" as="script"><link rel="prefetch" href="/kd/assets/JVM.html-BxjXgW-i.js" as="script"><link rel="prefetch" href="/kd/assets/index.html-D3n_MKKT.js" as="script"><link rel="prefetch" href="/kd/assets/centos.html-CfPfn8D7.js" as="script"><link rel="prefetch" href="/kd/assets/common.html-Bo5G1URA.js" as="script"><link rel="prefetch" href="/kd/assets/index.html-Bp3ltp_h.js" as="script"><link rel="prefetch" href="/kd/assets/shell.html-Ctx1T8yl.js" as="script"><link rel="prefetch" href="/kd/assets/ubuntu.html-CIn8bqj6.js" as="script"><link rel="prefetch" href="/kd/assets/wsl.html-C3hGyAgw.js" as="script"><link rel="prefetch" href="/kd/assets/basic.html-a7TY6Ot4.js" as="script"><link rel="prefetch" href="/kd/assets/index.html-C_kTuioK.js" as="script"><link rel="prefetch" href="/kd/assets/principle.html-BTveM0kF.js" as="script"><link rel="prefetch" href="/kd/assets/index.html-D1up-Hbf.js" as="script"><link rel="prefetch" href="/kd/assets/uml.html-BspUsO1k.js" as="script"><link rel="prefetch" href="/kd/assets/basic.html-BgX0BRhk.js" as="script"><link rel="prefetch" href="/kd/assets/practical.html-Cp-f3Nds.js" as="script"><link rel="prefetch" href="/kd/assets/index.html-CQJWXzH7.js" as="script"><link rel="prefetch" href="/kd/assets/core.html-DYGPDRHR.js" as="script"><link rel="prefetch" href="/kd/assets/install.html-BfNzOBKK.js" as="script"><link rel="prefetch" href="/kd/assets/index.html-BmvV_2cn.js" as="script"><link rel="prefetch" href="/kd/assets/senior.html-CfxaQd8v.js" as="script"><link rel="prefetch" href="/kd/assets/index.html-C27YxI8k.js" as="script"><link rel="prefetch" href="/kd/assets/Mybatis-plus.html-B_Wtq7fX.js" as="script"><link rel="prefetch" href="/kd/assets/Mybatis.html-C4FnUMqr.js" as="script"><link rel="prefetch" href="/kd/assets/index.html-DUypf_nh.js" as="script"><link rel="prefetch" href="/kd/assets/Apache.html-j_NWlU6S.js" as="script"><link rel="prefetch" href="/kd/assets/Nginx.html-BfCoschs.js" as="script"><link rel="prefetch" href="/kd/assets/index.html-DsbxXJ8-.js" as="script"><link rel="prefetch" href="/kd/assets/index.html-BNs8Ofiz.js" as="script"><link rel="prefetch" href="/kd/assets/index.html-BHkTLdCF.js" as="script"><link rel="prefetch" href="/kd/assets/SpringMVC.html--uiKo6b_.js" as="script"><link rel="prefetch" href="/kd/assets/behavioral.html-DOgPvOXW.js" as="script"><link rel="prefetch" href="/kd/assets/creation.html-C_jOcZ7K.js" as="script"><link rel="prefetch" href="/kd/assets/index.html-z9zclZMg.js" as="script"><link rel="prefetch" href="/kd/assets/structural.html-BCtzc2uY.js" as="script"><link rel="prefetch" href="/kd/assets/core.html-COAMxiUA.js" as="script"><link rel="prefetch" href="/kd/assets/install.html-Q9H92dba.js" as="script"><link rel="prefetch" href="/kd/assets/index.html-CgepX4LG.js" as="script"><link rel="prefetch" href="/kd/assets/basic.html-DgMb93ue.js" as="script"><link rel="prefetch" href="/kd/assets/index.html-NQIPfisG.js" as="script"><link rel="prefetch" href="/kd/assets/core.html-BBRK_v3q.js" as="script"><link rel="prefetch" href="/kd/assets/integration.html-BNsQJE0M.js" as="script"><link rel="prefetch" href="/kd/assets/index.html-CC8ixUSb.js" as="script"><link rel="prefetch" href="/kd/assets/YAML.html-pNQl1LmD.js" as="script"><link rel="prefetch" href="/kd/assets/core.html-C1Ogs_cF.js" as="script"><link rel="prefetch" href="/kd/assets/index.html-CL3kaDSc.js" as="script"><link rel="prefetch" href="/kd/assets/AOP.html-CSjbLTjH.js" as="script"><link rel="prefetch" href="/kd/assets/IOC_Annoation.html-3XoIWjpw.js" as="script"><link rel="prefetch" href="/kd/assets/IOC_senior.html-CyAdliUV.js" as="script"><link rel="prefetch" href="/kd/assets/IOC_XML.html-BrMQd1R1.js" as="script"><link rel="prefetch" href="/kd/assets/index.html-Cf7wIa2_.js" as="script"><link rel="prefetch" href="/kd/assets/äº‹åŠ¡.html-D0f--wBa.js" as="script"><link rel="prefetch" href="/kd/assets/404.html-D5U_PO8b.js" as="script"><link rel="prefetch" href="/kd/assets/mermaid.core-D-uP4l9e.js" as="script"><link rel="prefetch" href="/kd/assets/reveal.esm-DNnaG029.js" as="script"><link rel="prefetch" href="/kd/assets/markdown.esm-BG2Xu2Hd.js" as="script"><link rel="prefetch" href="/kd/assets/highlight.esm-C34tS8ua.js" as="script"><link rel="prefetch" href="/kd/assets/math.esm-BwrBS7iX.js" as="script"><link rel="prefetch" href="/kd/assets/search.esm-CXqruUHR.js" as="script"><link rel="prefetch" href="/kd/assets/notes.esm-DcquA2oP.js" as="script"><link rel="prefetch" href="/kd/assets/zoom.esm-Ctj_eavO.js" as="script"><link rel="prefetch" href="/kd/assets/photoswipe.esm-SzV8tJDW.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><!--[--><div class="theme-container external-link-icon has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!----><!--[--><a class="route-link vp-brand" href="/kd/"><img class="vp-nav-logo light" src="/kd/logo.png" alt><img class="vp-nav-logo dark" src="/kd/logo-dark.png" alt><span class="vp-site-name hide-in-pad">æ²–ç”°ã•ã‚“ã®çŸ¥è­˜ãƒ™ãƒ¼ã‚¹</span></a><!--]--><!----></div><div class="vp-navbar-center"><!----><!--[--><nav class="vp-nav-links"><div class="vp-nav-item hide-in-mobile"><a class="route-link vp-link" href="/kd/" aria-label="ä¸»é¡µ"><img class="icon" src="/kd/home.png" alt aria-hidden no-view style="">ä¸»é¡µ<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link vp-link" href="/kd/basic/" aria-label="åŸºç¡€"><img class="icon" src="/kd/icon/java.png" alt aria-hidden no-view style="">åŸºç¡€<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link active vp-link" href="/kd/database/" aria-label="æ•°æ®åº“"><img class="icon" src="/kd/icon/database.svg" alt aria-hidden no-view style="">æ•°æ®åº“<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link vp-link" href="/kd/frame/" aria-label="æ¡†æ¶"><img class="icon" src="/kd/icon/frame.png" alt aria-hidden no-view style="">æ¡†æ¶<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link vp-link" href="/kd/web/" aria-label="å‰ç«¯"><img class="icon" src="/kd/icon/web.png" alt aria-hidden no-view style="">å‰ç«¯<!----></a></div></nav><!--]--><!----></div><div class="vp-navbar-end"><!----><!--[--><div class="vp-nav-item hide-in-mobile"><button type="button" class="vp-outlook-button" tabindex="-1" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon" name="outlook"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="vp-outlook-dropdown"><!----></div></button></div><div class="vp-nav-item vp-action"><a class="vp-action-link" href="https://github.com/Okita1027/kd/" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" name="github" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><!----><!--]--><!----><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!----><ul class="vp-sidebar-links"><li><a class="route-link vp-link vp-sidebar-link vp-sidebar-page" href="/kd/database/MySQL.html" aria-label="MySQL"><!---->MySQL<!----></a></li><li><a class="route-link vp-link vp-sidebar-link vp-sidebar-page" href="/kd/database/MongoDB.html" aria-label="MongoDB"><!---->MongoDB<!----></a></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><!----><span class="vp-sidebar-title">Redis</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><a class="route-link vp-link vp-sidebar-link vp-sidebar-page" href="/kd/database/redis/basic.html" aria-label="åŸºç¡€ç¯‡"><!---->åŸºç¡€ç¯‡<!----></a></li><li><a class="route-link vp-link vp-sidebar-link vp-sidebar-page" href="/kd/database/redis/practical.html" aria-label="å®æˆ˜ç¯‡"><!---->å®æˆ˜ç¯‡<!----></a></li><li><a class="route-link active vp-link vp-sidebar-link vp-sidebar-page active" href="/kd/database/redis/senior.html" aria-label="é«˜é˜¶ç¯‡"><!---->é«˜é˜¶ç¯‡<!----></a></li></ul></section></li></ul><!----></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->é«˜é˜¶ç¯‡</h1><div class="page-info"><span class="page-author-info" aria-label="ä½œè€…ğŸ–Š" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon" name="author"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://Okita1027.github.io" target="_blank" rel="noopener noreferrer">Okita</a></span><span property="author" content="Okita"></span></span><span class="page-date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon" name="calendar"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2024-09-19T17:26:07.000Z"></span><span class="page-category-info" aria-label="åˆ†ç±»ğŸŒˆ" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon" name="category"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item color7" role>æ•°æ®åº“</span><!--]--><meta property="articleSection" content="æ•°æ®åº“"></span><span class="page-tag-info" aria-label="æ ‡ç­¾ğŸ·" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon" name="tag"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item color3" role>Redis</span><!--]--><meta property="keywords" content="Redis"></span><span class="page-reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon" name="timer"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 75 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT75M"></span><span class="page-word-info" aria-label="å­—æ•°ğŸ” " data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon word-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="word icon" name="word"><path d="M518.217 432.64V73.143A73.143 73.143 0 01603.43 1.097a512 512 0 01419.474 419.474 73.143 73.143 0 01-72.046 85.212H591.36a73.143 73.143 0 01-73.143-73.143z"></path><path d="M493.714 566.857h340.297a73.143 73.143 0 0173.143 85.577A457.143 457.143 0 11371.566 117.76a73.143 73.143 0 0185.577 73.143v339.383a36.571 36.571 0 0036.571 36.571z"></path></svg><span>çº¦ 22646 å­—</span><meta property="wordCount" content="22646"></span></div><hr></div><div class="vp-toc-placeholder"><aside id="toc"><!----><div class="vp-toc-header">æ­¤é¡µå†…å®¹<button type="button" class="print-button" title="æ‰“å°"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon" name="print"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button><div class="arrow end"></div></div><div class="vp-toc-wrapper"><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#å¤§key">å¤§Key</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#more-key">More Key</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#big-key">Big Key</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ°å½“çš„keyè®¾è®¡">æ°å½“çš„Keyè®¾è®¡</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#æ‰¹å¤„ç†ä¼˜åŒ–">æ‰¹å¤„ç†ä¼˜åŒ–</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®¢æˆ·ç«¯ä¸redisçš„äº¤äº’æµç¨‹">å®¢æˆ·ç«¯ä¸Redisçš„äº¤äº’æµç¨‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#mset">MSet</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#pipeline">Pipeline</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#é›†ç¾¤ä¸‹çš„æ‰¹å¤„ç†">é›†ç¾¤ä¸‹çš„æ‰¹å¤„ç†</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#æ…¢æŸ¥è¯¢ä¼˜åŒ–">æ…¢æŸ¥è¯¢ä¼˜åŒ–</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#å†…å­˜åˆ’åˆ†ã€é…ç½®">å†…å­˜åˆ’åˆ†ã€é…ç½®</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#å¤šçº§ç¼“å­˜">å¤šçº§ç¼“å­˜</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#ç¼“å­˜åŒå†™ä¸€è‡´æ€§æ›´æ–°ç­–ç•¥">ç¼“å­˜åŒå†™ä¸€è‡´æ€§æ›´æ–°ç­–ç•¥</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åŒæ­¥ç­–ç•¥">åŒæ­¥ç­–ç•¥</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åŒæ­¥åŒå†™æ›´æ–°ç­–ç•¥">åŒæ­¥åŒå†™æ›´æ–°ç­–ç•¥</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å¼‚æ­¥é€šçŸ¥æ›´æ–°ç­–ç•¥">å¼‚æ­¥é€šçŸ¥æ›´æ–°ç­–ç•¥</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#hyperloglog">HyperLogLog</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#geo">GEO</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#å¸ƒéš†è¿‡æ»¤å™¨">å¸ƒéš†è¿‡æ»¤å™¨</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#ç¼“å­˜é¢„çƒ­ã€ç©¿é€ã€å‡»ç©¿ã€é›ªå´©">ç¼“å­˜é¢„çƒ­ã€ç©¿é€ã€å‡»ç©¿ã€é›ªå´©</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ç¼“å­˜é¢„çƒ­">ç¼“å­˜é¢„çƒ­</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ç¼“å­˜é›ªå´©">ç¼“å­˜é›ªå´©</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ç¼“å­˜ç©¿é€">ç¼“å­˜ç©¿é€</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ç¼“å­˜å‡»ç©¿">ç¼“å­˜å‡»ç©¿</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#åˆ†å¸ƒå¼é”">åˆ†å¸ƒå¼é”</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#çº¢é”">çº¢é”</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#redission">Redission</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#ç¼“å­˜è¿‡æœŸæ·˜æ±°ç­–ç•¥">ç¼“å­˜è¿‡æœŸæ·˜æ±°ç­–ç•¥</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#é»˜è®¤å†…å­˜é…ç½®">é»˜è®¤å†…å­˜é…ç½®</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#è¿‡æœŸé”®çš„åˆ é™¤ç­–ç•¥">è¿‡æœŸé”®çš„åˆ é™¤ç­–ç•¥</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ç¼“å­˜æ·˜æ±°ç­–ç•¥">ç¼“å­˜æ·˜æ±°ç­–ç•¥</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#åº•å±‚æ•°æ®ç»“æ„">åº•å±‚æ•°æ®ç»“æ„</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#sds">SDS</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#intset">intset</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#dict">Dict</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ziplist">ZipList</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#quicklist">QuickList</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#skiplist">SkipList</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#redisobject">RedisObject</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#string">String</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#list">List</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#set">Set</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#zset">ZSET</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#hash">Hash</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#redisç½‘ç»œæ¨¡å‹">Redisç½‘ç»œæ¨¡å‹</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸æ€ç©ºé—´">ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸æ€ç©ºé—´</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#é˜»å¡io">é˜»å¡IO</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#éé˜»å¡io">éé˜»å¡IO</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ioå¤šè·¯å¤ç”¨">IOå¤šè·¯å¤ç”¨</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åŸºäºepollçš„æœåŠ¡ç«¯æµç¨‹">åŸºäºEPollçš„æœåŠ¡ç«¯æµç¨‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä¿¡å·é©±åŠ¨">ä¿¡å·é©±åŠ¨</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å¼‚æ­¥io">å¼‚æ­¥IO</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å„æ¨¡å‹å¯¹æ¯”">å„æ¨¡å‹å¯¹æ¯”</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#å•çº¿ç¨‹ä¸å¤šçº¿ç¨‹">å•çº¿ç¨‹ä¸å¤šçº¿ç¨‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#respåè®®">RESPåè®®</a></li><!----><!--]--></ul><div class="vp-toc-marker" style="top:-1.7rem;"></div></div><!----></aside></div><!----><div class="theme-hope-content"><h2 id="å¤§key" tabindex="-1"><a class="header-anchor" href="#å¤§key"><span>å¤§Key</span></a></h2><h3 id="more-key" tabindex="-1"><a class="header-anchor" href="#more-key"><span>More Key</span></a></h3><p>ç”Ÿäº§ç¯å¢ƒä¸‹ï¼Œå¯èƒ½ä¼šæœ‰å¤§é‡keyï¼Œæ­¤æ—¶è‹¥æƒ³æŸ¥æ‰¾æŸä¸ªkeyï¼Œä¸èƒ½ä½¿ç”¨<code>keys *</code>ï¼Œå®ƒçš„æ—¶é—´å¤æ‚åº¦æ˜¯O(n),ä¼šé€ æˆç³»ç»Ÿä¸¥é‡çš„å¡é¡¿ã€‚</p><p>è¯¸å¦‚<code>keys</code>/<code>flushdb</code>/<code>flushall</code>ç­‰å±é™©çš„å‘½ä»¤åº”è¯¥åœ¨é…ç½®æ–‡ä»¶ä¸­ç¦ç”¨ï¼</p><div class="language-conf line-numbers-mode" data-ext="conf" data-title="conf"><pre class="language-conf"><code>rename- command keys &quot;&quot;
rename- command flushdb &quot;&quot;
rename- command flushall &quot;&quot;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><p>ä»£æ›¿<code>keys</code>çš„æŸ¥æ‰¾å‘½ä»¤ä¸º<code>scan</code>ï¼Œå…¶å˜ä½“æœ‰<code>hscan</code>ã€<code>zscan</code>â€¦â€¦</p><p>SCAN å‘½ä»¤æ˜¯ä¸€ä¸ªåŸºäºæ¸¸æ ‡çš„è¿­ä»£å™¨ï¼Œæ¯æ¬¡è¢«è°ƒç”¨ä¹‹åï¼Œ éƒ½ä¼šå‘ç”¨æˆ·è¿”å›ä¸€ä¸ªæ–°çš„æ¸¸æ ‡ï¼Œ ç”¨æˆ·åœ¨ä¸‹æ¬¡è¿­ä»£æ—¶éœ€è¦ä½¿ç”¨è¿™ä¸ªæ–°æ¸¸æ ‡ä½œä¸º SCAN å‘½ä»¤çš„æ¸¸æ ‡å‚æ•°ï¼Œ ä»¥æ­¤æ¥å»¶ç»­ä¹‹å‰çš„è¿­ä»£è¿‡ç¨‹ã€‚</p><p>è¯­æ³•ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>SCAN cursor <span class="token punctuation">[</span>MATCH pattern<span class="token punctuation">]</span> <span class="token punctuation">[</span>COUNT count<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>cursor: æ¸¸æ ‡</li><li>pattern: åŒ¹é…çš„æ¨¡å¼</li><li>count: æŒ‡å®šä»æ•°æ®é›†é‡Œè¿”å›å¤šå°‘å…ƒç´ ï¼Œé»˜è®¤ä¸º 10</li></ul><p>SCAN è¿”å›ä¸€ä¸ªåŒ…å«ä¸¤ä¸ªå…ƒç´ çš„æ•°ç»„</p><ul><li>ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯ç”¨äºè¿›è¡Œä¸‹ä¸€æ¬¡è¿­ä»£çš„æ–°æ¸¸æ ‡ï¼Œ</li><li>ç¬¬äºŒä¸ªå…ƒç´ åˆ™æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œ è¿™ä¸ªæ•°ç»„ä¸­åŒ…å«äº†æ‰€æœ‰è¢«è¿­ä»£çš„å…ƒç´ ã€‚å¦‚æœæ–°æ¸¸æ ‡è¿”å›é›¶è¡¨ç¤ºè¿­ä»£å·²ç»“æŸã€‚</li></ul><p>SCANçš„éå†é¡ºåº</p><p>éå¸¸ç‰¹åˆ«ï¼Œå®ƒä¸æ˜¯ä»ç¬¬ä¸€ç»´æ•°ç»„çš„ç¬¬é›¶ä½ä¸€ç›´éå†åˆ°æœ«å°¾ï¼Œè€Œæ˜¯é‡‡ç”¨äº†é«˜ä½è¿›ä½åŠ æ³•æ¥éå†ã€‚ä¹‹æ‰€ä»¥ä½¿ç”¨è¿™æ ·ç‰¹æ®Šçš„æ–¹å¼è¿›è¡Œéå†ï¼Œæ˜¯è€ƒè™‘åˆ°å­—å…¸çš„æ‰©å®¹å’Œç¼©å®¹æ—¶é¿å…æ§½ä½çš„éå†é‡å¤å’Œé—æ¼ã€‚</p><p>DEMOæ¡ˆä¾‹</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> keys *
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;k2&quot;</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">&quot;k1&quot;</span>
<span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">&quot;k3&quot;</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> SCAN <span class="token number">0</span> MATCH * COUNT <span class="token number">1</span>
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;2&quot;</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;k2&quot;</span>
   <span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">&quot;k1&quot;</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> SCAN <span class="token number">2</span> MATCH * COUNT <span class="token number">1</span>
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;0&quot;</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;k3&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="big-key" tabindex="-1"><a class="header-anchor" href="#big-key"><span>Big Key</span></a></h3><p><strong>Big Key åˆ¤å®šè§„åˆ™</strong></p><ul><li>Keyæœ¬èº«çš„æ•°æ®é‡è¿‡å¤§ï¼šä¸€ä¸ªStringç±»å‹çš„Keyï¼Œå®ƒçš„å€¼ä¸º 5 MB</li><li>Keyä¸­çš„æˆå‘˜æ•°è¿‡å¤šï¼šä¸€ä¸ªZSETç±»å‹çš„Keyï¼Œå®ƒçš„æˆå‘˜æ•°é‡ä¸º10,000ä¸ª</li><li>Keyä¸­æˆå‘˜çš„æ•°æ®é‡è¿‡å¤§ï¼šä¸€ä¸ªHashç±»å‹çš„Keyï¼Œå®ƒçš„æˆå‘˜æ•°é‡è™½ç„¶åªæœ‰1,000ä¸ªä½†è¿™äº›æˆå‘˜çš„Valueï¼ˆå€¼ï¼‰æ€»å¤§å°ä¸º100 MB</li></ul><blockquote><p>é˜¿é‡Œå¼€å‘è§„èŒƒï¼š</p><ul><li>Stringæ§åˆ¶åœ¨ 10KB,hashã€listã€zestã€setå…ƒç´ ä¸ªæ•°ä¸è¶…è¿‡5000ï¼›</li><li>éå­—ç¬¦ä¸²çš„bigkey,ä¸èƒ½ä½¿ç”¨delåˆ é™¤ï¼Œè¦ç”¨hscanã€sscanã€zscanæ–¹å¼æ¸è¿›åˆ é™¤ï¼ŒåŒæ—¶é˜²æ­¢bigkeyè¿‡æœŸæ—¶é—´è‡ªåŠ¨åˆ é™¤çš„é—®é¢˜</li></ul></blockquote><p><strong>Big Keyçš„å±å®³</strong></p><ul><li>ç½‘ç»œé˜»å¡ <ul><li>å¯¹BigKeyæ‰§è¡Œè¯»è¯·æ±‚æ—¶ï¼Œå°‘é‡çš„QPSå°±å¯èƒ½å¯¼è‡´å¸¦å®½ä½¿ç”¨ç‡è¢«å æ»¡ï¼Œå¯¼è‡´Rediså®ä¾‹ï¼Œä¹ƒè‡³æ‰€åœ¨ç‰©ç†æœºå˜æ…¢</li></ul></li><li>æ•°æ®å€¾æ–œ <ul><li>BigKeyæ‰€åœ¨çš„Rediså®ä¾‹å†…å­˜ä½¿ç”¨ç‡è¿œè¶…å…¶ä»–å®ä¾‹ï¼Œæ— æ³•ä½¿æ•°æ®åˆ†ç‰‡çš„å†…å­˜èµ„æºè¾¾åˆ°å‡è¡¡</li></ul></li><li>Redisé˜»å¡ <ul><li>å¯¹å…ƒç´ è¾ƒå¤šçš„hashã€listã€zsetç­‰åšè¿ç®—ä¼šè€—æ—¶è¾ƒä¹…ï¼Œä½¿ä¸»çº¿ç¨‹è¢«é˜»å¡</li></ul></li><li>CPUå‹åŠ› <ul><li>å¯¹BigKeyçš„æ•°æ®åºåˆ—åŒ–å’Œååºåˆ—åŒ–ä¼šå¯¼è‡´CPUçš„ä½¿ç”¨ç‡é£™å‡ï¼Œå½±å“Rediså®ä¾‹å’Œæœ¬æœºå…¶å®ƒåº”ç”¨</li></ul></li></ul><p><strong>å¦‚ä½•å‘ç°</strong></p><ol><li>keyå°äº10KBï¼Œåˆ™ä½¿ç”¨â€“bigkeys</li></ol><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token comment"># æ¯éš” 100 æ¡ scan æŒ‡ä»¤å°±ä¼šä¼‘çœ  0.1sï¼Œops å°±ä¸ä¼šå‰§çƒˆæŠ¬å‡ï¼Œä½†æ˜¯æ‰«æçš„æ—¶é—´ä¼šå˜é•¿</span>
redis-cli <span class="token parameter variable">-h</span> <span class="token number">127.0</span>.0.1 <span class="token parameter variable">-p</span> <span class="token number">7001</span> â€“-bigkeys <span class="token parameter variable">-i</span> <span class="token number">0.1</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>ä½¿ç”¨memory usage ï¼ˆæ­¤æŒ‡ä»¤CPUå ç”¨ç‡é«˜ï¼Œåˆ©ç”¨strlenã€hlenç­‰å‘½ä»¤åˆ¤æ–­keyçš„é•¿åº¦å³å¯ï¼‰</li></ol><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>MEMORY USAGE key <span class="token punctuation">[</span>SAMPLES count<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ol start="3"><li><p>åˆ©ç”¨ç¬¬ä¸‰æ–¹å·¥å…·ï¼Œå¦‚ Redis-Rdb-Tools åˆ†æRDBå¿«ç…§æ–‡ä»¶ï¼Œå…¨é¢åˆ†æå†…å­˜ä½¿ç”¨æƒ…å†µ</p><p>https://github.com/sripathikrishnan/redis-rdb-tools</p></li><li><p>ç½‘ç»œç›‘æ§</p><ul><li>è‡ªå®šä¹‰å·¥å…·ï¼Œç›‘æ§è¿›å‡ºRedisçš„ç½‘ç»œæ•°æ®ï¼Œè¶…å‡ºé¢„è­¦å€¼æ—¶ä¸»åŠ¨å‘Šè­¦</li><li>ä¸€èˆ¬é˜¿é‡Œäº‘æ­å»ºçš„äº‘æœåŠ¡å™¨å°±æœ‰ç›¸å…³ç›‘æ§é¡µé¢</li></ul></li></ol><p><strong>å¦‚ä½•åˆ é™¤</strong></p><ul><li><p>Stringï¼šä¸€èˆ¬ä½¿ç”¨<code>del</code>,è‹¥è¿‡å¤§åˆ™ä½¿ç”¨å¼‚æ­¥åˆ é™¤å‘½ä»¤<code>unlink</code></p></li><li><p>hash:ä½¿ç”¨<code>hscan</code>æ¯æ¬¡è·å–å°‘é‡çš„field-value,å†ä½¿ç”¨<code>hdel</code>åˆ é™¤æ¯ä¸ªfield</p><ul><li><p>HSCAN å‘½ä»¤åŸºæœ¬è¯­æ³•:<code>HSCAN key cursor [MATCH pattern] [COUNT count]</code></p><ul><li>cursor-æ¸¸æ ‡</li><li>pattern-åŒ¹é…çš„æ¨¡å¼</li><li>count-æŒ‡å®šä»æ•°æ®é›†é‡Œè¿”å›å¤šå°‘å…ƒç´ ï¼Œé»˜è®¤å€¼ä¸º 10</li></ul></li><li><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delBigList</span><span class="token punctuation">(</span><span class="token class-name">String</span> host<span class="token punctuation">,</span> <span class="token keyword">int</span> port<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">,</span> <span class="token class-name">String</span> biglistKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Jedis</span> jedis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jedis</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>password <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token string">&quot;&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    	jedis<span class="token punctuation">.</span><span class="token function">auth</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">long</span> llen <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">llen</span><span class="token punctuation">(</span>bigListkey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> left <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>counter<span class="token operator">&lt;</span>llen<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//æ¯æ¬¡ä»å·¦ä¾§æˆªæ¯100ä¸ª</span>
        jedis<span class="token punctuation">.</span><span class="token function">ltrim</span><span class="token punctuation">(</span>bigListKey<span class="token punctuation">,</span> left<span class="token punctuation">,</span> llen<span class="token punctuation">)</span><span class="token punctuation">;</span>
        counter <span class="token operator">+=</span> left<span class="token punctuation">;</span>
        <span class="token comment">//æœ€ç»ˆåˆ é™¤key</span>
        jedis<span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span>bigListkey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li></li></ul></li><li><p>list:ä½¿ç”¨<code>ltrim</code>æ¸è¿›å¼é€æ­¥åˆ é™¤ï¼ŒçŸ¥é“å…¨éƒ¨åˆ é™¤å®Œæˆ</p><ul><li><p><code>LTRIM KEY_NAME START STOP</code>:åˆ é™¤STARTâ€”â€”STOPä¹‹å¤–çš„å…ƒç´ </p></li><li><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delBiglist</span><span class="token punctuation">(</span><span class="token class-name">String</span> host<span class="token punctuation">,</span> <span class="token keyword">int</span> port<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">,</span> <span class="token class-name">String</span> biglistKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Jedis</span> jedis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jedis</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>password <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token string">&quot;&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        jedis<span class="token punctuation">.</span><span class="token function">auth</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> llen <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">llen</span><span class="token punctuation">(</span>bigListKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> counter <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> left <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>counter<span class="token operator">&lt;</span>llen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//æ¯æ¬¡ä»å·¦ä¾§æˆªæ¯100ä¸ª</span>
        jedis<span class="token punctuation">.</span><span class="token function">ltrim</span><span class="token punctuation">(</span>bigListKey<span class="token punctuation">,</span> left<span class="token punctuation">,</span> llen<span class="token punctuation">)</span><span class="token punctuation">;</span>
        counter <span class="token operator">+=</span> left<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//æœ€ç»ˆåˆ é™¤key</span>
    jedis<span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span>bigListKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul></li><li><p>set:ä½¿ç”¨<code>sscan</code>æ¯æ¬¡è·å–éƒ¨åˆ†å…ƒç´ ï¼Œå†ä½¿ç”¨<code>srem</code>åˆ é™¤æ¯ä¸ªå…ƒç´ </p><ul><li><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delBigSet</span><span class="token punctuation">(</span><span class="token class-name">String</span> host<span class="token punctuation">,</span> <span class="token keyword">int</span> port<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">,</span> <span class="token class-name">String</span> bigsetkey<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">Jedis</span> jedis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jedis</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>password <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span><span class="token operator">!</span><span class="token string">&quot;&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    	jedis<span class="token punctuation">.</span><span class="token function">auth</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">ScanParams</span> scanParams <span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ScanParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> cursor <span class="token operator">=</span> â€œ<span class="token number">0</span>â€<span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token class-name">ScanResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span>scanResult <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">sscan</span><span class="token punctuation">(</span>bigSetKey<span class="token punctuation">,</span>cursor<span class="token punctuation">,</span> scanParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span>memberList<span class="token operator">=</span>scanResult<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>memberList <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>memberList<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">String</span> member <span class="token operator">:</span>memberList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        		jedis<span class="token punctuation">.</span><span class="token function">srem</span><span class="token punctuation">(</span>bigSetKey<span class="token punctuation">,</span>member<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        cursor <span class="token operator">=</span>scanResult<span class="token punctuation">.</span><span class="token function">getStringCursor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>cursor<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
    <span class="token comment">//åˆ é™¤bigkey</span>
    jedis<span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span>bigSetKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul></li><li><p>zset:ä½¿ç”¨<code>zscan</code>æ¯æ¬¡è·å–éƒ¨åˆ†å…ƒç´ ï¼Œå†ä½¿ç”¨<code>zremrangebyrank</code>åˆ é™¤æ¯ä¸ªå…ƒç´ </p><ul><li><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delBigZset</span><span class="token punctuation">(</span><span class="token class-name">String</span> host<span class="token punctuation">,</span> <span class="token keyword">int</span> port<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">,</span> <span class="token class-name">String</span> bigZsetKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Jedis</span> jedis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jedis</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>password <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span><span class="token operator">!</span><span class="token string">&quot;&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    	jedis<span class="token punctuation">.</span><span class="token function">auth</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">ScanParams</span> scanParams <span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ScanParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> cursor <span class="token operator">=</span>â€œ<span class="token number">0</span>â€<span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token class-name">ScanResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple</span><span class="token punctuation">&gt;</span></span>scanResult <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">zscan</span><span class="token punctuation">(</span>bigZsetKey<span class="token punctuation">,</span> cursor<span class="token punctuation">,</span> scanParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple</span><span class="token punctuation">&gt;</span></span>tupleList<span class="token operator">=</span>scanResult<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>tupleList <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>tupleList<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Tuple</span> tuple <span class="token operator">:</span>tupleList<span class="token punctuation">)</span><span class="token punctuation">{</span>
        		jedis<span class="token punctuation">.</span><span class="token function">zrem</span><span class="token punctuation">(</span>bigZsetKey<span class="token punctuation">,</span>tuple<span class="token punctuation">.</span><span class="token function">getElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        cursor <span class="token operator">=</span>scanResult<span class="token punctuation">.</span><span class="token function">getStringCursor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>cursor<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//åˆ é™¤bigkey</span>
    jedis<span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span>bigZsetkey<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul></li></ul><p><strong>ç”Ÿäº§è°ƒä¼˜</strong></p><p>åœ¨Redisé…ç½®æ–‡ä»¶ä¸­é…ç½®LAZY FREEING</p><div class="language-conf line-numbers-mode" data-ext="conf" data-title="conf"><pre class="language-conf"><code>lazy-free-lazy-server-del yes
replica-lazy-flush yes
lazyfree-lazy-user-del yes
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="æ°å½“çš„keyè®¾è®¡" tabindex="-1"><a class="header-anchor" href="#æ°å½“çš„keyè®¾è®¡"><span>æ°å½“çš„Keyè®¾è®¡</span></a></h3><p>Redisçš„Keyè™½ç„¶å¯ä»¥è‡ªå®šä¹‰ï¼Œä½†æœ€å¥½éµå¾ªä¸‹é¢çš„å‡ ä¸ªæœ€ä½³å®è·µçº¦å®šï¼š</p><ul><li>éµå¾ªåŸºæœ¬æ ¼å¼ï¼š[ä¸šåŠ¡åç§°]:[æ•°æ®å]:[id]</li><li>é•¿åº¦ä¸è¶…è¿‡44å­—èŠ‚</li><li>ä¸åŒ…å«ç‰¹æ®Šå­—ç¬¦</li></ul><p>ä¾‹å¦‚ï¼šæˆ‘ä»¬çš„ç™»å½•ä¸šåŠ¡ï¼Œä¿å­˜ç”¨æˆ·ä¿¡æ¯ï¼Œå…¶keyå¯ä»¥è®¾è®¡æˆå¦‚ä¸‹æ ¼å¼ï¼š</p><p><code>login:user:10</code></p><ul><li>login:ä¸šåŠ¡åç§°</li><li>user:æ•°æ®åç§°</li><li>10:æ•°æ®ID</li></ul><p>è¿™æ ·è®¾è®¡çš„å¥½å¤„ï¼š</p><ul><li>å¯è¯»æ€§å¼º</li><li>é¿å…keyå†²çª</li><li>æ–¹ä¾¿ç®¡ç†</li><li>æ›´èŠ‚çœå†…å­˜ï¼š keyæ˜¯stringç±»å‹ï¼Œåº•å±‚ç¼–ç åŒ…å«intã€embstrå’Œrawä¸‰ç§ã€‚embstråœ¨å°äº44å­—èŠ‚ä½¿ç”¨ï¼Œé‡‡ç”¨è¿ç»­å†…å­˜ç©ºé—´ï¼Œå†…å­˜å ç”¨æ›´å°ã€‚å½“å­—èŠ‚æ•°å¤§äº44å­—èŠ‚æ—¶ï¼Œä¼šè½¬ä¸ºrawæ¨¡å¼å­˜å‚¨ï¼Œåœ¨rawæ¨¡å¼ä¸‹ï¼Œå†…å­˜ç©ºé—´ä¸æ˜¯è¿ç»­çš„ï¼Œè€Œæ˜¯é‡‡ç”¨ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘äº†å¦å¤–ä¸€æ®µå†…å­˜ç©ºé—´ï¼Œåœ¨è¿™æ®µç©ºé—´é‡Œå­˜å‚¨SDSå†…å®¹ï¼Œè¿™æ ·ç©ºé—´ä¸è¿ç»­ï¼Œè®¿é—®çš„æ—¶å€™æ€§èƒ½ä¹Ÿå°±ä¼šæ”¶åˆ°å½±å“ï¼Œè¿˜æœ‰å¯èƒ½äº§ç”Ÿå†…å­˜ç¢ç‰‡</li></ul><h2 id="æ‰¹å¤„ç†ä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#æ‰¹å¤„ç†ä¼˜åŒ–"><span>æ‰¹å¤„ç†ä¼˜åŒ–</span></a></h2><h3 id="å®¢æˆ·ç«¯ä¸redisçš„äº¤äº’æµç¨‹" tabindex="-1"><a class="header-anchor" href="#å®¢æˆ·ç«¯ä¸redisçš„äº¤äº’æµç¨‹"><span>å®¢æˆ·ç«¯ä¸Redisçš„äº¤äº’æµç¨‹</span></a></h3><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior01.png" alt="å•ä¸ªå‘½ä»¤çš„æ‰§è¡Œæµç¨‹" tabindex="0" loading="lazy"><figcaption>å•ä¸ªå‘½ä»¤çš„æ‰§è¡Œæµç¨‹</figcaption></figure><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior02.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>Rediså¤„ç†æŒ‡ä»¤æ˜¯å¾ˆå¿«çš„ï¼Œä¸»è¦èŠ±è´¹çš„æ—¶å€™åœ¨äºç½‘ç»œä¼ è¾“ã€‚äºæ˜¯ä¹å¾ˆå®¹æ˜“æƒ³åˆ°å°†å¤šæ¡æŒ‡ä»¤æ‰¹é‡çš„ä¼ è¾“ç»™redis</p><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior03.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="mset" tabindex="-1"><a class="header-anchor" href="#mset"><span>MSet</span></a></h3><p>Redisæä¾›äº†å¾ˆå¤šMxxxè¿™æ ·çš„å‘½ä»¤ï¼Œå¯ä»¥å®ç°æ‰¹é‡æ’å…¥æ•°æ®ï¼Œä¾‹å¦‚ï¼š</p><ul><li>mset</li><li>hmset</li></ul><p>åˆ©ç”¨msetæ‰¹é‡æ’å…¥10ä¸‡æ¡æ•°æ®</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testMxx</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token number">2000</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> j<span class="token punctuation">;</span>
    <span class="token keyword">long</span> b <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">100000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        j <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
        arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;test:key_&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">;</span>
        arr<span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;value_&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>j <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            jedis<span class="token punctuation">.</span><span class="token function">mset</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">long</span> e <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;time: &quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>e <span class="token operator">-</span> b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="pipeline" tabindex="-1"><a class="header-anchor" href="#pipeline"><span>Pipeline</span></a></h3><p>MSETè™½ç„¶å¯ä»¥æ‰¹å¤„ç†ï¼Œä½†æ˜¯å´åªèƒ½æ“ä½œéƒ¨åˆ†æ•°æ®ç±»å‹ï¼Œå› æ­¤å¦‚æœæœ‰å¯¹å¤æ‚æ•°æ®ç±»å‹çš„æ‰¹å¤„ç†éœ€è¦ï¼Œå»ºè®®ä½¿ç”¨Pipeline</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testPipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// åˆ›å»ºç®¡é“</span>
    <span class="token class-name">Pipeline</span> pipeline <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">pipelined</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> b <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">100000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ”¾å…¥å‘½ä»¤åˆ°ç®¡é“</span>
        pipeline<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;test:key_&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">,</span> <span class="token string">&quot;value_&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">1000</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// æ¯æ”¾å…¥1000æ¡å‘½ä»¤ï¼Œæ‰¹é‡æ‰§è¡Œ</span>
            pipeline<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">long</span> e <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;time: &quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>e <span class="token operator">-</span> b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="é›†ç¾¤ä¸‹çš„æ‰¹å¤„ç†" tabindex="-1"><a class="header-anchor" href="#é›†ç¾¤ä¸‹çš„æ‰¹å¤„ç†"><span>é›†ç¾¤ä¸‹çš„æ‰¹å¤„ç†</span></a></h3><p>å¦‚MSETæˆ–Pipelineè¿™æ ·çš„æ‰¹å¤„ç†éœ€è¦åœ¨ä¸€æ¬¡è¯·æ±‚ä¸­æºå¸¦å¤šæ¡å‘½ä»¤ï¼Œè€Œæ­¤æ—¶å¦‚æœRedisæ˜¯ä¸€ä¸ªé›†ç¾¤ï¼Œé‚£æ‰¹å¤„ç†å‘½ä»¤çš„å¤šä¸ªkeyå¿…é¡»è½åœ¨ä¸€ä¸ªæ’æ§½ä¸­ï¼Œå¦åˆ™å°±ä¼šå¯¼è‡´æ‰§è¡Œå¤±è´¥ã€‚å¤§å®¶å¯ä»¥æƒ³ä¸€æƒ³è¿™æ ·çš„è¦æ±‚å…¶å®å¾ˆéš¾å®ç°ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨æ‰¹å¤„ç†æ—¶ï¼Œå¯èƒ½ä¸€æ¬¡è¦æ’å…¥å¾ˆå¤šæ¡æ•°æ®ï¼Œè¿™äº›æ•°æ®å¾ˆæœ‰å¯èƒ½ä¸ä¼šéƒ½è½åœ¨ç›¸åŒçš„èŠ‚ç‚¹ä¸Šï¼Œè¿™å°±ä¼šå¯¼è‡´æŠ¥é”™äº†</p><p>æœ‰4ç§è§£å†³æ–¹æ¡ˆ</p><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior04.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li><p>ç¬¬ä¸€ç§æ–¹æ¡ˆï¼šä¸²è¡Œæ‰§è¡Œï¼Œæ‰€ä»¥è¿™ç§æ–¹å¼æ²¡æœ‰ä»€ä¹ˆæ„ä¹‰ï¼Œå½“ç„¶ï¼Œæ‰§è¡Œèµ·æ¥å°±å¾ˆç®€å•äº†ï¼Œç¼ºç‚¹å°±æ˜¯è€—æ—¶è¿‡ä¹…ã€‚</p></li><li><p>ç¬¬äºŒç§æ–¹æ¡ˆï¼šä¸²è¡Œslotï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯æ‰§è¡Œå‰ï¼Œå®¢æˆ·ç«¯å…ˆè®¡ç®—ä¸€ä¸‹å¯¹åº”çš„keyçš„slotï¼Œä¸€æ ·slotçš„keyå°±æ”¾åˆ°ä¸€ä¸ªç»„é‡Œè¾¹ï¼Œä¸åŒçš„ï¼Œå°±æ”¾åˆ°ä¸åŒçš„ç»„é‡Œè¾¹ï¼Œç„¶åå¯¹æ¯ä¸ªç»„æ‰§è¡Œpipelineçš„æ‰¹å¤„ç†ï¼Œä»–å°±èƒ½ä¸²è¡Œæ‰§è¡Œå„ä¸ªç»„çš„å‘½ä»¤ï¼Œè¿™ç§åšæ³•æ¯”ç¬¬ä¸€ç§æ–¹æ³•è€—æ—¶è¦å°‘ï¼Œä½†æ˜¯ç¼ºç‚¹å‘¢ï¼Œç›¸å¯¹æ¥è¯´å¤æ‚ä¸€ç‚¹ï¼Œæ‰€ä»¥è¿™ç§æ–¹æ¡ˆè¿˜éœ€è¦ä¼˜åŒ–ä¸€ä¸‹</p></li><li><p>ç¬¬ä¸‰ç§æ–¹æ¡ˆï¼šå¹¶è¡Œslotï¼Œç›¸è¾ƒäºç¬¬äºŒç§æ–¹æ¡ˆï¼Œåœ¨åˆ†ç»„å®Œæˆåä¸²è¡Œæ‰§è¡Œï¼Œç¬¬ä¸‰ç§æ–¹æ¡ˆï¼Œå°±å˜æˆäº†å¹¶è¡Œæ‰§è¡Œå„ä¸ªå‘½ä»¤ï¼Œæ‰€ä»¥ä»–çš„è€—æ—¶å°±éå¸¸çŸ­ï¼Œä½†æ˜¯å®ç°å‘¢ï¼Œä¹Ÿæ›´åŠ å¤æ‚ã€‚</p></li><li><p>ç¬¬å››ç§ï¼šhash_tagï¼Œredisè®¡ç®—keyçš„slotçš„æ—¶å€™ï¼Œå…¶å®æ˜¯æ ¹æ®keyçš„æœ‰æ•ˆéƒ¨åˆ†æ¥è®¡ç®—çš„ï¼Œé€šè¿‡è¿™ç§æ–¹å¼å°±èƒ½ä¸€æ¬¡å¤„ç†æ‰€æœ‰çš„keyï¼Œè¿™ç§æ–¹å¼è€—æ—¶æœ€çŸ­ï¼Œå®ç°ä¹Ÿç®€å•ï¼Œä½†æ˜¯å¦‚æœé€šè¿‡æ“ä½œkeyçš„æœ‰æ•ˆéƒ¨åˆ†ï¼Œé‚£ä¹ˆå°±ä¼šå¯¼è‡´æ‰€æœ‰çš„keyéƒ½è½åœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼Œäº§ç”Ÿæ•°æ®å€¾æ–œçš„é—®é¢˜ï¼Œæ‰€ä»¥<strong>æ¨èä½¿ç”¨ç¬¬ä¸‰ç§æ–¹å¼</strong>ã€‚</p></li></ul><h2 id="æ…¢æŸ¥è¯¢ä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#æ…¢æŸ¥è¯¢ä¼˜åŒ–"><span>æ…¢æŸ¥è¯¢ä¼˜åŒ–</span></a></h2><p>**å®šä¹‰ï¼š**åœ¨Redisæ‰§è¡Œæ—¶è€—æ—¶è¶…è¿‡æŸä¸ªé˜ˆå€¼çš„å‘½ä»¤ï¼Œç§°ä¸ºæ…¢æŸ¥è¯¢ã€‚</p><p>**å±å®³ï¼š**ç”±äºRedisæ˜¯å•çº¿ç¨‹çš„ï¼Œæ‰€ä»¥å½“å®¢æˆ·ç«¯å‘å‡ºæŒ‡ä»¤åï¼Œä»–ä»¬éƒ½ä¼šè¿›å…¥åˆ°redisåº•å±‚çš„queueæ¥æ‰§è¡Œï¼Œå¦‚æœæ­¤æ—¶æœ‰ä¸€äº›æ…¢æŸ¥è¯¢çš„æ•°æ®ï¼Œå°±ä¼šå¯¼è‡´å¤§é‡è¯·æ±‚é˜»å¡ï¼Œä»è€Œå¼•èµ·æŠ¥é”™ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è§£å†³æ…¢æŸ¥è¯¢é—®é¢˜ã€‚</p><p>æ…¢æŸ¥è¯¢çš„é˜ˆå€¼å¯ä»¥é€šè¿‡é…ç½®æŒ‡å®šï¼š</p><ul><li>slowlog-log-slower-thanï¼šæ…¢æŸ¥è¯¢é˜ˆå€¼ï¼Œå•ä½æ˜¯å¾®ç§’ã€‚é»˜è®¤æ˜¯10000ï¼Œå»ºè®®1000ã€‚</li></ul><p>æ…¢æŸ¥è¯¢ä¼šè¢«æ”¾å…¥æ…¢æŸ¥è¯¢æ—¥å¿—ä¸­ï¼Œæ—¥å¿—çš„é•¿åº¦æœ‰ä¸Šé™ï¼Œå¯ä»¥é€šè¿‡é…ç½®æŒ‡å®šï¼š</p><ul><li>slowlog-max-lenï¼šæ…¢æŸ¥è¯¢æ—¥å¿—ï¼ˆæœ¬è´¨æ˜¯ä¸€ä¸ªé˜Ÿåˆ—ï¼‰çš„é•¿åº¦ã€‚é»˜è®¤æ˜¯128ï¼Œå»ºè®®1000ã€‚</li></ul><p>ä¿®æ”¹è¿™ä¸¤ä¸ªé…ç½®å¯ä»¥ä½¿ç”¨ <code>config set</code>å‘½ä»¤ã€‚</p><p><strong>æŸ¥çœ‹æ…¢æŸ¥è¯¢</strong></p><ul><li><code>slowlog len</code>ï¼šæŸ¥è¯¢æ…¢æŸ¥è¯¢æ—¥å¿—é•¿åº¦</li><li><code>slowlog get [n]</code>ï¼šè¯»å–næ¡æ…¢æŸ¥è¯¢æ—¥å¿—</li><li><code>slowlog reset</code>ï¼šæ¸…ç©ºæ…¢æŸ¥è¯¢åˆ—è¡¨</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior05.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="å†…å­˜åˆ’åˆ†ã€é…ç½®" tabindex="-1"><a class="header-anchor" href="#å†…å­˜åˆ’åˆ†ã€é…ç½®"><span>å†…å­˜åˆ’åˆ†ã€é…ç½®</span></a></h2><p>å½“Rediså†…å­˜ä¸è¶³æ—¶ï¼Œå¯èƒ½å¯¼è‡´Keyé¢‘ç¹è¢«åˆ é™¤ã€å“åº”æ—¶é—´å˜é•¿ã€QPSä¸ç¨³å®šç­‰é—®é¢˜ã€‚å½“å†…å­˜ä½¿ç”¨ç‡è¾¾åˆ°90%ä»¥ä¸Šæ—¶å°±éœ€è¦æˆ‘ä»¬è­¦æƒ•ï¼Œå¹¶å¿«é€Ÿå®šä½åˆ°å†…å­˜å ç”¨çš„åŸå› ã€‚</p><p><strong>ç¢ç‰‡é—®é¢˜åˆ†æ</strong></p><p>Redisåº•å±‚åˆ†é…å¹¶ä¸æ˜¯è¿™ä¸ªkeyæœ‰å¤šå¤§ï¼Œä»–å°±ä¼šåˆ†é…å¤šå¤§ï¼Œè€Œæ˜¯æœ‰ä»–è‡ªå·±çš„åˆ†é…ç­–ç•¥ï¼Œæ¯”å¦‚8,16,20ç­‰ç­‰ï¼Œå‡å®šå½“å‰keyåªéœ€è¦10ä¸ªå­—èŠ‚ï¼Œæ­¤æ—¶åˆ†é…8è‚¯å®šä¸å¤Ÿï¼Œé‚£ä¹ˆä»–å°±ä¼šåˆ†é…16ä¸ªå­—èŠ‚ï¼Œå¤šå‡ºæ¥çš„6ä¸ªå­—èŠ‚å°±ä¸èƒ½è¢«ä½¿ç”¨ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„ ç¢ç‰‡é—®é¢˜</p><p><strong>è¿›ç¨‹å†…å­˜é—®é¢˜åˆ†æ</strong></p><p>è¿™ç‰‡å†…å­˜ï¼Œé€šå¸¸éƒ½å¯ä»¥å¿½ç•¥ä¸è®¡</p><p><strong>ç¼“å†²åŒºå†…å­˜é—®é¢˜åˆ†æ</strong></p><p>ä¸€èˆ¬åŒ…æ‹¬å®¢æˆ·ç«¯ç¼“å†²åŒºã€AOFç¼“å†²åŒºã€å¤åˆ¶ç¼“å†²åŒºç­‰ã€‚å®¢æˆ·ç«¯ç¼“å†²åŒºåˆåŒ…æ‹¬è¾“å…¥ç¼“å†²åŒºå’Œè¾“å‡ºç¼“å†²åŒºä¸¤ç§ã€‚è¿™éƒ¨åˆ†å†…å­˜å ç”¨æ³¢åŠ¨è¾ƒå¤§ï¼Œæ‰€ä»¥è¿™ç‰‡å†…å­˜ä¹Ÿæ˜¯æˆ‘ä»¬éœ€è¦é‡ç‚¹åˆ†æçš„å†…å­˜é—®é¢˜ã€‚</p><table><thead><tr><th style="text-align:center;"><strong>å†…å­˜å ç”¨</strong></th><th style="text-align:center;"><strong>è¯´æ˜</strong></th></tr></thead><tbody><tr><td style="text-align:center;">æ•°æ®å†…å­˜</td><td style="text-align:center;">æ˜¯Redisæœ€ä¸»è¦çš„éƒ¨åˆ†ï¼Œå­˜å‚¨Redisçš„é”®å€¼ä¿¡æ¯ã€‚ä¸»è¦é—®é¢˜æ˜¯BigKeyé—®é¢˜ã€å†…å­˜ç¢ç‰‡é—®é¢˜</td></tr><tr><td style="text-align:center;">è¿›ç¨‹å†…å­˜</td><td style="text-align:center;">Redisä¸»è¿›ç¨‹æœ¬èº«è¿â¾è‚¯å®šéœ€è¦å â½¤å†…å­˜ï¼Œå¦‚ä»£ç ã€å¸¸é‡æ± ç­‰ç­‰ï¼›è¿™éƒ¨åˆ†å†…å­˜â¼¤çº¦â¼å…†ï¼Œåœ¨â¼¤å¤šæ•°â½£äº§ç¯å¢ƒä¸­ä¸Redisæ•°æ®å â½¤çš„å†…å­˜ç›¸â½å¯ä»¥å¿½ç•¥ã€‚</td></tr><tr><td style="text-align:center;">ç¼“å†²åŒºå†…å­˜</td><td style="text-align:center;">ä¸€èˆ¬åŒ…æ‹¬å®¢æˆ·ç«¯ç¼“å†²åŒºã€AOFç¼“å†²åŒºã€å¤åˆ¶ç¼“å†²åŒºç­‰ã€‚å®¢æˆ·ç«¯ç¼“å†²åŒºåˆåŒ…æ‹¬è¾“å…¥ç¼“å†²åŒºå’Œè¾“å‡ºç¼“å†²åŒºä¸¤ç§ã€‚è¿™éƒ¨åˆ†å†…å­˜å ç”¨æ³¢åŠ¨è¾ƒå¤§ï¼Œä¸å½“ä½¿ç”¨BigKeyï¼Œå¯èƒ½å¯¼è‡´å†…å­˜æº¢å‡ºã€‚</td></tr></tbody></table><p>äºæ˜¯æˆ‘ä»¬å°±éœ€è¦é€šè¿‡ä¸€äº›å‘½ä»¤ï¼Œå¯ä»¥æŸ¥çœ‹åˆ°Redisç›®å‰çš„å†…å­˜åˆ†é…çŠ¶æ€ï¼š</p><ul><li><code>info memory</code>ï¼šæŸ¥çœ‹å†…å­˜åˆ†é…çš„æƒ…å†µ</li><li><code>memory xxx</code>ï¼šæŸ¥çœ‹keyçš„ä¸»è¦å ç”¨æƒ…å†µ</li></ul><p>çœ‹åˆ°äº†è¿™äº›é…ç½®ï¼Œæœ€å…³é”®çš„ç¼“å­˜åŒºå†…å­˜å¦‚ä½•å®šä½å’Œè§£å†³å‘¢ï¼Ÿ</p><p>å†…å­˜ç¼“å†²åŒºå¸¸è§çš„æœ‰ä¸‰ç§ï¼š</p><ul><li>å¤åˆ¶ç¼“å†²åŒºï¼šä¸»ä»å¤åˆ¶çš„repl_backlog_bufï¼Œå¦‚æœå¤ªå°å¯èƒ½å¯¼è‡´é¢‘ç¹çš„å…¨é‡å¤åˆ¶ï¼Œå½±å“æ€§èƒ½ã€‚é€šè¿‡replbacklog-sizeæ¥è®¾ç½®ï¼Œé»˜è®¤1MB</li><li>AOFç¼“å†²åŒºï¼šAOFåˆ·ç›˜ä¹‹å‰çš„ç¼“å­˜åŒºåŸŸï¼ŒAOFæ‰§è¡Œrewriteçš„ç¼“å†²åŒºã€‚æ— æ³•è®¾ç½®å®¹é‡ä¸Šé™</li><li>å®¢æˆ·ç«¯ç¼“å†²åŒºï¼šåˆ†ä¸ºè¾“å…¥ç¼“å†²åŒºå’Œè¾“å‡ºç¼“å†²åŒºï¼Œè¾“å…¥ç¼“å†²åŒºæœ€å¤§1Gä¸”ä¸èƒ½è®¾ç½®ã€‚è¾“å‡ºç¼“å†²åŒºå¯ä»¥è®¾ç½®</li></ul><p>å¤åˆ¶ç¼“å†²åŒºå’ŒAOFç¼“å†²åŒºä¸ä¼šæœ‰é—®é¢˜ï¼Œæœ€å…³é”®å°±æ˜¯å®¢æˆ·ç«¯ç¼“å†²åŒºçš„é—®é¢˜</p><p>å®¢æˆ·ç«¯ç¼“å†²åŒºï¼šæŒ‡çš„å°±æ˜¯æˆ‘ä»¬å‘é€å‘½ä»¤æ—¶ï¼Œå®¢æˆ·ç«¯ç”¨æ¥ç¼“å­˜å‘½ä»¤çš„ä¸€ä¸ªç¼“å†²åŒºï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å‘redisè¾“å…¥æ•°æ®çš„è¾“å…¥ç«¯ç¼“å†²åŒºå’Œrediså‘å®¢æˆ·ç«¯è¿”å›æ•°æ®çš„å“åº”ç¼“å­˜åŒºï¼Œè¾“å…¥ç¼“å†²åŒºæœ€å¤§1Gä¸”ä¸èƒ½è®¾ç½®ï¼Œæ‰€ä»¥è¿™ä¸€å—æ ¹æœ¬ä¸ç”¨æ‹…å¿ƒï¼Œå¦‚æœè¶…è¿‡äº†è¿™ä¸ªç©ºé—´ï¼Œredisä¼šç›´æ¥æ–­å¼€ï¼Œå› ä¸ºæœ¬æ¥æ­¤æ—¶æ­¤åˆ»å°±ä»£è¡¨ç€rediså¤„ç†ä¸è¿‡æ¥äº†ï¼Œæˆ‘ä»¬éœ€è¦æ‹…å¿ƒçš„å°±æ˜¯è¾“å‡ºç«¯ç¼“å†²åŒº</p><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior06.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>åœ¨ä½¿ç”¨redisè¿‡ç¨‹ä¸­ï¼Œå¤„ç†å¤§é‡çš„big valueï¼Œä¼šå¯¼è‡´è¾“å‡ºç»“æœè¿‡å¤šï¼Œå¦‚æœè¾“å‡ºç¼“å­˜åŒºè¿‡å¤§ï¼Œä¼šå¯¼è‡´redisç›´æ¥æ–­å¼€ï¼Œè€Œé»˜è®¤é…ç½®çš„æƒ…å†µä¸‹æ˜¯æ²¡æœ‰å¤§å°çš„ï¼Œå†…å­˜å¯èƒ½ä¸€ä¸‹å­è¢«å æ»¡ï¼Œä¼šç›´æ¥å¯¼è‡´redisæ–­å¼€ï¼Œè§£å†³æ–¹æ¡ˆæœ‰ä¸¤ä¸ª</p><p>1ã€è®¾ç½®ä¸€ä¸ªå¤§å°</p><p>2ã€å¢åŠ æˆ‘ä»¬å¸¦å®½çš„å¤§å°ï¼Œé¿å…æˆ‘ä»¬å‡ºç°å¤§é‡æ•°æ®ä»è€Œç›´æ¥è¶…è¿‡äº†redisçš„æ‰¿å—èƒ½åŠ›</p><h2 id="å¤šçº§ç¼“å­˜" tabindex="-1"><a class="header-anchor" href="#å¤šçº§ç¼“å­˜"><span>å¤šçº§ç¼“å­˜</span></a></h2><p>ä¼ ç»Ÿçš„ç¼“å­˜ç­–ç•¥ä¸€èˆ¬æ˜¯è¯·æ±‚åˆ°è¾¾Tomcatåï¼Œå…ˆæŸ¥è¯¢Redisï¼Œå¦‚æœæœªå‘½ä¸­åˆ™æŸ¥è¯¢æ•°æ®åº“</p><!--[--><div class="mermaid-actions"><button class="preview-button" title="preview"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1316 1024" fill="currentColor"><path d="M658.286 0C415.89 0 0 297.106 0 512c0 214.82 415.89 512 658.286 512 242.322 0 658.285-294.839 658.285-512S900.608 0 658.286 0zm0 877.714c-161.573 0-512-221.769-512-365.714 0-144.018 350.427-365.714 512-365.714 161.572 0 512 217.16 512 365.714s-350.428 365.714-512 365.714z"/><path d="M658.286 292.571a219.429 219.429 0 1 0 0 438.858 219.429 219.429 0 0 0 0-438.858zm0 292.572a73.143 73.143 0 1 1 0-146.286 73.143 73.143 0 0 1 0 146.286z"/></svg></button><button class="download-button" title="download"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1024 1024" fill="currentColor"><path d="M828.976 894.125H190.189c-70.55 0-127.754-57.185-127.754-127.753V606.674c0-17.634 14.31-31.933 31.933-31.933h63.889c17.634 0 31.932 14.299 31.932 31.933v95.822c0 35.282 28.596 63.877 63.877 63.877h511.033c35.281 0 63.877-28.595 63.877-63.877v-95.822c0-17.634 14.298-31.933 31.943-31.933h63.878c17.635 0 31.933 14.299 31.933 31.933v159.7c0 70.566-57.191 127.751-127.754 127.751zM249.939 267.51c12.921-12.92 33.885-12.92 46.807 0l148.97 148.972V94.893c0-17.634 14.302-31.947 31.934-31.947h63.876c17.638 0 31.946 14.313 31.946 31.947v321.589l148.97-148.972c12.922-12.92 33.876-12.92 46.797 0l46.814 46.818c12.922 12.922 12.922 33.874 0 46.807L552.261 624.93c-1.14 1.138-21.664 13.684-42.315 13.693-20.877.01-41.88-12.542-43.021-13.693L203.122 361.135c-12.923-12.934-12.923-33.885 0-46.807l46.817-46.818z"/></svg></button></div><div class="mermaid-wrapper"><div class="loading-icon-wrapper mermaid-loading" style="display:flex;align-items:center;justify-content:center;height:96px;"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" preserveAspectRatio="xMidYMid" viewBox="25 25 50 50"><animateTransform attributeName="transform" type="rotate" dur="2s" keyTimes="0;1" repeatCount="indefinite" values="0;360"></animateTransform><circle cx="50" cy="50" r="20" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round"><animate attributeName="stroke-dasharray" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="1,200;90,200;1,200"></animate><animate attributeName="stroke-dashoffset" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="0;-35px;-125px"></animate></circle></svg></div></div><!--]--><p>å­˜åœ¨ä¸‹é¢çš„é—®é¢˜ï¼š</p><ul><li><p>è¯·æ±‚è¦ç»è¿‡Tomcatå¤„ç†ï¼ŒTomcatçš„æ€§èƒ½æˆä¸ºæ•´ä¸ªç³»ç»Ÿçš„ç“¶é¢ˆ</p></li><li><p>Redisç¼“å­˜å¤±æ•ˆæ—¶ï¼Œä¼šå¯¹æ•°æ®åº“äº§ç”Ÿå†²å‡»</p></li></ul><p>å¤šçº§ç¼“å­˜å°±æ˜¯å……åˆ†åˆ©ç”¨è¯·æ±‚å¤„ç†çš„æ¯ä¸ªç¯èŠ‚ï¼Œåˆ†åˆ«æ·»åŠ ç¼“å­˜ï¼Œå‡è½»Tomcatå‹åŠ›ï¼Œæå‡æœåŠ¡æ€§èƒ½ï¼š</p><ul><li>æµè§ˆå™¨è®¿é—®é™æ€èµ„æºæ—¶ï¼Œä¼˜å…ˆè¯»å–æµè§ˆå™¨æœ¬åœ°ç¼“å­˜</li><li>è®¿é—®éé™æ€èµ„æºï¼ˆajaxæŸ¥è¯¢æ•°æ®ï¼‰æ—¶ï¼Œè®¿é—®æœåŠ¡ç«¯</li><li>è¯·æ±‚åˆ°è¾¾Nginxåï¼Œä¼˜å…ˆè¯»å–Nginxæœ¬åœ°ç¼“å­˜</li><li>å¦‚æœNginxæœ¬åœ°ç¼“å­˜æœªå‘½ä¸­ï¼Œåˆ™å»ç›´æ¥æŸ¥è¯¢Redisï¼ˆä¸ç»è¿‡Tomcatï¼‰</li><li>å¦‚æœRedisæŸ¥è¯¢æœªå‘½ä¸­ï¼Œåˆ™æŸ¥è¯¢Tomcat</li><li>è¯·æ±‚è¿›å…¥Tomcatåï¼Œä¼˜å…ˆæŸ¥è¯¢JVMè¿›ç¨‹ç¼“å­˜</li><li>å¦‚æœJVMè¿›ç¨‹ç¼“å­˜æœªå‘½ä¸­ï¼Œåˆ™æŸ¥è¯¢æ•°æ®åº“</li></ul><!--[--><div class="mermaid-actions"><button class="preview-button" title="preview"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1316 1024" fill="currentColor"><path d="M658.286 0C415.89 0 0 297.106 0 512c0 214.82 415.89 512 658.286 512 242.322 0 658.285-294.839 658.285-512S900.608 0 658.286 0zm0 877.714c-161.573 0-512-221.769-512-365.714 0-144.018 350.427-365.714 512-365.714 161.572 0 512 217.16 512 365.714s-350.428 365.714-512 365.714z"/><path d="M658.286 292.571a219.429 219.429 0 1 0 0 438.858 219.429 219.429 0 0 0 0-438.858zm0 292.572a73.143 73.143 0 1 1 0-146.286 73.143 73.143 0 0 1 0 146.286z"/></svg></button><button class="download-button" title="download"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1024 1024" fill="currentColor"><path d="M828.976 894.125H190.189c-70.55 0-127.754-57.185-127.754-127.753V606.674c0-17.634 14.31-31.933 31.933-31.933h63.889c17.634 0 31.932 14.299 31.932 31.933v95.822c0 35.282 28.596 63.877 63.877 63.877h511.033c35.281 0 63.877-28.595 63.877-63.877v-95.822c0-17.634 14.298-31.933 31.943-31.933h63.878c17.635 0 31.933 14.299 31.933 31.933v159.7c0 70.566-57.191 127.751-127.754 127.751zM249.939 267.51c12.921-12.92 33.885-12.92 46.807 0l148.97 148.972V94.893c0-17.634 14.302-31.947 31.934-31.947h63.876c17.638 0 31.946 14.313 31.946 31.947v321.589l148.97-148.972c12.922-12.92 33.876-12.92 46.797 0l46.814 46.818c12.922 12.922 12.922 33.874 0 46.807L552.261 624.93c-1.14 1.138-21.664 13.684-42.315 13.693-20.877.01-41.88-12.542-43.021-13.693L203.122 361.135c-12.923-12.934-12.923-33.885 0-46.807l46.817-46.818z"/></svg></button></div><div class="mermaid-wrapper"><div class="loading-icon-wrapper mermaid-loading" style="display:flex;align-items:center;justify-content:center;height:96px;"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" preserveAspectRatio="xMidYMid" viewBox="25 25 50 50"><animateTransform attributeName="transform" type="rotate" dur="2s" keyTimes="0;1" repeatCount="indefinite" values="0;360"></animateTransform><circle cx="50" cy="50" r="20" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round"><animate attributeName="stroke-dasharray" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="1,200;90,200;1,200"></animate><animate attributeName="stroke-dashoffset" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="0;-35px;-125px"></animate></circle></svg></div></div><!--]--><p>åœ¨å¤šçº§ç¼“å­˜æ¶æ„ä¸­ï¼ŒNginxå†…éƒ¨éœ€è¦ç¼–å†™æœ¬åœ°ç¼“å­˜æŸ¥è¯¢ã€RedisæŸ¥è¯¢ã€TomcatæŸ¥è¯¢çš„ä¸šåŠ¡é€»è¾‘ï¼Œå› æ­¤è¿™æ ·çš„nginxæœåŠ¡ä¸å†æ˜¯ä¸€ä¸ª<strong>åå‘ä»£ç†æœåŠ¡å™¨</strong>ï¼Œè€Œæ˜¯ä¸€ä¸ªç¼–å†™<strong>ä¸šåŠ¡çš„WebæœåŠ¡å™¨äº†</strong>ã€‚</p><p>å› æ­¤è¿™æ ·çš„ä¸šåŠ¡NginxæœåŠ¡ä¹Ÿéœ€è¦æ­å»ºé›†ç¾¤æ¥æé«˜å¹¶å‘ï¼Œå†æœ‰ä¸“é—¨çš„nginxæœåŠ¡æ¥åšåå‘ä»£ç†ï¼Œå¦‚å›¾ï¼š</p><!--[--><div class="mermaid-actions"><button class="preview-button" title="preview"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1316 1024" fill="currentColor"><path d="M658.286 0C415.89 0 0 297.106 0 512c0 214.82 415.89 512 658.286 512 242.322 0 658.285-294.839 658.285-512S900.608 0 658.286 0zm0 877.714c-161.573 0-512-221.769-512-365.714 0-144.018 350.427-365.714 512-365.714 161.572 0 512 217.16 512 365.714s-350.428 365.714-512 365.714z"/><path d="M658.286 292.571a219.429 219.429 0 1 0 0 438.858 219.429 219.429 0 0 0 0-438.858zm0 292.572a73.143 73.143 0 1 1 0-146.286 73.143 73.143 0 0 1 0 146.286z"/></svg></button><button class="download-button" title="download"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1024 1024" fill="currentColor"><path d="M828.976 894.125H190.189c-70.55 0-127.754-57.185-127.754-127.753V606.674c0-17.634 14.31-31.933 31.933-31.933h63.889c17.634 0 31.932 14.299 31.932 31.933v95.822c0 35.282 28.596 63.877 63.877 63.877h511.033c35.281 0 63.877-28.595 63.877-63.877v-95.822c0-17.634 14.298-31.933 31.943-31.933h63.878c17.635 0 31.933 14.299 31.933 31.933v159.7c0 70.566-57.191 127.751-127.754 127.751zM249.939 267.51c12.921-12.92 33.885-12.92 46.807 0l148.97 148.972V94.893c0-17.634 14.302-31.947 31.934-31.947h63.876c17.638 0 31.946 14.313 31.946 31.947v321.589l148.97-148.972c12.922-12.92 33.876-12.92 46.797 0l46.814 46.818c12.922 12.922 12.922 33.874 0 46.807L552.261 624.93c-1.14 1.138-21.664 13.684-42.315 13.693-20.877.01-41.88-12.542-43.021-13.693L203.122 361.135c-12.923-12.934-12.923-33.885 0-46.807l46.817-46.818z"/></svg></button></div><div class="mermaid-wrapper"><div class="loading-icon-wrapper mermaid-loading" style="display:flex;align-items:center;justify-content:center;height:96px;"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" preserveAspectRatio="xMidYMid" viewBox="25 25 50 50"><animateTransform attributeName="transform" type="rotate" dur="2s" keyTimes="0;1" repeatCount="indefinite" values="0;360"></animateTransform><circle cx="50" cy="50" r="20" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round"><animate attributeName="stroke-dasharray" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="1,200;90,200;1,200"></animate><animate attributeName="stroke-dashoffset" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="0;-35px;-125px"></animate></circle></svg></div></div><!--]--><p>å¦å¤–ï¼Œæˆ‘ä»¬çš„TomcatæœåŠ¡å°†æ¥ä¹Ÿä¼šéƒ¨ç½²ä¸ºé›†ç¾¤æ¨¡å¼ï¼š</p><!--[--><div class="mermaid-actions"><button class="preview-button" title="preview"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1316 1024" fill="currentColor"><path d="M658.286 0C415.89 0 0 297.106 0 512c0 214.82 415.89 512 658.286 512 242.322 0 658.285-294.839 658.285-512S900.608 0 658.286 0zm0 877.714c-161.573 0-512-221.769-512-365.714 0-144.018 350.427-365.714 512-365.714 161.572 0 512 217.16 512 365.714s-350.428 365.714-512 365.714z"/><path d="M658.286 292.571a219.429 219.429 0 1 0 0 438.858 219.429 219.429 0 0 0 0-438.858zm0 292.572a73.143 73.143 0 1 1 0-146.286 73.143 73.143 0 0 1 0 146.286z"/></svg></button><button class="download-button" title="download"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1024 1024" fill="currentColor"><path d="M828.976 894.125H190.189c-70.55 0-127.754-57.185-127.754-127.753V606.674c0-17.634 14.31-31.933 31.933-31.933h63.889c17.634 0 31.932 14.299 31.932 31.933v95.822c0 35.282 28.596 63.877 63.877 63.877h511.033c35.281 0 63.877-28.595 63.877-63.877v-95.822c0-17.634 14.298-31.933 31.943-31.933h63.878c17.635 0 31.933 14.299 31.933 31.933v159.7c0 70.566-57.191 127.751-127.754 127.751zM249.939 267.51c12.921-12.92 33.885-12.92 46.807 0l148.97 148.972V94.893c0-17.634 14.302-31.947 31.934-31.947h63.876c17.638 0 31.946 14.313 31.946 31.947v321.589l148.97-148.972c12.922-12.92 33.876-12.92 46.797 0l46.814 46.818c12.922 12.922 12.922 33.874 0 46.807L552.261 624.93c-1.14 1.138-21.664 13.684-42.315 13.693-20.877.01-41.88-12.542-43.021-13.693L203.122 361.135c-12.923-12.934-12.923-33.885 0-46.807l46.817-46.818z"/></svg></button></div><div class="mermaid-wrapper"><div class="loading-icon-wrapper mermaid-loading" style="display:flex;align-items:center;justify-content:center;height:96px;"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" preserveAspectRatio="xMidYMid" viewBox="25 25 50 50"><animateTransform attributeName="transform" type="rotate" dur="2s" keyTimes="0;1" repeatCount="indefinite" values="0;360"></animateTransform><circle cx="50" cy="50" r="20" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round"><animate attributeName="stroke-dasharray" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="1,200;90,200;1,200"></animate><animate attributeName="stroke-dashoffset" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="0;-35px;-125px"></animate></circle></svg></div></div><!--]--><p>å¯è§ï¼Œå¤šçº§ç¼“å­˜çš„å…³é”®æœ‰ä¸¤ä¸ªï¼š</p><ul><li><p>ä¸€ä¸ªæ˜¯åœ¨nginxä¸­ç¼–å†™ä¸šåŠ¡ï¼Œå®ç°nginxæœ¬åœ°ç¼“å­˜ã€Redisã€Tomcatçš„æŸ¥è¯¢</p><ul><li>OpenRestyæ¡†æ¶ç»“åˆLuaè¯­è¨€</li></ul></li><li><p>å¦ä¸€ä¸ªå°±æ˜¯åœ¨Tomcatä¸­å®ç°JVMè¿›ç¨‹ç¼“å­˜</p><ul><li>Caffeine</li></ul></li></ul><h2 id="ç¼“å­˜åŒå†™ä¸€è‡´æ€§æ›´æ–°ç­–ç•¥" tabindex="-1"><a class="header-anchor" href="#ç¼“å­˜åŒå†™ä¸€è‡´æ€§æ›´æ–°ç­–ç•¥"><span>ç¼“å­˜åŒå†™ä¸€è‡´æ€§æ›´æ–°ç­–ç•¥</span></a></h2><h3 id="åŒæ­¥ç­–ç•¥" tabindex="-1"><a class="header-anchor" href="#åŒæ­¥ç­–ç•¥"><span>åŒæ­¥ç­–ç•¥</span></a></h3><p>ç¼“å­˜æ•°æ®åŒæ­¥çš„å¸¸è§æ–¹å¼æœ‰ä¸‰ç§ï¼š</p><p><strong>è®¾ç½®æœ‰æ•ˆæœŸ</strong>ï¼šç»™ç¼“å­˜è®¾ç½®æœ‰æ•ˆæœŸï¼Œåˆ°æœŸåè‡ªåŠ¨åˆ é™¤ã€‚å†æ¬¡æŸ¥è¯¢æ—¶æ›´æ–°</p><ul><li>ä¼˜åŠ¿ï¼šç®€å•ã€æ–¹ä¾¿</li><li>ç¼ºç‚¹ï¼šæ—¶æ•ˆæ€§å·®ï¼Œç¼“å­˜è¿‡æœŸä¹‹å‰å¯èƒ½ä¸ä¸€è‡´</li><li>åœºæ™¯ï¼šæ›´æ–°é¢‘ç‡è¾ƒä½ï¼Œæ—¶æ•ˆæ€§è¦æ±‚ä½çš„ä¸šåŠ¡</li></ul><p><strong>åŒæ­¥åŒå†™</strong>ï¼šåœ¨ä¿®æ”¹æ•°æ®åº“çš„åŒæ—¶ï¼Œç›´æ¥ä¿®æ”¹ç¼“å­˜</p><ul><li>ä¼˜åŠ¿ï¼šæ—¶æ•ˆæ€§å¼ºï¼Œç¼“å­˜ä¸æ•°æ®åº“å¼ºä¸€è‡´</li><li>ç¼ºç‚¹ï¼šæœ‰ä»£ç ä¾µå…¥ï¼Œè€¦åˆåº¦é«˜ï¼›</li><li>åœºæ™¯ï¼šå¯¹ä¸€è‡´æ€§ã€æ—¶æ•ˆæ€§è¦æ±‚è¾ƒé«˜çš„ç¼“å­˜æ•°æ®</li></ul><p>**å¼‚æ­¥é€šçŸ¥ï¼š**ä¿®æ”¹æ•°æ®åº“æ—¶å‘é€äº‹ä»¶é€šçŸ¥ï¼Œç›¸å…³æœåŠ¡ç›‘å¬åˆ°é€šçŸ¥åä¿®æ”¹ç¼“å­˜æ•°æ®</p><ul><li>ä¼˜åŠ¿ï¼šä½è€¦åˆï¼Œå¯ä»¥åŒæ—¶é€šçŸ¥å¤šä¸ªç¼“å­˜æœåŠ¡</li><li>ç¼ºç‚¹ï¼šæ—¶æ•ˆæ€§ä¸€èˆ¬ï¼Œå¯èƒ½å­˜åœ¨ä¸­é—´ä¸ä¸€è‡´çŠ¶æ€</li><li>åœºæ™¯ï¼šæ—¶æ•ˆæ€§è¦æ±‚ä¸€èˆ¬ï¼Œæœ‰å¤šä¸ªæœåŠ¡éœ€è¦åŒæ­¥</li></ul><h3 id="åŒæ­¥åŒå†™æ›´æ–°ç­–ç•¥" tabindex="-1"><a class="header-anchor" href="#åŒæ­¥åŒå†™æ›´æ–°ç­–ç•¥"><span>åŒæ­¥åŒå†™æ›´æ–°ç­–ç•¥</span></a></h3><p><strong>å…ˆæ›´æ–°æ•°æ®åº“ååˆ é™¤ç¼“å­˜</strong></p><ul><li>å°è¯•ä½¿ç”¨åŒæ£€åŠ é”æœºåˆ¶lockä½MySQLï¼Œåªè®©ä¸€ä¸ªè¯·æ±‚çº¿ç¨‹å›å†™Redisï¼Œå®Œæˆæ•°æ®ä¸€è‡´æ€§ã€‚</li><li>å½“MySQLæœ‰è®°å½•æ”¹åŠ¨æ—¶ï¼Œè‹¥æƒ³ç«‹åˆ»åŒæ­¥ååº”åˆ°Redisï¼Œå¯ä»¥ä½¿ç”¨Canal ã€ Flink CDCè¿™æ ·çš„æ¡†æ¶ã€‚</li><li>å¯ä»¥æŠŠè¦åˆ é™¤çš„ç¼“å­˜å€¼æˆ–æ˜¯è¦æ›´æ–°çš„æ•°æ®åº“å€¼æš‚å­˜åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œå½“ç¨‹åºæ²¡æœ‰æˆåŠŸåœ°åˆ é™¤ç¼“å­˜æˆ–æ›´æ–°æ•°æ®åº“æ—¶ï¼Œå¯ä»¥ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­é‡æ–°è¯»å–è¿™äº›å€¼ï¼Œç„¶åå†æ¬¡è¿›è¡Œåˆ é™¤æˆ–æ›´æ–°ã€‚</li><li>å¦‚æœä¸šåŠ¡å±‚è¦æ±‚å¿…é¡»è¯»å–ä¸€è‡´æ€§çš„æ•°æ®ï¼Œé‚£å°±éœ€è¦åœ¨æ›´æ–°æ•°æ®åº“æ—¶ï¼Œå…ˆåœ¨Redisç¼“å­˜å®¢æˆ·ç«¯æš‚åœå¹¶å‘è¯»è¯·æ±‚ï¼Œç­‰æ•°æ®åº“æ›´æ–°å®Œã€ç¼“å­˜å€¼åˆ é™¤åï¼Œå†è¯»å–æ•°æ®ï¼Œä»è€Œä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Œè¿™æ˜¯ç†è®ºå¯ä»¥è¾¾åˆ°çš„æ•ˆæœï¼Œä½†å®é™…ä¸æ¨èï¼ŒçœŸå®ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œåˆ†å¸ƒå¼ä¸‹å¾ˆéš¾åšåˆ°å®æ—¶ä¸€è‡´æ€§ï¼Œä¸€èˆ¬éƒ½æ˜¯æœ€ç»ˆä¸€è‡´æ€§ã€‚</li></ul><p><strong>å»¶æ—¶åŒåˆ </strong></p><ul><li>å…ˆåˆ é™¤ç¼“å­˜ï¼Œé¢„ä¼°å…¶å®ƒä¸šåŠ¡çš„ç­‰å¾…æ—¶é—´ï¼Œä¼‘çœ å¯¹åº”çš„æ—¶é—´åå†æ¬¡åˆ é™¤ç¼“å­˜ã€‚å…¶å®ƒçº¿ç¨‹è¯»å–æ•°æ®æ—¶å‘ç°ç¼“å­˜ç¼ºå¤±ï¼Œå°±ä¼šä»æ•°æ®åº“ä¸­è¯»å–æœ€æ–°çš„å€¼äº†ã€‚</li><li>è‹¥æƒ³å›é¿å»¶æ—¶å¸¦æ¥çš„ååé‡é™ä½ï¼Œå¯ä»¥å°†ç¬¬äºŒæ¬¡åˆ é™¤æ”¹æˆå¼‚æ­¥æ“ä½œã€‚</li></ul><h3 id="å¼‚æ­¥é€šçŸ¥æ›´æ–°ç­–ç•¥" tabindex="-1"><a class="header-anchor" href="#å¼‚æ­¥é€šçŸ¥æ›´æ–°ç­–ç•¥"><span>å¼‚æ­¥é€šçŸ¥æ›´æ–°ç­–ç•¥</span></a></h3><ol><li><p>æ¶ˆæ¯é˜Ÿåˆ—</p><!--[--><div class="mermaid-actions"><button class="preview-button" title="preview"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1316 1024" fill="currentColor"><path d="M658.286 0C415.89 0 0 297.106 0 512c0 214.82 415.89 512 658.286 512 242.322 0 658.285-294.839 658.285-512S900.608 0 658.286 0zm0 877.714c-161.573 0-512-221.769-512-365.714 0-144.018 350.427-365.714 512-365.714 161.572 0 512 217.16 512 365.714s-350.428 365.714-512 365.714z"/><path d="M658.286 292.571a219.429 219.429 0 1 0 0 438.858 219.429 219.429 0 0 0 0-438.858zm0 292.572a73.143 73.143 0 1 1 0-146.286 73.143 73.143 0 0 1 0 146.286z"/></svg></button><button class="download-button" title="download"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1024 1024" fill="currentColor"><path d="M828.976 894.125H190.189c-70.55 0-127.754-57.185-127.754-127.753V606.674c0-17.634 14.31-31.933 31.933-31.933h63.889c17.634 0 31.932 14.299 31.932 31.933v95.822c0 35.282 28.596 63.877 63.877 63.877h511.033c35.281 0 63.877-28.595 63.877-63.877v-95.822c0-17.634 14.298-31.933 31.943-31.933h63.878c17.635 0 31.933 14.299 31.933 31.933v159.7c0 70.566-57.191 127.751-127.754 127.751zM249.939 267.51c12.921-12.92 33.885-12.92 46.807 0l148.97 148.972V94.893c0-17.634 14.302-31.947 31.934-31.947h63.876c17.638 0 31.946 14.313 31.946 31.947v321.589l148.97-148.972c12.922-12.92 33.876-12.92 46.797 0l46.814 46.818c12.922 12.922 12.922 33.874 0 46.807L552.261 624.93c-1.14 1.138-21.664 13.684-42.315 13.693-20.877.01-41.88-12.542-43.021-13.693L203.122 361.135c-12.923-12.934-12.923-33.885 0-46.807l46.817-46.818z"/></svg></button></div><div class="mermaid-wrapper"><div class="loading-icon-wrapper mermaid-loading" style="display:flex;align-items:center;justify-content:center;height:96px;"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" preserveAspectRatio="xMidYMid" viewBox="25 25 50 50"><animateTransform attributeName="transform" type="rotate" dur="2s" keyTimes="0;1" repeatCount="indefinite" values="0;360"></animateTransform><circle cx="50" cy="50" r="20" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round"><animate attributeName="stroke-dasharray" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="1,200;90,200;1,200"></animate><animate attributeName="stroke-dashoffset" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="0;-35px;-125px"></animate></circle></svg></div></div><!--]--><ul><li>å•†å“æœåŠ¡å®Œæˆå¯¹æ•°æ®çš„ä¿®æ”¹åï¼Œåªéœ€è¦å‘é€ä¸€æ¡æ¶ˆæ¯åˆ°MQä¸­ã€‚</li><li>ç¼“å­˜æœåŠ¡ç›‘å¬MQæ¶ˆæ¯ï¼Œç„¶åå®Œæˆå¯¹ç¼“å­˜çš„æ›´æ–°</li></ul><p>æœ‰å°‘é‡çš„ä»£ç ä¾µå…¥</p></li><li><p>Canal</p><!--[--><div class="mermaid-actions"><button class="preview-button" title="preview"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1316 1024" fill="currentColor"><path d="M658.286 0C415.89 0 0 297.106 0 512c0 214.82 415.89 512 658.286 512 242.322 0 658.285-294.839 658.285-512S900.608 0 658.286 0zm0 877.714c-161.573 0-512-221.769-512-365.714 0-144.018 350.427-365.714 512-365.714 161.572 0 512 217.16 512 365.714s-350.428 365.714-512 365.714z"/><path d="M658.286 292.571a219.429 219.429 0 1 0 0 438.858 219.429 219.429 0 0 0 0-438.858zm0 292.572a73.143 73.143 0 1 1 0-146.286 73.143 73.143 0 0 1 0 146.286z"/></svg></button><button class="download-button" title="download"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1024 1024" fill="currentColor"><path d="M828.976 894.125H190.189c-70.55 0-127.754-57.185-127.754-127.753V606.674c0-17.634 14.31-31.933 31.933-31.933h63.889c17.634 0 31.932 14.299 31.932 31.933v95.822c0 35.282 28.596 63.877 63.877 63.877h511.033c35.281 0 63.877-28.595 63.877-63.877v-95.822c0-17.634 14.298-31.933 31.943-31.933h63.878c17.635 0 31.933 14.299 31.933 31.933v159.7c0 70.566-57.191 127.751-127.754 127.751zM249.939 267.51c12.921-12.92 33.885-12.92 46.807 0l148.97 148.972V94.893c0-17.634 14.302-31.947 31.934-31.947h63.876c17.638 0 31.946 14.313 31.946 31.947v321.589l148.97-148.972c12.922-12.92 33.876-12.92 46.797 0l46.814 46.818c12.922 12.922 12.922 33.874 0 46.807L552.261 624.93c-1.14 1.138-21.664 13.684-42.315 13.693-20.877.01-41.88-12.542-43.021-13.693L203.122 361.135c-12.923-12.934-12.923-33.885 0-46.807l46.817-46.818z"/></svg></button></div><div class="mermaid-wrapper"><div class="loading-icon-wrapper mermaid-loading" style="display:flex;align-items:center;justify-content:center;height:96px;"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" preserveAspectRatio="xMidYMid" viewBox="25 25 50 50"><animateTransform attributeName="transform" type="rotate" dur="2s" keyTimes="0;1" repeatCount="indefinite" values="0;360"></animateTransform><circle cx="50" cy="50" r="20" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round"><animate attributeName="stroke-dasharray" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="1,200;90,200;1,200"></animate><animate attributeName="stroke-dashoffset" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="0;-35px;-125px"></animate></circle></svg></div></div><!--]--><ul><li>å•†å“æœåŠ¡å®Œæˆå•†å“ä¿®æ”¹åï¼Œä¸šåŠ¡ç›´æ¥ç»“æŸï¼Œæ²¡æœ‰ä»»ä½•ä»£ç ä¾µå…¥</li><li>Canalç›‘å¬MySQLå˜åŒ–ï¼Œå½“å‘ç°å˜åŒ–åï¼Œç«‹å³é€šçŸ¥ç¼“å­˜æœåŠ¡</li><li>ç¼“å­˜æœåŠ¡æ¥æ”¶åˆ°canalé€šçŸ¥ï¼Œæ›´æ–°ç¼“å­˜</li></ul><p>ä»£ç é›¶ä¾µå…¥</p></li><li><p>Flink CDC</p></li></ol><h2 id="hyperloglog" tabindex="-1"><a class="header-anchor" href="#hyperloglog"><span>HyperLogLog</span></a></h2><p>ä¸ºä»€ä¹ˆåªå ç”¨12KBï¼Ÿ</p><p>æ¯ä¸ª HyperLogLog å®ä¾‹å°†è¾“å…¥çš„å“ˆå¸Œå€¼åˆ†å¸ƒåˆ° <strong>16384 ä¸ªå¯„å­˜å™¨</strong>ï¼ˆä¹Ÿç§°ä¸ºæ¡¶æˆ–æ§½ï¼‰ä¸­ï¼Œæ¯ä¸ªå¯„å­˜å™¨å­˜å‚¨æŸä¸ªå“ˆå¸Œå€¼çš„ &quot;å‰å¯¼é›¶&quot; çš„æœ€å¤§é•¿åº¦ã€‚ç”±äº Redis é‡‡ç”¨ 6 ä½æ¥å­˜å‚¨æ¯ä¸ªå¯„å­˜å™¨çš„æœ€å¤§å‰å¯¼é›¶é•¿åº¦ï¼Œå› æ­¤ <strong>16384 ä¸ªå¯„å­˜å™¨</strong> éœ€è¦ï¼š</p><div class="language-txt line-numbers-mode" data-ext="txt" data-title="txt"><pre class="language-txt"><code>16384 (å¯„å­˜å™¨æ•°) Ã— 6 (æ¯ä¸ªå¯„å­˜å™¨å ç”¨çš„ä½) / 8 (æ¯å­—èŠ‚ä½æ•°) = 12288 å­—èŠ‚ = 12 KB
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><hr><p>æ¡ˆä¾‹ï¼šäº¿çº§UVçš„Redisç»Ÿè®¡æ–¹æ¡ˆ</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HyperLogLogService</span>
<span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * æ¨¡æ‹Ÿåå°æœ‰ç”¨æˆ·ç‚¹å‡»é¦–é¡µï¼Œæ¯ä¸ªç”¨æˆ·æ¥è‡ªä¸åŒipåœ°å€
     */</span>
    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;------æ¨¡æ‹Ÿåå°æœ‰ç”¨æˆ·ç‚¹å‡»é¦–é¡µï¼Œæ¯ä¸ªç”¨æˆ·æ¥è‡ªä¸åŒipåœ°å€&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> ip <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span><span class="token number">200</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Random</span> r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                ip <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.&quot;</span> <span class="token operator">+</span> r<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.&quot;</span> <span class="token operator">+</span> r<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.&quot;</span> <span class="token operator">+</span> r<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token class-name">Long</span> hll <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHyperLogLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;hll&quot;</span><span class="token punctuation">,</span> ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;ip={},è¯¥ipåœ°å€è®¿é—®é¦–é¡µçš„æ¬¡æ•°={}&quot;</span><span class="token punctuation">,</span>ip<span class="token punctuation">,</span>hll<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//æš‚åœå‡ ç§’é’Ÿçº¿ç¨‹</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;t1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HyperLogLogController</span>
<span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/uv&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">uv</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">//pfcount</span>
        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHyperLogLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token string">&quot;hll&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="geo" tabindex="-1"><a class="header-anchor" href="#geo"><span>GEO</span></a></h2><p>æ¡ˆä¾‹ä»£ç </p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GeoService</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">CITY</span> <span class="token operator">=</span><span class="token string">&quot;city&quot;</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">geoAdd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Point</span><span class="token punctuation">&gt;</span></span> map<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;å¤©å®‰é—¨&quot;</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span><span class="token number">116.403963</span><span class="token punctuation">,</span><span class="token number">39.915119</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;æ•…å®«&quot;</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span><span class="token number">116.403414</span> <span class="token punctuation">,</span><span class="token number">39.924091</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;é•¿åŸ&quot;</span> <span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span><span class="token number">116.024067</span><span class="token punctuation">,</span><span class="token number">40.362639</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForGeo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token constant">CITY</span><span class="token punctuation">,</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> map<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Point</span> <span class="token function">position</span><span class="token punctuation">(</span><span class="token class-name">String</span> member<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//è·å–ç»çº¬åº¦åæ ‡</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Point</span><span class="token punctuation">&gt;</span></span> list<span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>redisTemplate<span class="token punctuation">.</span><span class="token function">opsForGeo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token constant">CITY</span><span class="token punctuation">,</span>member<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">hash</span><span class="token punctuation">(</span><span class="token class-name">String</span> member<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//geohashç®—æ³•ç”Ÿæˆçš„base32ç¼–ç å€¼</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list<span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>redisTemplate<span class="token punctuation">.</span><span class="token function">opsForGeo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token constant">CITY</span><span class="token punctuation">,</span>member<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token class-name">Distance</span> <span class="token function">distance</span><span class="token punctuation">(</span><span class="token class-name">String</span> member1<span class="token punctuation">,</span> <span class="token class-name">String</span> member2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//è·å–ä¸¤ä¸ªç»™å®šä½ç½®ä¹‹é—´çš„è·ç¦»</span>
        <span class="token class-name">Distance</span> distance<span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>redisTemplate<span class="token punctuation">.</span><span class="token function">opsForGeo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">distance</span><span class="token punctuation">(</span><span class="token constant">CITY</span><span class="token punctuation">,</span>member1<span class="token punctuation">,</span>member2<span class="token punctuation">,</span> <span class="token class-name">RedisGeoCommands<span class="token punctuation">.</span>DistanceUnit</span><span class="token punctuation">.</span><span class="token constant">KILOMETERS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> distance<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">GeoResults</span> <span class="token function">radiusByxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//é€šè¿‡ç»åº¦ï¼Œçº¬åº¦æŸ¥æ‰¾é™„è¿‘çš„,åŒ—äº¬ç‹åºœäº•ä½ç½®116.418017,39.914402</span>
        <span class="token class-name">Circle</span> circle <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Circle</span><span class="token punctuation">(</span><span class="token number">116.418017</span><span class="token punctuation">,</span> <span class="token number">39.914402</span><span class="token punctuation">,</span> <span class="token class-name">Metrics</span><span class="token punctuation">.</span><span class="token constant">KILOMETERS</span><span class="token punctuation">.</span><span class="token function">getMultiplier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//è¿”å›50æ¡</span>
        <span class="token class-name">RedisGeoCommands<span class="token punctuation">.</span>GeoRadiusCommandArgs</span> args <span class="token operator">=</span> <span class="token class-name">RedisGeoCommands<span class="token punctuation">.</span>GeoRadiusCommandArgs</span><span class="token punctuation">.</span><span class="token function">newGeoRadiusArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">includeDistance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">includeCoordinates</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sortAscending</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">GeoResults</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RedisGeoCommands<span class="token punctuation">.</span>GeoLocation</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> geoResults<span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>redisTemplate<span class="token punctuation">.</span><span class="token function">opsForGeo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">radius</span><span class="token punctuation">(</span><span class="token constant">CITY</span><span class="token punctuation">,</span>circle<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> geoResults<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">GeoResults</span> <span class="token function">radiusByMember</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//é€šè¿‡åœ°æ–¹æŸ¥æ‰¾é™„è¿‘</span>
        <span class="token class-name">String</span> member<span class="token operator">=</span><span class="token string">&quot;å¤©å®‰é—¨&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">//è¿”å›50æ¡</span>
        <span class="token class-name">RedisGeoCommands<span class="token punctuation">.</span>GeoRadiusCommandArgs</span> args <span class="token operator">=</span> <span class="token class-name">RedisGeoCommands<span class="token punctuation">.</span>GeoRadiusCommandArgs</span><span class="token punctuation">.</span><span class="token function">newGeoRadiusArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">includeDistance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">includeCoordinates</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sortAscending</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//åŠå¾„10å…¬é‡Œå†…</span>
        <span class="token class-name">Distance</span> distance<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Distance</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">Metrics</span><span class="token punctuation">.</span><span class="token constant">KILOMETERS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">GeoResults</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RedisGeoCommands<span class="token punctuation">.</span>GeoLocation</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> geoResults<span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>redisTemplate<span class="token punctuation">.</span><span class="token function">opsForGeo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">radius</span><span class="token punctuation">(</span><span class="token constant">CITY</span><span class="token punctuation">,</span>member<span class="token punctuation">,</span> distance<span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> geoResults<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Api</span><span class="token punctuation">(</span>tags <span class="token operator">=</span> <span class="token string">&quot;ç¾å›¢åœ°å›¾ä½ç½®é™„è¿‘çš„é…’åº—æ¨é€GEO&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GeoController</span>
<span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">GeoService</span> geoService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;æ·»åŠ åæ ‡geoadd&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/geoadd&quot;</span><span class="token punctuation">,</span>method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">geoAdd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> geoService<span class="token punctuation">.</span><span class="token function">geoAdd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;è·å–ç»çº¬åº¦åæ ‡geopos&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/geopos&quot;</span><span class="token punctuation">,</span>method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Point</span> <span class="token function">position</span><span class="token punctuation">(</span><span class="token class-name">String</span> member<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> geoService<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span>member<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;è·å–ç»çº¬åº¦ç”Ÿæˆçš„base32ç¼–ç å€¼geohash&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/geohash&quot;</span><span class="token punctuation">,</span>method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">hash</span><span class="token punctuation">(</span><span class="token class-name">String</span> member<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> geoService<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span>member<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;è·å–ä¸¤ä¸ªç»™å®šä½ç½®ä¹‹é—´çš„è·ç¦»&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/geodist&quot;</span><span class="token punctuation">,</span>method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Distance</span> <span class="token function">distance</span><span class="token punctuation">(</span><span class="token class-name">String</span> member1<span class="token punctuation">,</span> <span class="token class-name">String</span> member2<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> geoService<span class="token punctuation">.</span><span class="token function">distance</span><span class="token punctuation">(</span>member1<span class="token punctuation">,</span>member2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;é€šè¿‡ç»åº¦çº¬åº¦æŸ¥æ‰¾åŒ—äº¬ç‹åºœäº•é™„è¿‘çš„&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/georadius&quot;</span><span class="token punctuation">,</span>method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">GeoResults</span> <span class="token function">radiusByxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> geoService<span class="token punctuation">.</span><span class="token function">radiusByxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;é€šè¿‡åœ°æ–¹æŸ¥æ‰¾é™„è¿‘,æœ¬ä¾‹å†™æ­»å¤©å®‰é—¨ä½œä¸ºåœ°å€&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/georadiusByMember&quot;</span><span class="token punctuation">,</span>method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">GeoResults</span> <span class="token function">radiusByMember</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> geoService<span class="token punctuation">.</span><span class="token function">radiusByMember</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="å¸ƒéš†è¿‡æ»¤å™¨" tabindex="-1"><a class="header-anchor" href="#å¸ƒéš†è¿‡æ»¤å™¨"><span>å¸ƒéš†è¿‡æ»¤å™¨</span></a></h2><p>å¸ƒéš†è¿‡æ»¤å™¨(Bloom Filter) æ˜¯ä¸€ç§ä¸“é—¨ç”¨æ¥è§£å†³å»é‡é—®é¢˜çš„é«˜çº§æ•°æ®ç»“æ„ã€‚</p><p>å®è´¨å°±æ˜¯ä¸€ä¸ªå¤§å‹ä½æ•°ç»„å’Œå‡ ä¸ªä¸åŒçš„æ— åhashå‡½æ•°(æ— åè¡¨ç¤ºåˆ†å¸ƒå‡åŒ€)ã€‚ç”±ä¸€ä¸ªåˆå€¼éƒ½ä¸ºé›¶çš„bitæ•°ç»„å’Œå¤šä¸ªå“ˆå¸Œå‡½æ•°æ„æˆï¼Œç”¨æ¥å¿«é€Ÿåˆ¤æ–­æŸä¸ªæ•°æ®æ˜¯å¦å­˜åœ¨ã€‚ä½†æ˜¯è·Ÿ HyperLogLog ä¸€æ ·ï¼Œå®ƒä¹Ÿä¸€æ ·æœ‰é‚£ä¹ˆä¸€ç‚¹ç‚¹ä¸ç²¾ç¡®ï¼Œä¹Ÿå­˜åœ¨ä¸€å®šçš„è¯¯åˆ¤æ¦‚ç‡</p><p><strong>ç‰¹ç‚¹</strong></p><ul><li>ä¸èƒ½åˆ é™¤å…ƒç´ ï¼šæ ‡å‡†å¸ƒéš†è¿‡æ»¤å™¨ä¸æ”¯æŒåˆ é™¤æ“ä½œï¼Œå› ä¸ºåˆ é™¤æ“ä½œå¯èƒ½ä¼šå½±å“å…¶ä»–å…ƒç´ çš„æŸ¥è¯¢ç»“æœã€‚</li><li>åˆ¤å®šå…ƒç´ æ˜¯å¦å­˜åœ¨æ—¶ï¼šå­˜åœ¨ä»£è¡¨å¤§æ¦‚ç‡å­˜åœ¨ï¼›ä¸å­˜åœ¨ä»£è¡¨ä¸€å®šä¸å­˜åœ¨ã€‚</li></ul><p><strong>åŸç†</strong></p><ul><li>æ·»åŠ keyæ—¶ï¼šä½¿ç”¨å¤šä¸ªhashå‡½æ•°å¯¹keyè¿›è¡Œhashè¿ç®—å¾—åˆ°ä¸€ä¸ªæ•´æ•°ç´¢å¼•å€¼ï¼Œå¯¹ä½æ•°ç»„é•¿åº¦è¿›è¡Œå–æ¨¡è¿ç®—å¾—åˆ°ä¸€ä¸ªä½ç½®ï¼Œæ¯ä¸ªhashå‡½æ•°éƒ½ä¼šå¾—åˆ°ä¸€ä¸ªä¸åŒçš„ä½ç½®ï¼Œå°†è¿™å‡ ä¸ªä½ç½®éƒ½ç½®1å°±å®Œæˆäº†addæ“ä½œã€‚</li><li>æŸ¥è¯¢keyæ—¶ï¼šåªè¦æœ‰å…¶ä¸­ä¸€ä½æ˜¯é›¶å°±è¡¨ç¤ºè¿™ä¸ªkeyä¸å­˜åœ¨ï¼Œä½†å¦‚æœéƒ½æ˜¯1ï¼Œåˆ™ä¸ä¸€å®šå­˜åœ¨å¯¹åº”çš„keyã€‚</li></ul><p><strong>æ¡ˆä¾‹</strong></p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BloomFilterInit</span>
<span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostConstruct</span><span class="token comment">//åˆå§‹åŒ–ç™½åå•æ•°æ®ï¼Œæ•…æ„å·®å¼‚åŒ–æ•°æ®æ¼”ç¤ºæ•ˆæœ......</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">//ç™½åå•å®¢æˆ·é¢„åŠ è½½åˆ°å¸ƒéš†è¿‡æ»¤å™¨</span>
        <span class="token class-name">String</span> uid <span class="token operator">=</span> <span class="token string">&quot;customer:12&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">//1 è®¡ç®—hashcodeï¼Œç”±äºå¯èƒ½æœ‰è´Ÿæ•°ï¼Œç›´æ¥å–ç»å¯¹å€¼</span>
        <span class="token keyword">int</span> hashValue <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>uid<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//2 é€šè¿‡hashValueå’Œ2çš„32æ¬¡æ–¹å–ä½™åï¼Œè·å¾—å¯¹åº”çš„ä¸‹æ ‡å‘ä½</span>
        <span class="token keyword">long</span> index <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>hashValue <span class="token operator">%</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>uid<span class="token operator">+</span><span class="token string">&quot; å¯¹åº”------å‘ä½index:{}&quot;</span><span class="token punctuation">,</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3 è®¾ç½®redisé‡Œé¢bitmapå¯¹åº”å‘ä½ï¼Œè¯¥æœ‰å€¼è®¾ç½®ä¸º1</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setBit</span><span class="token punctuation">(</span><span class="token string">&quot;whitelistCustomer&quot;</span><span class="token punctuation">,</span>index<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CheckUtils</span>
<span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">checkWithBloomFilter</span><span class="token punctuation">(</span><span class="token class-name">String</span> checkItem<span class="token punctuation">,</span><span class="token class-name">String</span> key<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">int</span> hashValue <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> index <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>hashValue <span class="token operator">%</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> existOK <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBit</span><span class="token punctuation">(</span>checkItem<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;-----&gt;key:&quot;</span><span class="token operator">+</span>key<span class="token operator">+</span><span class="token string">&quot;\tå¯¹åº”å‘ä½index:&quot;</span><span class="token operator">+</span>index<span class="token operator">+</span><span class="token string">&quot;\tæ˜¯å¦å­˜åœ¨:&quot;</span><span class="token operator">+</span>existOK<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> existOK<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomerSerivce</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">CACHE_KEY_CUSTOMER</span> <span class="token operator">=</span> <span class="token string">&quot;customer:&quot;</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">CustomerMapper</span> customerMapper<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">CheckUtils</span> checkUtils<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addCustomer</span><span class="token punctuation">(</span><span class="token class-name">Customer</span> customer<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> customerMapper<span class="token punctuation">.</span><span class="token function">insertSelective</span><span class="token punctuation">(</span>customer<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>i <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">//åˆ°æ•°æ®åº“é‡Œé¢ï¼Œé‡æ–°æå‡ºæ–°æ•°æ®å‡ºæ¥ï¼Œåšç¼“å­˜</span>
            customer<span class="token operator">=</span>customerMapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span>customer<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//ç¼“å­˜key</span>
            <span class="token class-name">String</span> key<span class="token operator">=</span><span class="token constant">CACHE_KEY_CUSTOMER</span><span class="token operator">+</span>customer<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//å¾€mysqlé‡Œé¢æ’å…¥æˆåŠŸéšåå†ä»mysqlæŸ¥è¯¢å‡ºæ¥ï¼Œå†æ’å…¥redis</span>
            redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>customer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Customer</span> <span class="token function">findCustomerById</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> customerId<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Customer</span> customer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token comment">//ç¼“å­˜keyçš„åç§°</span>
        <span class="token class-name">String</span> key<span class="token operator">=</span><span class="token constant">CACHE_KEY_CUSTOMER</span><span class="token operator">+</span>customerId<span class="token punctuation">;</span>

        <span class="token comment">//1 æŸ¥è¯¢redis</span>
        customer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Customer</span><span class="token punctuation">)</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//redisæ— ï¼Œè¿›ä¸€æ­¥æŸ¥è¯¢mysql</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>customer<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">//2 ä»mysqlæŸ¥å‡ºæ¥customer</span>
            customer<span class="token operator">=</span>customerMapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span>customerId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// mysqlæœ‰ï¼Œredisæ— </span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>customer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//3 æŠŠmysqlæåˆ°çš„æ•°æ®å†™å…¥redisï¼Œæ–¹ä¾¿ä¸‹æ¬¡æŸ¥è¯¢èƒ½rediså‘½ä¸­ã€‚</span>
                redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>customer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> customer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * BloomFilter â†’ redis â†’ mysql
     * ç™½åå•ï¼šwhitelistCustomer
     * <span class="token keyword">@param</span> <span class="token parameter">customerId</span>
     * <span class="token keyword">@return</span>
     */</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">CheckUtils</span> checkUtils<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">Customer</span> findCustomerByIdWithBloomFilter <span class="token punctuation">(</span><span class="token class-name">Integer</span> customerId<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">Customer</span> customer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token comment">//ç¼“å­˜keyçš„åç§°</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token constant">CACHE_KEY_CUSTOMER</span> <span class="token operator">+</span> customerId<span class="token punctuation">;</span>

        <span class="token comment">//å¸ƒéš†è¿‡æ»¤å™¨checkï¼Œæ— æ˜¯ç»å¯¹æ— ï¼Œæœ‰æ˜¯å¯èƒ½æœ‰</span>
        <span class="token comment">//===============================================</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>checkUtils<span class="token punctuation">.</span><span class="token function">checkWithBloomFilter</span><span class="token punctuation">(</span><span class="token string">&quot;whitelistCustomer&quot;</span><span class="token punctuation">,</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;ç™½åå•æ— æ­¤é¡¾å®¢ä¿¡æ¯:{}&quot;</span><span class="token punctuation">,</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//===============================================</span>

        <span class="token comment">//1 æŸ¥è¯¢redis</span>
        customer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Customer</span><span class="token punctuation">)</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//redisæ— ï¼Œè¿›ä¸€æ­¥æŸ¥è¯¢mysql</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>customer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//2 ä»mysqlæŸ¥å‡ºæ¥customer</span>
            customer <span class="token operator">=</span> customerMapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span>customerId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// mysqlæœ‰ï¼Œredisæ— </span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>customer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//3 æŠŠmysqlæåˆ°çš„æ•°æ®å†™å…¥redisï¼Œæ–¹ä¾¿ä¸‹æ¬¡æŸ¥è¯¢èƒ½rediså‘½ä¸­ã€‚</span>
                redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> customer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> customer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Api</span><span class="token punctuation">(</span>tags <span class="token operator">=</span> <span class="token string">&quot;å®¢æˆ·Customeræ¥å£+å¸ƒéš†è¿‡æ»¤å™¨è®²è§£&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomerController</span>
<span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Resource</span> <span class="token keyword">private</span> <span class="token class-name">CustomerSerivce</span> customerSerivce<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;æ•°æ®åº“åˆå§‹åŒ–2æ¡Customeræ•°æ®&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/customer/add&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addCustomer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Customer</span> customer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Customer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            customer<span class="token punctuation">.</span><span class="token function">setCname</span><span class="token punctuation">(</span><span class="token string">&quot;customer&quot;</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            customer<span class="token punctuation">.</span><span class="token function">setAge</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            customer<span class="token punctuation">.</span><span class="token function">setPhone</span><span class="token punctuation">(</span><span class="token string">&quot;1381111xxxx&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            customer<span class="token punctuation">.</span><span class="token function">setSex</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            customer<span class="token punctuation">.</span><span class="token function">setBirth</span><span class="token punctuation">(</span><span class="token class-name">Date</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">atZone</span><span class="token punctuation">(</span><span class="token class-name">ZoneId</span><span class="token punctuation">.</span><span class="token function">systemDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toInstant</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            customerSerivce<span class="token punctuation">.</span><span class="token function">addCustomer</span><span class="token punctuation">(</span>customer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;å•ä¸ªç”¨æˆ·æŸ¥è¯¢ï¼ŒæŒ‰customeridæŸ¥ç”¨æˆ·ä¿¡æ¯&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/customer/{id}&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Customer</span> <span class="token function">findCustomerById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> customerSerivce<span class="token punctuation">.</span><span class="token function">findCustomerById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;BloomFilteræ¡ˆä¾‹è®²è§£&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/customerbloomfilter/{id}&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Customer</span> <span class="token function">findCustomerByIdWithBloomFilter</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> customerSerivce<span class="token punctuation">.</span><span class="token function">findCustomerByIdWithBloomFilter</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å¸ƒè°·é¸Ÿè¿‡æ»¤å™¨</strong></p><p>èƒ½å¤Ÿè§£å†³å¸ƒéš†è¿‡æ»¤å™¨ä¸èƒ½åˆ é™¤å…ƒç´ çš„é—®é¢˜ï¼Œä½†æˆç†Ÿåº¦å’Œä½¿ç”¨ç‡ä¸å¦‚å¸ƒéš†è¿‡æ»¤å™¨</p><h2 id="ç¼“å­˜é¢„çƒ­ã€ç©¿é€ã€å‡»ç©¿ã€é›ªå´©" tabindex="-1"><a class="header-anchor" href="#ç¼“å­˜é¢„çƒ­ã€ç©¿é€ã€å‡»ç©¿ã€é›ªå´©"><span>ç¼“å­˜é¢„çƒ­ã€ç©¿é€ã€å‡»ç©¿ã€é›ªå´©</span></a></h2><h3 id="ç¼“å­˜é¢„çƒ­" tabindex="-1"><a class="header-anchor" href="#ç¼“å­˜é¢„çƒ­"><span>ç¼“å­˜é¢„çƒ­</span></a></h3><p>å¯¹äºçƒ­ç‚¹keyï¼Œäº‹å…ˆåœ¨<code>@postconstrct</code>ä¸­åˆå§‹åŒ–ç™½åå•æ•°æ®</p><h3 id="ç¼“å­˜é›ªå´©" tabindex="-1"><a class="header-anchor" href="#ç¼“å­˜é›ªå´©"><span>ç¼“å­˜é›ªå´©</span></a></h3><p>ç¼“å­˜é›ªå´©æ˜¯æŒ‡åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå½“å¤§é‡ç¼“å­˜åŒæ—¶è¿‡æœŸæˆ–å¤±æ•ˆï¼Œå¯¼è‡´å¤§é‡è¯·æ±‚ç›´æ¥è®¿é—®åç«¯æ•°æ®åº“ï¼Œä»è€Œå¼•å‘æ•°æ®åº“è´Ÿè½½éª¤å¢ï¼Œå¯èƒ½é€ æˆç³»ç»Ÿå´©æºƒçš„ç°è±¡ã€‚</p><p><strong>é¢„é˜²/è§£å†³</strong></p><ol><li>å°†keyè®¾ç½®ä¸ºæ°¸ä¸è¿‡æœŸã€éšæœºçš„è¿‡æœŸæ—¶é—´</li><li>ç¼“å­˜é›†ç¾¤å®ç°é«˜å¯ç”¨ <ul><li>ä¸»ä»+å“¨å…µ</li><li>Redis Cluster</li><li>å¼€å¯AOFã€RDBï¼Œå°½å¿«æ¢å¤ç¼“å­˜é›†ç¾¤</li></ul></li><li>åŒé‡ç¼“å­˜ <ul><li>ehcacheæœ¬åœ°ç¼“å­˜</li><li>Redisç¼“å­˜</li></ul></li><li>æœåŠ¡é™æµã€é™çº§ <ul><li>Hystrix</li><li>Sentinel</li></ul></li><li>è´­ä¹°Redisäº‘æ•°æ®åº“</li></ol><h3 id="ç¼“å­˜ç©¿é€" tabindex="-1"><a class="header-anchor" href="#ç¼“å­˜ç©¿é€"><span>ç¼“å­˜ç©¿é€</span></a></h3><p>å®šä¹‰ï¼šæŸ¥è¯¢çš„æ•°æ®ä¸å­˜åœ¨äºRedisï¼Œä¹Ÿä¸å­˜åœ¨äºMySQLï¼Œé¢‘ç¹çš„æ­¤ç±»æŸ¥è¯¢ä¼šå¯¼è‡´æ•°æ®åº“å‹åŠ›è¿‡å¤§è€Œå®•æœºã€‚</p><p><strong>è§£å†³æ–¹æ¡ˆ</strong></p><ol><li>ç¼“å­˜ç©ºå¯¹è±¡</li><li>Googleçš„å¸ƒéš†è¿‡æ»¤å™¨Guava</li></ol><!--[--><div class="mermaid-actions"><button class="preview-button" title="preview"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1316 1024" fill="currentColor"><path d="M658.286 0C415.89 0 0 297.106 0 512c0 214.82 415.89 512 658.286 512 242.322 0 658.285-294.839 658.285-512S900.608 0 658.286 0zm0 877.714c-161.573 0-512-221.769-512-365.714 0-144.018 350.427-365.714 512-365.714 161.572 0 512 217.16 512 365.714s-350.428 365.714-512 365.714z"/><path d="M658.286 292.571a219.429 219.429 0 1 0 0 438.858 219.429 219.429 0 0 0 0-438.858zm0 292.572a73.143 73.143 0 1 1 0-146.286 73.143 73.143 0 0 1 0 146.286z"/></svg></button><button class="download-button" title="download"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1024 1024" fill="currentColor"><path d="M828.976 894.125H190.189c-70.55 0-127.754-57.185-127.754-127.753V606.674c0-17.634 14.31-31.933 31.933-31.933h63.889c17.634 0 31.932 14.299 31.932 31.933v95.822c0 35.282 28.596 63.877 63.877 63.877h511.033c35.281 0 63.877-28.595 63.877-63.877v-95.822c0-17.634 14.298-31.933 31.943-31.933h63.878c17.635 0 31.933 14.299 31.933 31.933v159.7c0 70.566-57.191 127.751-127.754 127.751zM249.939 267.51c12.921-12.92 33.885-12.92 46.807 0l148.97 148.972V94.893c0-17.634 14.302-31.947 31.934-31.947h63.876c17.638 0 31.946 14.313 31.946 31.947v321.589l148.97-148.972c12.922-12.92 33.876-12.92 46.797 0l46.814 46.818c12.922 12.922 12.922 33.874 0 46.807L552.261 624.93c-1.14 1.138-21.664 13.684-42.315 13.693-20.877.01-41.88-12.542-43.021-13.693L203.122 361.135c-12.923-12.934-12.923-33.885 0-46.807l46.817-46.818z"/></svg></button></div><div class="mermaid-wrapper"><div class="loading-icon-wrapper mermaid-loading" style="display:flex;align-items:center;justify-content:center;height:96px;"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" preserveAspectRatio="xMidYMid" viewBox="25 25 50 50"><animateTransform attributeName="transform" type="rotate" dur="2s" keyTimes="0;1" repeatCount="indefinite" values="0;360"></animateTransform><circle cx="50" cy="50" r="20" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round"><animate attributeName="stroke-dasharray" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="1,200;90,200;1,200"></animate><animate attributeName="stroke-dashoffset" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="0;-35px;-125px"></animate></circle></svg></div></div><!--]--><h3 id="ç¼“å­˜å‡»ç©¿" tabindex="-1"><a class="header-anchor" href="#ç¼“å­˜å‡»ç©¿"><span>ç¼“å­˜å‡»ç©¿</span></a></h3><p>å®šä¹‰ï¼šå¤§é‡çš„è¯·æ±‚åŒæ—¶æŸ¥è¯¢æŸä¸ªkeyï¼Œæ­¤æ—¶è¿™ä¸ªkeyçªç„¶å¤±æ•ˆï¼Œå¯¼è‡´å¤§é‡è¯·æ±‚æ‰“åˆ°æ•°æ®åº“ä¸Šã€‚</p><p>è§£å†³æ–¹æ¡ˆ</p><ol><li>çƒ­ç‚¹keyä¸è®¾ç½®è¿‡æœŸæ—¶é—´</li><li>é‡‡ç”¨åŒæ£€åŠ é”äº’æ–¥æ›´æ–°</li><li>é€»è¾‘è¿‡æœŸå¼‚æ­¥æ›´æ–°æ•°æ®</li></ol><h2 id="åˆ†å¸ƒå¼é”" tabindex="-1"><a class="header-anchor" href="#åˆ†å¸ƒå¼é”"><span>åˆ†å¸ƒå¼é”</span></a></h2><p><strong>ç‰¹æ€§</strong></p><ul><li>ç‹¬å æ€§ï¼šä»»ä½•æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æŒæœ‰</li><li>é«˜å¯ç”¨ï¼šé›†ç¾¤ç¯å¢ƒä¸‹ï¼Œä¸èƒ½å› ä¸ºæŸä¸ªèŠ‚ç‚¹å®•æœºè€Œå‡ºç°è·å–é”/é‡Šæ”¾é”å¤±è´¥çš„æƒ…å†µ</li><li>é˜²æ­»é”ï¼šæœ‰è¶…æ—¶æ§åˆ¶æœºåˆ¶æˆ–æ’¤é”€æ“ä½œï¼Œæœ‰ä¸€ä¸ªå…œåº•çš„è·³å‡ºæ–¹æ¡ˆ</li><li>ä¸ä¹±æŠ¢ï¼šè‡ªå·±çš„é”åªèƒ½è‡ªå·±é‡Šæ”¾ï¼ŒAçº¿ç¨‹ä¸èƒ½ unlock Bçº¿ç¨‹çš„é”</li><li>é‡å…¥æ€§ï¼šåŒä¸€ä¸ªèŠ‚ç‚¹çš„åŒä¸€ä¸ªçº¿ç¨‹è·å¾—é”ä¹‹åï¼Œèƒ½å¤Ÿå†æ¬¡è·å–è¿™ä¸ªé”</li></ul><p><strong>è‡ªå®šä¹‰å®ç°</strong></p><div class="language-JAVA line-numbers-mode" data-ext="JAVA" data-title="JAVA"><pre class="language-JAVA"><code>@Component
public class DistributedLockFactory
{
    @Autowired
    private StringRedisTemplate stringRedisTemplate;
    private String lockName;
    private String uuidValue;

    public DistributedLockFactory()
    {
        this.uuidValue = IdUtil.simpleUUID();//UUID
    }

    public Lock getDistributedLock(String lockType)
    {
        if(lockType == null) return null;

        if(lockType.equalsIgnoreCase(&quot;REDIS&quot;)){
            lockName = &quot;zzyyRedisLock&quot;;
            return new RedisDistributedLock(stringRedisTemplate,lockName,uuidValue);
        } else if(lockType.equalsIgnoreCase(&quot;ZOOKEEPER&quot;)){
            //TODO zookeeperç‰ˆæœ¬çš„åˆ†å¸ƒå¼é”å®ç°
            return new ZookeeperDistributedLock();
        } else if(lockType.equalsIgnoreCase(&quot;MYSQL&quot;)){
            //TODO mysqlç‰ˆæœ¬çš„åˆ†å¸ƒå¼é”å®ç°
            return null;
        }
        return null;
    }
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-JAVA line-numbers-mode" data-ext="JAVA" data-title="JAVA"><pre class="language-JAVA"><code>public class RedisDistributedLock implements java.util.concurrent.locks.Lock {
    private final StringRedisTemplate stringRedisTemplate;
    private final String lockName; // KEYS[1]
    private final String uuidValue; // ARGV[1]
    private long expireTime; // ARGV[2] in seconds

    private ScheduledExecutorService scheduler;

    public RedisDistributedLock(StringRedisTemplate stringRedisTemplate, String lockName, String uuidValue) {
        this.stringRedisTemplate = stringRedisTemplate;
        this.lockName = lockName;
        this.uuidValue = uuidValue + &quot;:&quot; + Thread.currentThread().getId();
        this.expireTime = 30L;
        this.scheduler = new ScheduledThreadPoolExecutor(1);
    }

    @Override
    public void lock() {
        tryLock(-1L, TimeUnit.SECONDS);
    }

    @Override
    public boolean tryLock() {
        try {
            return tryLock(-1L, TimeUnit.SECONDS);
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
            return false;
        }
    }

    @Override
    public boolean tryLock(long time, TimeUnit unit) throws InterruptedException {
        if (time != -1L) {
            this.expireTime = unit.toSeconds(time);
        }

        String script =
                &quot;if redis.call(&#39;exists&#39;, KEYS[1]) == 0 or redis.call(&#39;hexists&#39;, KEYS[1], ARGV[1]) == 1 then &quot; +
                        &quot;redis.call(&#39;hincrby&#39;, KEYS[1], ARGV[1], 1) &quot; +
                        &quot;redis.call(&#39;expire&#39;, KEYS[1], ARGV[2]) &quot; +
                        &quot;return 1 &quot; +
                        &quot;else &quot; +
                        &quot;return 0 &quot; +
                        &quot;end&quot;;

        while (!stringRedisTemplate.execute(new DefaultRedisScript&lt;&gt;(script, Boolean.class), Arrays.asList(lockName), uuidValue, String.valueOf(expireTime))) {
            TimeUnit.MILLISECONDS.sleep(50);
        }
        renewExpire();
        return true;
    }

    @Override
    public void unlock() {
        String script =
                &quot;if redis.call(&#39;hexists&#39;, KEYS[1], ARGV[1]) == 0 then &quot; +
                        &quot;return nil &quot; +
                        &quot;elseif redis.call(&#39;hincrby&#39;, KEYS[1], ARGV[1], -1) == 0 then &quot; +
                        &quot;return redis.call(&#39;del&#39;, KEYS[1]) &quot; +
                        &quot;else &quot; +
                        &quot;return 0 &quot; +
                        &quot;end&quot;;

        Long flag = stringRedisTemplate.execute(new DefaultRedisScript&lt;&gt;(script, Long.class), Arrays.asList(lockName), uuidValue, String.valueOf(expireTime));
        if (flag == null) {
            throw new RuntimeException(&quot;This lock doesn&#39;t EXIST&quot;);
        }
        if (scheduler != null) {
            scheduler.shutdownNow();
        }
    }

    private void renewExpire() {
        String script =
                &quot;if redis.call(&#39;hexists&#39;, KEYS[1], ARGV[1]) == 1 then &quot; +
                        &quot;return redis.call(&#39;expire&#39;, KEYS[1], ARGV[2]) &quot; +
                        &quot;else &quot; +
                        &quot;return 0 &quot; +
                        &quot;end&quot;;

        scheduler.scheduleAtFixedRate(() -&gt; {
            if (stringRedisTemplate.execute(new DefaultRedisScript&lt;&gt;(script, Boolean.class), Arrays.asList(lockName), uuidValue, String.valueOf(expireTime))) {
                renewExpire();
            }
        }, (this.expireTime * 1000) / 3, (this.expireTime * 1000) / 3, TimeUnit.MILLISECONDS);
    }

    @Override
    public void lockInterruptibly() throws InterruptedException {
        try {
            if (!tryLock(-1L, TimeUnit.SECONDS)) {
                throw new InterruptedException();
            }
        } catch (InterruptedException e) {
            throw e;
        }
    }

    @Override
    public Condition newCondition() {
        throw new UnsupportedOperationException(&quot;Distributed locks do not support conditions&quot;);
    }
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-JAVA line-numbers-mode" data-ext="JAVA" data-title="JAVA"><pre class="language-JAVA"><code>@Service
@Slf4j
public class InventoryService
{
    @Autowired
    private StringRedisTemplate stringRedisTemplate;
    @Value(&quot;${server.port}&quot;)
    private String port;
    @Autowired
    private DistributedLockFactory distributedLockFactory;

    public String sale()
    {
        String retMessage = &quot;&quot;;
        Lock redisLock = distributedLockFactory.getDistributedLock(&quot;redis&quot;);
        redisLock.lock();
        try
        {
            //1 æŸ¥è¯¢åº“å­˜ä¿¡æ¯
            String result = stringRedisTemplate.opsForValue().get(&quot;inventory001&quot;);
            //2 åˆ¤æ–­åº“å­˜æ˜¯å¦è¶³å¤Ÿ
            Integer inventoryNumber = result == null ? 0 : Integer.parseInt(result);
            //3 æ‰£å‡åº“å­˜
            if(inventoryNumber &gt; 0) {
                stringRedisTemplate.opsForValue().set(&quot;inventory001&quot;,String.valueOf(--inventoryNumber));
                retMessage = &quot;æˆåŠŸå–å‡ºä¸€ä¸ªå•†å“ï¼Œåº“å­˜å‰©ä½™: &quot;+inventoryNumber;
                System.out.println(retMessage);
                //æš‚åœå‡ ç§’é’Ÿçº¿ç¨‹,ä¸ºäº†æµ‹è¯•è‡ªåŠ¨ç»­æœŸ
                try { TimeUnit.SECONDS.sleep(120); } catch (InterruptedException e) { e.printStackTrace(); }
            }else{
                retMessage = &quot;å•†å“å–å®Œäº†ï¼Œo(â•¥ï¹â•¥)o&quot;;
            }
        }catch (Exception e){
            e.printStackTrace();
        }finally {
            redisLock.unlock();
        }
        return retMessage+&quot;\t&quot;+&quot;æœåŠ¡ç«¯å£å·ï¼š&quot;+port;
    }


    private void testReEnter()
    {
        Lock redisLock = distributedLockFactory.getDistributedLock(&quot;redis&quot;);
        redisLock.lock();
        try
        {
            System.out.println(&quot;################æµ‹è¯•å¯é‡å…¥é”####################################&quot;);
        }finally {
            redisLock.unlock();
        }
    }
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="çº¢é”" tabindex="-1"><a class="header-anchor" href="#çº¢é”"><span>çº¢é”</span></a></h3><p><strong>äº§ç”ŸèƒŒæ™¯</strong></p><!--[--><div class="mermaid-actions"><button class="preview-button" title="preview"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1316 1024" fill="currentColor"><path d="M658.286 0C415.89 0 0 297.106 0 512c0 214.82 415.89 512 658.286 512 242.322 0 658.285-294.839 658.285-512S900.608 0 658.286 0zm0 877.714c-161.573 0-512-221.769-512-365.714 0-144.018 350.427-365.714 512-365.714 161.572 0 512 217.16 512 365.714s-350.428 365.714-512 365.714z"/><path d="M658.286 292.571a219.429 219.429 0 1 0 0 438.858 219.429 219.429 0 0 0 0-438.858zm0 292.572a73.143 73.143 0 1 1 0-146.286 73.143 73.143 0 0 1 0 146.286z"/></svg></button><button class="download-button" title="download"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1024 1024" fill="currentColor"><path d="M828.976 894.125H190.189c-70.55 0-127.754-57.185-127.754-127.753V606.674c0-17.634 14.31-31.933 31.933-31.933h63.889c17.634 0 31.932 14.299 31.932 31.933v95.822c0 35.282 28.596 63.877 63.877 63.877h511.033c35.281 0 63.877-28.595 63.877-63.877v-95.822c0-17.634 14.298-31.933 31.943-31.933h63.878c17.635 0 31.933 14.299 31.933 31.933v159.7c0 70.566-57.191 127.751-127.754 127.751zM249.939 267.51c12.921-12.92 33.885-12.92 46.807 0l148.97 148.972V94.893c0-17.634 14.302-31.947 31.934-31.947h63.876c17.638 0 31.946 14.313 31.946 31.947v321.589l148.97-148.972c12.922-12.92 33.876-12.92 46.797 0l46.814 46.818c12.922 12.922 12.922 33.874 0 46.807L552.261 624.93c-1.14 1.138-21.664 13.684-42.315 13.693-20.877.01-41.88-12.542-43.021-13.693L203.122 361.135c-12.923-12.934-12.923-33.885 0-46.807l46.817-46.818z"/></svg></button></div><div class="mermaid-wrapper"><div class="loading-icon-wrapper mermaid-loading" style="display:flex;align-items:center;justify-content:center;height:96px;"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" preserveAspectRatio="xMidYMid" viewBox="25 25 50 50"><animateTransform attributeName="transform" type="rotate" dur="2s" keyTimes="0;1" repeatCount="indefinite" values="0;360"></animateTransform><circle cx="50" cy="50" r="20" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round"><animate attributeName="stroke-dasharray" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="1,200;90,200;1,200"></animate><animate attributeName="stroke-dashoffset" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="0;-35px;-125px"></animate></circle></svg></div></div><!--]--><ol><li>å®¢æˆ·Aé€šè¿‡Redisçš„setå‘½ä»¤æˆåŠŸå»ºç«‹åˆ†å¸ƒå¼é”å¹¶æŒæœ‰é”</li><li>æ­£å¸¸æƒ…å†µä¸‹ä¸»ä»æœºéƒ½æœ‰åˆ†å¸ƒå¼é”</li><li>çªç„¶å‡ºç°æ•…éšœï¼Œä½†Masterè¿˜æ²¡æ¥å¾—åŠåŒæ­¥æ•°æ®ç»™Slaveï¼Œæ­¤æ—¶Slaveæœºå™¨ä¸Šæ²¡æœ‰å¯¹åº”çš„é”ä¿¡æ¯</li><li>ä»æœºSlaveä¸Šä½ï¼Œå˜æˆæ–°çš„Masterä¸»æœº</li><li>å®¢æˆ·Bå»ºé”æˆåŠŸï¼Œæ­¤æ—¶å‡ºç°äº†ï¼šä¸¤ä¸ªçº¿ç¨‹è·å–åˆ°äº†é”ï¼Œå¯èƒ½ä¼šå¯¼è‡´å„ç§æ„å¤–æƒ…å†µå‘ç”Ÿï¼Œä¾‹å¦‚è„è¯»</li></ol><blockquote><p>CAPå®šç†çš„CPé­åˆ°äº†ç ´åï¼Œå¹¶ä¸”Redisæ— è®ºå•æœºã€ä¸»ä»ã€å“¨å…µå‡æœ‰æ­¤é£é™©</p></blockquote><p>Redlockç®—æ³•ï¼Œç”¨æ¥å®ç°<strong>åŸºäºå¤šä¸ªå®ä¾‹çš„</strong>åˆ†å¸ƒå¼é”ã€‚</p><p>é”å˜é‡ç”±å¤šä¸ªå®ä¾‹ç»´æŠ¤ï¼Œå³ä½¿æœ‰å®ä¾‹å‘ç”Ÿäº†æ•…éšœï¼Œé”å˜é‡ä»ç„¶æ˜¯å­˜åœ¨çš„ï¼Œå®¢æˆ·ç«¯è¿˜æ˜¯å¯ä»¥å®Œæˆé”æ“ä½œã€‚</p><p>è¯¥æ–¹æ¡ˆåŸºäºï¼ˆset åŠ é”ã€Lua è„šæœ¬è§£é”ï¼‰è¿›è¡Œæ”¹è‰¯ï¼Œå¤§è‡´æ–¹æ¡ˆå¦‚ä¸‹ï¼š</p><p>å‡è®¾æˆ‘ä»¬æœ‰Nä¸ªRedisä¸»èŠ‚ç‚¹ï¼Œä¾‹å¦‚ N = 5ï¼Œè¿™äº›èŠ‚ç‚¹æ˜¯å®Œå…¨ç‹¬ç«‹çš„ï¼Œä¸ä½¿ç”¨å¤åˆ¶æˆ–ä»»ä½•å…¶ä»–éšå¼åè°ƒç³»ç»Ÿï¼Œä¸ºäº†å–åˆ°é”ï¼Œå®¢æˆ·ç«¯æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p><ol><li>è·å–å½“å‰æ—¶é—´ï¼Œä»¥æ¯«ç§’ä¸ºå•ä½</li><li>ä¾æ¬¡å°è¯•ä»5ä¸ªå®ä¾‹ï¼Œä½¿ç”¨ç›¸åŒçš„ key å’Œéšæœºå€¼ï¼ˆä¾‹å¦‚ UUIDï¼‰è·å–é”ã€‚å½“å‘Redis è¯·æ±‚è·å–é”æ—¶ï¼Œå®¢æˆ·ç«¯åº”è¯¥è®¾ç½®ä¸€ä¸ªè¶…æ—¶æ—¶é—´ï¼Œè¿™ä¸ªè¶…æ—¶æ—¶é—´åº”è¯¥å°äºé”çš„å¤±æ•ˆæ—¶é—´ã€‚ä¾‹å¦‚ä½ çš„é”è‡ªåŠ¨å¤±æ•ˆæ—¶é—´ä¸º 10 ç§’ï¼Œåˆ™è¶…æ—¶æ—¶é—´åº”è¯¥åœ¨ 5-50 æ¯«ç§’ä¹‹é—´ã€‚è¿™æ ·å¯ä»¥é˜²æ­¢å®¢æˆ·ç«¯åœ¨è¯•å›¾ä¸ä¸€ä¸ªå®•æœºçš„ Redis èŠ‚ç‚¹å¯¹è¯æ—¶é•¿æ—¶é—´å¤„äºé˜»å¡çŠ¶æ€ã€‚å¦‚æœä¸€ä¸ªå®ä¾‹ä¸å¯ç”¨ï¼Œå®¢æˆ·ç«¯åº”è¯¥å°½å¿«å°è¯•å»å¦å¤–ä¸€ä¸ª Redis å®ä¾‹è¯·æ±‚è·å–é”ï¼›</li><li>å®¢æˆ·ç«¯é€šè¿‡å½“å‰æ—¶é—´å‡å»æ­¥éª¤ 1 è®°å½•çš„æ—¶é—´æ¥è®¡ç®—è·å–é”ä½¿ç”¨çš„æ—¶é—´ã€‚å½“ä¸”ä»…å½“ä»å¤§å¤šæ•°ï¼ˆN/2+1ï¼Œè¿™é‡Œæ˜¯ 3 ä¸ªèŠ‚ç‚¹ï¼‰çš„ Redis èŠ‚ç‚¹éƒ½å–åˆ°é”ï¼Œå¹¶ä¸”è·å–é”ä½¿ç”¨çš„æ—¶é—´å°äºé”å¤±æ•ˆæ—¶é—´æ—¶ï¼Œé”æ‰ç®—è·å–æˆåŠŸï¼›</li><li>å¦‚æœå–åˆ°äº†é”ï¼Œå…¶çœŸæ­£æœ‰æ•ˆæ—¶é—´ç­‰äºåˆå§‹æœ‰æ•ˆæ—¶é—´å‡å»è·å–é”æ‰€ä½¿ç”¨çš„æ—¶é—´ï¼ˆæ­¥éª¤ 3 è®¡ç®—çš„ç»“æœï¼‰ã€‚</li><li>å¦‚æœç”±äºæŸäº›åŸå› æœªèƒ½è·å¾—é”ï¼ˆæ— æ³•åœ¨è‡³å°‘ N/2 + 1 ä¸ª Redis å®ä¾‹è·å–é”ã€æˆ–è·å–é”çš„æ—¶é—´è¶…è¿‡äº†æœ‰æ•ˆæ—¶é—´ï¼‰ï¼Œå®¢æˆ·ç«¯åº”è¯¥åœ¨æ‰€æœ‰çš„ Redis å®ä¾‹ä¸Šè¿›è¡Œè§£é”ï¼ˆå³ä¾¿æŸäº›Rediså®ä¾‹æ ¹æœ¬å°±æ²¡æœ‰åŠ é”æˆåŠŸï¼Œé˜²æ­¢æŸäº›èŠ‚ç‚¹è·å–åˆ°é”ä½†æ˜¯å®¢æˆ·ç«¯æ²¡æœ‰å¾—åˆ°å“åº”è€Œå¯¼è‡´æ¥ä¸‹æ¥çš„ä¸€æ®µæ—¶é—´ä¸èƒ½è¢«é‡æ–°è·å–é”ï¼‰ã€‚</li></ol><blockquote><p>è¯¥æ–¹æ¡ˆä¸ºäº†è§£å†³æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œç›´æ¥èˆå¼ƒäº†å¼‚æ­¥å¤åˆ¶åªä½¿ç”¨ master èŠ‚ç‚¹ï¼ŒåŒæ—¶ç”±äºèˆå¼ƒäº†slaveï¼Œä¸ºäº†ä¿è¯å¯ç”¨æ€§ï¼Œå¼•å…¥äº†Nä¸ªèŠ‚ç‚¹ï¼Œå®˜æ–¹å»ºè®®æ˜¯ 5</p></blockquote><p><strong>watch_dogè‡ªåŠ¨å»¶æœŸæœºåˆ¶</strong></p><p>å®¢æˆ·ç«¯AåŠ é”æˆåŠŸï¼Œå°±ä¼šå¯åŠ¨ä¸€ä¸ªwatch dogçœ‹é—¨ç‹—ï¼Œä»–æ˜¯ä¸€ä¸ªåå°çº¿ç¨‹ï¼Œä¼šæ¯éš”10ç§’æ£€æŸ¥ä¸€ä¸‹ï¼Œå¦‚æœå®¢æˆ·ç«¯Aè¿˜æŒæœ‰é”keyï¼Œé‚£ä¹ˆå°±ä¼šä¸æ–­çš„å»¶é•¿é”keyçš„ç”Ÿå­˜æ—¶é—´ï¼Œé»˜è®¤æ¯æ¬¡ç»­å‘½åˆä»30ç§’æ–°å¼€å§‹</p><h3 id="redission" tabindex="-1"><a class="header-anchor" href="#redission"><span>Redission</span></a></h3><p><strong>å¿«é€Ÿä¸Šæ‰‹</strong></p><div class="language-xml line-numbers-mode" data-ext="xml" data-title="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.redisson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>redisson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.13.4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisConfig</span>
<span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">redisTemplate</span><span class="token punctuation">(</span><span class="token class-name">LettuceConnectionFactory</span> lettuceConnectionFactory<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> redisTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">setConnectionFactory</span><span class="token punctuation">(</span>lettuceConnectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//è®¾ç½®keyåºåˆ—åŒ–æ–¹å¼string</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">setKeySerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//è®¾ç½®valueçš„åºåˆ—åŒ–æ–¹å¼json</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">setValueSerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GenericJackson2JsonRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        redisTemplate<span class="token punctuation">.</span><span class="token function">setHashKeySerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">setHashValueSerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GenericJackson2JsonRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        redisTemplate<span class="token punctuation">.</span><span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//å•RedisèŠ‚ç‚¹æ¨¡å¼</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Redisson</span> <span class="token function">redisson</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">Config</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        config<span class="token punctuation">.</span><span class="token function">useSingleServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span><span class="token string">&quot;redis://192.168.111.175:6379&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setDatabase</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">&quot;111111&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">Redisson</span><span class="token punctuation">)</span> <span class="token class-name">Redisson</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@Api</span><span class="token punctuation">(</span>tags <span class="token operator">=</span> <span class="token string">&quot;redisåˆ†å¸ƒå¼é”æµ‹è¯•&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InventoryController</span>
<span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">InventoryService</span> inventoryService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;æ‰£å‡åº“å­˜ï¼Œä¸€æ¬¡å–ä¸€ä¸ª&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/inventory/sale&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">sale</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> inventoryService<span class="token punctuation">.</span><span class="token function">sale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;æ‰£å‡åº“å­˜saleByRedissonï¼Œä¸€æ¬¡å–ä¸€ä¸ª&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/inventory/saleByRedisson&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">saleByRedisson</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> inventoryService<span class="token punctuation">.</span><span class="token function">saleByRedisson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InventoryService</span>
<span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${server.port}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> port<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">DistributedLockFactory</span> distributedLockFactory<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">Redisson</span> redisson<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">saleByRedisson</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">String</span> retMessage <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token string">&quot;zzyyRedisLock&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">RLock</span> redissonLock <span class="token operator">=</span> redisson<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        redissonLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span>
        <span class="token punctuation">{</span>
            <span class="token comment">//1 æŸ¥è¯¢åº“å­˜ä¿¡æ¯</span>
            <span class="token class-name">String</span> result <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;inventory001&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//2 åˆ¤æ–­åº“å­˜æ˜¯å¦è¶³å¤Ÿ</span>
            <span class="token class-name">Integer</span> inventoryNumber <span class="token operator">=</span> result <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//3 æ‰£å‡åº“å­˜</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>inventoryNumber <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;inventory001&quot;</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token operator">--</span>inventoryNumber<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                retMessage <span class="token operator">=</span> <span class="token string">&quot;æˆåŠŸå–å‡ºä¸€ä¸ªå•†å“ï¼Œåº“å­˜å‰©ä½™: &quot;</span><span class="token operator">+</span>inventoryNumber<span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>retMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                retMessage <span class="token operator">=</span> <span class="token string">&quot;å•†å“å–å®Œäº†ï¼Œo(â•¥ï¹â•¥)o&quot;</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>redissonLock<span class="token punctuation">.</span><span class="token function">isLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> redissonLock<span class="token punctuation">.</span><span class="token function">isHeldByCurrentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                redissonLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> retMessage<span class="token operator">+</span><span class="token string">&quot;\t&quot;</span><span class="token operator">+</span><span class="token string">&quot;æœåŠ¡ç«¯å£å·ï¼š&quot;</span><span class="token operator">+</span>port<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å¤šæœºæ¡ˆä¾‹</strong></p><div class="language-properties line-numbers-mode" data-ext="properties" data-title="properties"><pre class="language-properties"><code><span class="token key attr-name">spring.redis.database</span><span class="token punctuation">=</span><span class="token value attr-value">0</span>
<span class="token key attr-name">spring.redis.password</span><span class="token punctuation">=</span>
<span class="token key attr-name">spring.redis.timeout</span><span class="token punctuation">=</span><span class="token value attr-value">3000</span>
<span class="token key attr-name">spring.redis.mode</span><span class="token punctuation">=</span><span class="token value attr-value">single</span>

<span class="token key attr-name">spring.redis.pool.conn-timeout</span><span class="token punctuation">=</span><span class="token value attr-value">3000</span>
<span class="token key attr-name">spring.redis.pool.so-timeout</span><span class="token punctuation">=</span><span class="token value attr-value">3000</span>
<span class="token key attr-name">spring.redis.pool.size</span><span class="token punctuation">=</span><span class="token value attr-value">10</span>

<span class="token key attr-name">spring.redis.single.address1</span><span class="token punctuation">=</span><span class="token value attr-value">192.168.111.185:6381</span>
<span class="token key attr-name">spring.redis.single.address2</span><span class="token punctuation">=</span><span class="token value attr-value">192.168.111.185:6382</span>
<span class="token key attr-name">spring.redis.single.address3</span><span class="token punctuation">=</span><span class="token value attr-value">192.168.111.185:6383</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableConfigurationProperties</span><span class="token punctuation">(</span><span class="token class-name">RedisProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CacheConfiguration</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">RedisProperties</span> redisProperties<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token class-name">RedissonClient</span> <span class="token function">redissonClient1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Config</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> node <span class="token operator">=</span> redisProperties<span class="token punctuation">.</span><span class="token function">getSingle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAddress1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        node <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;redis://&quot;</span><span class="token punctuation">)</span> <span class="token operator">?</span> node <span class="token operator">:</span> <span class="token string">&quot;redis://&quot;</span> <span class="token operator">+</span> node<span class="token punctuation">;</span>
        <span class="token class-name">SingleServerConfig</span> serverConfig <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">useSingleServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setTimeout</span><span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConnTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setConnectionPoolSize</span><span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setConnectionMinimumIdleSize</span><span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMinIdle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            serverConfig<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">Redisson</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token class-name">RedissonClient</span> <span class="token function">redissonClient2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Config</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> node <span class="token operator">=</span> redisProperties<span class="token punctuation">.</span><span class="token function">getSingle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAddress2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        node <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;redis://&quot;</span><span class="token punctuation">)</span> <span class="token operator">?</span> node <span class="token operator">:</span> <span class="token string">&quot;redis://&quot;</span> <span class="token operator">+</span> node<span class="token punctuation">;</span>
        <span class="token class-name">SingleServerConfig</span> serverConfig <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">useSingleServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setTimeout</span><span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConnTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setConnectionPoolSize</span><span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setConnectionMinimumIdleSize</span><span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMinIdle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            serverConfig<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">Redisson</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token class-name">RedissonClient</span> <span class="token function">redissonClient3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Config</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> node <span class="token operator">=</span> redisProperties<span class="token punctuation">.</span><span class="token function">getSingle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAddress3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        node <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;redis://&quot;</span><span class="token punctuation">)</span> <span class="token operator">?</span> node <span class="token operator">:</span> <span class="token string">&quot;redis://&quot;</span> <span class="token operator">+</span> node<span class="token punctuation">;</span>
        <span class="token class-name">SingleServerConfig</span> serverConfig <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">useSingleServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setTimeout</span><span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConnTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setConnectionPoolSize</span><span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setConnectionMinimumIdleSize</span><span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMinIdle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            serverConfig<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">Redisson</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token doc-comment comment">/**
     * å•æœº
     */</span>
    <span class="token comment">/*@Bean
    public Redisson redisson()
    {
        Config config = new Config();

        config.useSingleServer().setAddress(&quot;redis://192.168.111.147:6379&quot;).setDatabase(0);

        return (Redisson) Redisson.create(config);
    }*/</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisPoolProperties</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> maxIdle<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> minIdle<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> maxActive<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> maxWait<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> connTimeout<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> soTimeout<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * æ± å¤§å°
     */</span>
    <span class="token keyword">private</span>  <span class="token keyword">int</span> size<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">&quot;spring.redis&quot;</span><span class="token punctuation">,</span> ignoreUnknownFields <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisProperties</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> database<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * ç­‰å¾…èŠ‚ç‚¹å›å¤å‘½ä»¤çš„æ—¶é—´ã€‚è¯¥æ—¶é—´ä»å‘½ä»¤å‘é€æˆåŠŸæ—¶å¼€å§‹è®¡æ—¶
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> timeout<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> mode<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * æ± é…ç½®
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisPoolProperties</span> pool<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * å•æœºä¿¡æ¯é…ç½®
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisSingleProperties</span> single<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisSingleProperties</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span>  <span class="token class-name">String</span> address1<span class="token punctuation">;</span>
    <span class="token keyword">private</span>  <span class="token class-name">String</span> address2<span class="token punctuation">;</span>
    <span class="token keyword">private</span>  <span class="token class-name">String</span> address3<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedLockController</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">CACHE_KEY_REDLOCK</span> <span class="token operator">=</span> <span class="token string">&quot;ATGUIGU_REDLOCK&quot;</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">RedissonClient</span> redissonClient1<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">RedissonClient</span> redissonClient2<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">RedissonClient</span> redissonClient3<span class="token punctuation">;</span>

    <span class="token keyword">boolean</span> isLockBoolean<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/multiLock&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getMultiLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">String</span> uuid <span class="token operator">=</span>  <span class="token class-name">IdUtil</span><span class="token punctuation">.</span><span class="token function">simpleUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> uuidValue <span class="token operator">=</span> uuid<span class="token operator">+</span><span class="token string">&quot;:&quot;</span><span class="token operator">+</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">RLock</span> lock1 <span class="token operator">=</span> redissonClient1<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token constant">CACHE_KEY_REDLOCK</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RLock</span> lock2 <span class="token operator">=</span> redissonClient2<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token constant">CACHE_KEY_REDLOCK</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RLock</span> lock3 <span class="token operator">=</span> redissonClient3<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token constant">CACHE_KEY_REDLOCK</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">RedissonMultiLock</span> redLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedissonMultiLock</span><span class="token punctuation">(</span>lock1<span class="token punctuation">,</span> lock2<span class="token punctuation">,</span> lock3<span class="token punctuation">)</span><span class="token punctuation">;</span>
        redLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span>
        <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>uuidValue<span class="token operator">+</span><span class="token string">&quot;\t&quot;</span><span class="token operator">+</span><span class="token string">&quot;---come in biz multiLock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>uuidValue<span class="token operator">+</span><span class="token string">&quot;\t&quot;</span><span class="token operator">+</span><span class="token string">&quot;---task is over multiLock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;multiLock exception &quot;</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            redLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;é‡Šæ”¾åˆ†å¸ƒå¼é”æˆåŠŸkey:{}&quot;</span><span class="token punctuation">,</span> <span class="token constant">CACHE_KEY_REDLOCK</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token string">&quot;multiLock task is over  &quot;</span><span class="token operator">+</span>uuidValue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ç¼“å­˜è¿‡æœŸæ·˜æ±°ç­–ç•¥" tabindex="-1"><a class="header-anchor" href="#ç¼“å­˜è¿‡æœŸæ·˜æ±°ç­–ç•¥"><span>ç¼“å­˜è¿‡æœŸæ·˜æ±°ç­–ç•¥</span></a></h2><h3 id="é»˜è®¤å†…å­˜é…ç½®" tabindex="-1"><a class="header-anchor" href="#é»˜è®¤å†…å­˜é…ç½®"><span>é»˜è®¤å†…å­˜é…ç½®</span></a></h3><p>æŸ¥çœ‹Rediså†…å­˜ä½¿ç”¨æƒ…å†µ</p><ul><li><code>info memory</code></li><li><code>config get memory</code></li></ul><p>ä¿®æ”¹é»˜è®¤å†…å­˜å¤§å°ï¼š</p><ul><li>æ‰“å¼€Redisé…ç½®æ–‡ä»¶ï¼Œè®¾ç½®maxmemoryå‚æ•°ï¼Œå•ä½æ˜¯å­—èŠ‚ï¼Œï¼ˆ64ä½æ“ä½œç³»ç»Ÿä¸‹ï¼Œè®¾ç½®0ä»£è¡¨æ— ä¸Šé™ï¼‰è®¾ç½®æ¨èä¸ºç‰©ç†æœºçš„3/4</li><li>ä½¿ç”¨å‘½ä»¤ï¼š<code>config set maxmemory 1234</code>(è¯¥æ–¹å¼å•æ¬¡ç”Ÿæ•ˆï¼Œé‡å¯åå¤±æ•ˆ)</li></ul><p>æ•°æ®ä¸è®¾ç½®è¿‡æœŸæ—¶é—´ä¼šå¾ˆå¿«å¯¼è‡´OOMï¼Œæ•°æ®å†™æ»¡åä¼šè§¦å‘å†…å­˜æ·˜æ±°ã€‚</p><h3 id="è¿‡æœŸé”®çš„åˆ é™¤ç­–ç•¥" tabindex="-1"><a class="header-anchor" href="#è¿‡æœŸé”®çš„åˆ é™¤ç­–ç•¥"><span>è¿‡æœŸé”®çš„åˆ é™¤ç­–ç•¥</span></a></h3><h4 id="ç«‹å³åˆ é™¤" tabindex="-1"><a class="header-anchor" href="#ç«‹å³åˆ é™¤"><span>ç«‹å³åˆ é™¤</span></a></h4><p>ç«‹å³åˆ é™¤èƒ½ä¿è¯å†…å­˜ä¸­æ•°æ®çš„æœ€å¤§æ–°é²œåº¦ï¼Œå› ä¸ºå®ƒä¿è¯è¿‡æœŸé”®å€¼ä¼šåœ¨è¿‡æœŸåé©¬ä¸Šè¢«åˆ é™¤ï¼Œå…¶æ‰€å ç”¨çš„å†…å­˜ä¹Ÿä¼šéšä¹‹é‡Šæ”¾ã€‚ä½†æ˜¯ç«‹å³åˆ é™¤å¯¹cpuæ˜¯æœ€ä¸å‹å¥½çš„ã€‚å› ä¸ºåˆ é™¤æ“ä½œä¼šå ç”¨cpuçš„æ—¶é—´ï¼Œå¦‚æœåˆšå¥½ç¢°ä¸Šäº†cpuå¾ˆå¿™çš„æ—¶å€™ï¼Œå°±ä¼šç»™cpué€ æˆé¢å¤–çš„å‹åŠ›ã€‚è¿™ä¼šäº§ç”Ÿå¤§é‡çš„æ€§èƒ½æ¶ˆè€—ï¼ŒåŒæ—¶ä¹Ÿä¼šå½±å“æ•°æ®çš„è¯»å–æ“ä½œã€‚</p><p>æ€»ç»“ï¼šå¯¹CPUä¸å‹å¥½ï¼Œç”¨å¤„ç†å™¨æ€§èƒ½æ¢å–å­˜å‚¨ç©ºé—´ï¼ˆ<strong>æ—¶é—´æ¢ç©ºé—´</strong>ï¼‰</p><h4 id="æƒ°æ€§åˆ é™¤" tabindex="-1"><a class="header-anchor" href="#æƒ°æ€§åˆ é™¤"><span>æƒ°æ€§åˆ é™¤</span></a></h4><p>æ•°æ®åˆ°è¾¾è¿‡æœŸæ—¶é—´ï¼Œä¸åšå¤„ç†ã€‚ç­‰ä¸‹æ¬¡è®¿é—®è¯¥æ•°æ®æ—¶</p><ul><li><p>å¦‚æœæœªè¿‡æœŸï¼Œè¿”å›æ•°æ®</p></li><li><p>å‘ç°å·²è¿‡æœŸï¼Œåˆ é™¤ï¼Œè¿”å›ä¸å­˜åœ¨</p></li></ul><p>æƒ°æ€§åˆ é™¤ç­–ç•¥çš„ç¼ºç‚¹æ˜¯ï¼Œå®ƒå¯¹å†…å­˜æ˜¯æœ€ä¸å‹å¥½çš„ã€‚</p><p>å¦‚æœä¸€ä¸ªé”®å·²ç»è¿‡æœŸï¼Œè€Œè¿™ä¸ªé”®åˆä»ç„¶ä¿ç•™åœ¨redisä¸­ï¼Œé‚£ä¹ˆåªè¦è¿™ä¸ªè¿‡æœŸé”®ä¸è¢«åˆ é™¤ï¼Œå®ƒæ‰€å ç”¨çš„å†…å­˜å°±ä¸ä¼šé‡Šæ”¾ã€‚</p><p>åœ¨ä½¿ç”¨æƒ°æ€§åˆ é™¤ç­–ç•¥æ—¶ï¼Œå¦‚æœæ•°æ®åº“ä¸­æœ‰éå¸¸å¤šçš„è¿‡æœŸé”®ï¼Œè€Œè¿™äº›è¿‡æœŸé”®åˆæ°å¥½æ²¡æœ‰è¢«è®¿é—®åˆ°çš„è¯ï¼Œé‚£ä¹ˆå®ƒä»¬ä¹Ÿè®¸æ°¸è¿œä¹Ÿä¸ä¼šè¢«åˆ é™¤(é™¤éç”¨æˆ·æ‰‹åŠ¨æ‰§è¡Œ<code>FLUSHDB</code>)ï¼Œæˆ‘ä»¬ç”šè‡³å¯ä»¥å°†è¿™ç§æƒ…å†µçœ‹ä½œæ˜¯ä¸€ç§å†…å­˜æ³„æ¼â€“æ— ç”¨çš„åƒåœ¾æ•°æ®å ç”¨äº†å¤§é‡çš„å†…å­˜ï¼Œè€ŒæœåŠ¡å™¨å´ä¸ä¼šè‡ªå·±å»é‡Šæ”¾å®ƒä»¬ï¼Œè¿™å¯¹äºè¿è¡ŒçŠ¶æ€éå¸¸ä¾èµ–äºå†…å­˜çš„RedisæœåŠ¡å™¨æ¥è¯´,è‚¯å®šä¸æ˜¯ä¸€ä¸ªå¥½æ¶ˆæ¯</p><p>å¼€å¯æƒ°æ€§åˆ é™¤ï¼š<code>lazyfree-lazy-eviction=yes</code></p><p>æ€»ç»“ï¼šå¯¹memoryä¸å‹å¥½ï¼Œç”¨å­˜å‚¨ç©ºé—´æ¢å–å¤„ç†å™¨æ€§èƒ½ï¼ˆ<strong>ç©ºé—´æ¢æ—¶é—´</strong>ï¼‰</p><h4 id="å®šæœŸåˆ é™¤" tabindex="-1"><a class="header-anchor" href="#å®šæœŸåˆ é™¤"><span>å®šæœŸåˆ é™¤</span></a></h4><p>é€šè¿‡ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œå‘¨æœŸæ€§çš„æŠ½æ ·éƒ¨åˆ†è¿‡æœŸçš„keyï¼Œç„¶åæ‰§è¡Œåˆ é™¤ã€‚æ‰§è¡Œå‘¨æœŸæœ‰ä¸¤ç§ï¼š</p><ul><li>RedisæœåŠ¡åˆå§‹åŒ–å‡½æ•°initServer()ä¸­è®¾ç½®å®šæ—¶ä»»åŠ¡ï¼ŒæŒ‰ç…§server.hzçš„é¢‘ç‡æ¥æ‰§è¡Œè¿‡æœŸkeyæ¸…ç†ï¼Œæ¨¡å¼ä¸º<em>SLOW</em></li><li>Redisçš„æ¯ä¸ªäº‹ä»¶å¾ªç¯å‰ä¼šè°ƒç”¨beforeSleep()å‡½æ•°ï¼Œæ‰§è¡Œè¿‡æœŸkeyæ¸…ç†ï¼Œæ¨¡å¼ä¸º<em>FAST</em></li></ul><p><strong>SLOW</strong>æ¨¡å¼è§„åˆ™ï¼š</p><ol><li>æ‰§è¡Œé¢‘ç‡å—server.hzå½±å“ï¼Œé»˜è®¤ä¸º10ï¼Œå³æ¯ç§’æ‰§è¡Œ10æ¬¡ï¼Œæ¯ä¸ªæ‰§è¡Œå‘¨æœŸ100msã€‚</li><li>æ‰§è¡Œæ¸…ç†è€—æ—¶ä¸è¶…è¿‡ä¸€æ¬¡æ‰§è¡Œå‘¨æœŸçš„25%.é»˜è®¤slowæ¨¡å¼è€—æ—¶ä¸è¶…è¿‡25ms</li><li>é€ä¸ªéå†dbï¼Œé€ä¸ªéå†dbä¸­çš„bucketï¼ŒæŠ½å–20ä¸ªkeyåˆ¤æ–­æ˜¯å¦è¿‡æœŸ</li><li>å¦‚æœæ²¡è¾¾åˆ°æ—¶é—´ä¸Šé™ï¼ˆ25msï¼‰å¹¶ä¸”è¿‡æœŸkeyæ¯”ä¾‹å¤§äº10%ï¼Œå†è¿›è¡Œä¸€æ¬¡æŠ½æ ·ï¼Œå¦åˆ™ç»“æŸ</li></ol><p><strong>FAST</strong>æ¨¡å¼è§„åˆ™ï¼ˆè¿‡æœŸkeyæ¯”ä¾‹å°äº10%ä¸æ‰§è¡Œï¼‰ï¼š</p><ol><li>æ‰§è¡Œé¢‘ç‡å—beforeSleep()è°ƒç”¨é¢‘ç‡å½±å“ï¼Œä½†ä¸¤æ¬¡FASTæ¨¡å¼é—´éš”ä¸ä½äº2ms</li><li>æ‰§è¡Œæ¸…ç†è€—æ—¶ä¸è¶…è¿‡1ms</li><li>é€ä¸ªéå†dbï¼Œé€ä¸ªéå†DBä¸­çš„bucketï¼ŒæŠ½å–20ä¸ªkeyåˆ¤æ–­æ˜¯å¦è¿‡æœŸ</li><li>å¦‚æœæ²¡è¾¾åˆ°æ—¶é—´ä¸Šé™ï¼ˆ1msï¼‰å¹¶ä¸”è¿‡æœŸkeyæ¯”ä¾‹å¤§äº10%ï¼Œå†è¿›è¡Œä¸€æ¬¡æŠ½æ ·ï¼Œå¦åˆ™ç»“æŸ</li></ol><hr><p>ä»¥ä¸Šå‡ ç§æ–¹æ¡ˆå¯èƒ½å­˜åœ¨çš„é—®é¢˜ï¼š</p><ul><li>å®šæœŸåˆ é™¤æ—¶ï¼Œä»æ¥æ²¡æœ‰è¢«æŠ½æŸ¥åˆ°</li><li>æƒ°æ€§åˆ é™¤æ—¶ï¼Œä¹Ÿä»æ¥æ²¡æœ‰è¢«ç‚¹ä¸­ä½¿ç”¨è¿‡</li></ul><p>ä¸Šè¿°é—®é¢˜ä¼šå¯¼è‡´å¤§é‡è¿‡æœŸçš„keyå †ç§¯åœ¨å†…å­˜ä¸­ï¼Œå¯¼è‡´rediså†…å­˜ç©ºé—´ç´§å¼ æˆ–è€…å¾ˆå¿«è€—å°½ï¼Œç”±æ­¤å¼•å‡ºç¼“å­˜æ·˜æ±°ç­–ç•¥</p><h3 id="ç¼“å­˜æ·˜æ±°ç­–ç•¥" tabindex="-1"><a class="header-anchor" href="#ç¼“å­˜æ·˜æ±°ç­–ç•¥"><span>ç¼“å­˜æ·˜æ±°ç­–ç•¥</span></a></h3><p><strong>2ä¸ªç»´åº¦</strong></p><ol><li>è¿‡æœŸé”®ä¸­ç­›é€‰</li><li>æ‰€æœ‰é”®ä¸­ç­›é€‰</li></ol><p><strong>4ä¸ªæ–¹é¢</strong></p><ol><li><p><strong>LRU</strong>ï¼šæœ€è¿‘æœ€å°‘ä½¿ç”¨é¡µé¢ç½®æ¢ç®—æ³•ï¼Œæ·˜æ±°æœ€é•¿æ—¶é—´æœªè¢«ä½¿ç”¨çš„é¡µé¢ï¼Œçœ‹é¡µé¢æœ€åä¸€æ¬¡è¢«ä½¿ç”¨åˆ°å‘ç”Ÿè°ƒåº¦çš„æ—¶é—´é•¿çŸ­ï¼Œé¦–å…ˆæ·˜æ±°æœ€é•¿æ—¶é—´æœªè¢«ä½¿ç”¨çš„é¡µé¢ã€‚</p></li><li><p><strong>LFU</strong>ï¼šæœ€è¿‘æœ€ä¸å¸¸ç”¨é¡µé¢ç½®æ¢ç®—æ³•ï¼Œæ·˜æ±°ä¸€å®šæ—¶æœŸå†…è¢«è®¿é—®æ¬¡æ•°æœ€å°‘çš„é¡µï¼Œçœ‹ä¸€å®šæ—¶é—´æ®µå†…é¡µé¢è¢«ä½¿ç”¨çš„é¢‘ç‡ï¼Œæ·˜æ±°ä¸€å®šæ—¶æœŸå†…è¢«è®¿é—®æ¬¡æ•°æœ€å°‘çš„é¡µé¢</p><ul><li><p>ä¸¾ä¾‹</p><p>æŸæ¬¡æ—¶æœŸTimeä¸º10åˆ†é’Ÿ,å¦‚æœæ¯åˆ†é’Ÿè¿›è¡Œä¸€æ¬¡è°ƒé¡µ,ä¸»å­˜å—ä¸º3,è‹¥æ‰€éœ€é¡µé¢èµ°å‘ä¸º2 1 2 1 2 3 4ï¼Œå‡è®¾åˆ°é¡µé¢4æ—¶ä¼šå‘ç”Ÿç¼ºé¡µä¸­æ–­</p><ul><li>æŒ‰LRUç®—æ³•,åº”æ¢é¡µé¢1(1é¡µé¢æœ€ä¹…æœªè¢«ä½¿ç”¨)</li><li>æŒ‰LFUç®—æ³•åº”æ¢é¡µé¢3(ååˆ†é’Ÿå†…,é¡µé¢3åªä½¿ç”¨äº†ä¸€æ¬¡)</li></ul><p>å¯è§LRUå…³é”®æ˜¯çœ‹é¡µé¢æœ€åä¸€æ¬¡è¢«ä½¿ç”¨åˆ°å‘ç”Ÿè°ƒåº¦çš„æ—¶é—´é•¿çŸ­,è€ŒLFUå…³é”®æ˜¯çœ‹ä¸€å®šæ—¶é—´æ®µå†…é¡µé¢è¢«ä½¿ç”¨çš„é¢‘ç‡</p></li></ul></li><li><p><strong>random</strong>:éšæœºåˆ é™¤</p></li><li><p><strong>ttl</strong>ï¼šæ ¹æ®è¿‡æœŸæ—¶é—´åˆ é™¤</p></li></ol><p><strong>8ä¸ªé€‰é¡¹</strong></p><ol><li><code>noeviction</code>:ä¸ä¼šé©±é€ä»»ä½•key,å³ä½¿å†…å­˜è¾¾åˆ°ä¸Šé™ä¹Ÿä¸è¿›è¡Œç½®æ¢ï¼Œæ‰€æœ‰èƒ½å¼•èµ·å†…å­˜å¢åŠ çš„å‘½ä»¤éƒ½ä¼šè¿”å›ERRORï¼ˆ<strong>é»˜è®¤</strong>ï¼‰</li><li><code>allkeys-lru</code>:å¯¹æ‰€æœ‰keyä½¿ç”¨LRUç®—æ³•è¿›è¡Œåˆ é™¤ï¼Œä¼˜å…ˆåˆ é™¤æœ€è¿‘æœ€ä¸ç»å¸¸ä½¿ç”¨çš„keyï¼Œç”¨ä»¥ä¿å­˜æ–°æ•°æ®ï¼ˆ<strong>æœ€æ³›ç”¨</strong>ï¼‰</li><li><code>volatile-lru</code>:å¯¹æ‰€æœ‰è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„keyä½¿ç”¨LRUç®—æ³•è¿›è¡Œåˆ é™¤</li><li><code>allkeys-random</code>:å¯¹æ‰€æœ‰keyéšæœºåˆ é™¤</li><li><code>volatile-random</code>:å¯¹æ‰€æœ‰è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„keyéšæœºåˆ é™¤</li><li><code>volatile-ttl</code>:åˆ é™¤å³å°†è¿‡æœŸçš„key</li><li><code>allkeys-lfu</code>:å¯¹æ‰€æœ‰keyä½¿ç”¨LFUç®—æ³•åˆ é™¤</li><li><code>volatile-lfu</code>:å¯¹æ‰€æœ‰è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„keyä½¿ç”¨LFUç®—æ³•è¿›è¡Œåˆ é™¤</li></ol><p><strong>æ€§èƒ½å»ºè®®</strong></p><ul><li>é¿å…å­˜å‚¨BigKey</li><li>å¼€å¯æƒ°æ€§åˆ é™¤ï¼š<code>lazyfree-lazy-eviction=yes</code></li></ul><h2 id="åº•å±‚æ•°æ®ç»“æ„" tabindex="-1"><a class="header-anchor" href="#åº•å±‚æ•°æ®ç»“æ„"><span>åº•å±‚æ•°æ®ç»“æ„</span></a></h2><h3 id="sds" tabindex="-1"><a class="header-anchor" href="#sds"><span>SDS</span></a></h3><p>Redisä¸­ä¿å­˜çš„Keyæ˜¯å­—ç¬¦ä¸²ï¼Œvalueå¾€å¾€æ˜¯å­—ç¬¦ä¸²æˆ–è€…å­—ç¬¦ä¸²çš„é›†åˆã€‚</p><p>Redisæ²¡æœ‰ç›´æ¥ä½¿ç”¨Cè¯­è¨€ä¸­çš„å­—ç¬¦ä¸²ï¼Œå› ä¸ºCè¯­è¨€å­—ç¬¦ä¸²å­˜åœ¨å¾ˆå¤šé—®é¢˜ï¼š</p><ul><li>è·å–å­—ç¬¦ä¸²é•¿åº¦çš„éœ€è¦é€šè¿‡è¿ç®—</li><li>éäºŒè¿›åˆ¶å®‰å…¨</li><li>ä¸å¯ä¿®æ”¹</li></ul><p>Redisæ„å»ºäº†ä¸€ç§æ–°çš„å­—ç¬¦ä¸²ç»“æ„ï¼Œç§°ä¸ºç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆSimple Dynamic Stringï¼‰ï¼Œç®€ç§°SDSã€‚</p><p>ä¾‹å¦‚ï¼šæ‰§è¡Œå‘½ä»¤<code>set name Jack</code></p><p>Rediså°†åœ¨åº•å±‚åˆ›å»º2ä¸ªSDSï¼Œå…¶ä¸­ä¸€ä¸ªæ˜¯åŒ…å«&quot;name&quot;çš„SDS,å¦ä¸€ä¸ªæ˜¯åŒ…å«â€œè™å“¥â€çš„SDSã€‚</p><p>SDSæ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œæºç å¦‚ä¸‹ï¼š</p><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior07.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>å…¶ä¸­ï¼Œä¸€ä¸ªåŒ…å«å­—ç¬¦ä¸²â€œnameâ€çš„SDSç»“æ„å¦‚ä¸‹ï¼š</p><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior08.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>SDSä¹‹æ‰€ä»¥å«åšåŠ¨æ€å­—ç¬¦ä¸²ï¼Œæ˜¯å› ä¸ºå®ƒå…·å¤‡åŠ¨æ€æ‰©å®¹çš„èƒ½åŠ›ï¼Œä¾‹å¦‚ä¸€ä¸ªå†…å®¹ä¸ºâ€œhiâ€çš„SDSï¼š</p><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior09.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>å‡å¦‚æˆ‘ä»¬è¦ç»™SDSè¿½åŠ ä¸€æ®µå­—ç¬¦ä¸²â€œ,Amyâ€ï¼Œè¿™é‡Œé¦–å…ˆä¼šç”³è¯·æ–°å†…å­˜ç©ºé—´ï¼š</p><ul><li><p>å¦‚æœæ–°å­—ç¬¦ä¸²å°äº1Mï¼Œåˆ™æ–°ç©ºé—´ä¸º<em>æ‰©å±•åå­—ç¬¦ä¸²é•¿åº¦çš„ä¸¤å€+1</em>ï¼›</p></li><li><p>å¦‚æœæ–°å­—ç¬¦ä¸²å¤§äº1Mï¼Œåˆ™æ–°ç©ºé—´ä¸º<em>æ‰©å±•åå­—ç¬¦ä¸²é•¿åº¦+1M+1</em>ã€‚</p></li></ul><p>è¿™ç§æœºåˆ¶ç§°ä¸º<strong>å†…å­˜é¢„åˆ†é…</strong>ã€‚</p><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior10.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="intset" tabindex="-1"><a class="header-anchor" href="#intset"><span>intset</span></a></h3><p>IntSetæ˜¯Redisä¸­seté›†åˆçš„ä¸€ç§å®ç°æ–¹å¼ï¼ŒåŸºäºæ•´æ•°æ•°ç»„æ¥å®ç°ï¼Œå¹¶ä¸”å…·å¤‡é•¿åº¦å¯å˜ã€æœ‰åºç­‰ç‰¹å¾ã€‚<br> ç»“æ„å¦‚ä¸‹ï¼š</p><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior11.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>å…¶ä¸­çš„encodingåŒ…å«ä¸‰ç§æ¨¡å¼ï¼Œè¡¨ç¤ºå­˜å‚¨çš„æ•´æ•°å¤§å°ä¸åŒï¼š</p><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior12.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior13.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>ç°åœ¨ï¼Œæ•°ç»„ä¸­æ¯ä¸ªæ•°å­—éƒ½åœ¨int16_tçš„èŒƒå›´å†…ï¼Œå› æ­¤é‡‡ç”¨çš„ç¼–ç æ–¹å¼æ˜¯INTSET_ENC_INT16ï¼Œæ¯éƒ¨åˆ†å ç”¨çš„å­—èŠ‚å¤§å°ä¸ºï¼š</p><ul><li>encodingï¼š4å­—èŠ‚</li><li>lengthï¼š4å­—èŠ‚</li><li>contentsï¼š2å­—èŠ‚ * 3 = 6å­—èŠ‚</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior14.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>æˆ‘ä»¬å‘å…¶ä¸­æ·»åŠ ä¸€ä¸ªæ•°å­—ï¼š50000ï¼Œè¿™ä¸ªæ•°å­—è¶…å‡ºäº†int16_tçš„èŒƒå›´ï¼Œintsetä¼šè‡ªåŠ¨å‡çº§ç¼–ç æ–¹å¼åˆ°åˆé€‚çš„å¤§å°ã€‚<br> ä»¥å½“å‰æ¡ˆä¾‹æ¥è¯´æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>å‡çº§ç¼–ç ä¸ºINTSET_ENC_INT32, æ¯ä¸ªæ•´æ•°å 4å­—èŠ‚ï¼Œå¹¶æŒ‰ç…§æ–°çš„ç¼–ç æ–¹å¼åŠå…ƒç´ ä¸ªæ•°æ‰©å®¹æ•°ç»„</li><li>å€’åºä¾æ¬¡å°†æ•°ç»„ä¸­çš„å…ƒç´ æ‹·è´åˆ°æ‰©å®¹åçš„æ­£ç¡®ä½ç½®</li><li>å°†å¾…æ·»åŠ çš„å…ƒç´ æ”¾å…¥æ•°ç»„æœ«å°¾</li><li>æœ€åï¼Œå°†insetçš„encodingå±æ€§æ”¹ä¸ºINTSET_ENC_INT32ï¼Œå°†lengthå±æ€§æ”¹ä¸º4</li></ol><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior15.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p><strong>æ€»ç»“</strong></p><p>Intsetå¯ä»¥çœ‹åšæ˜¯ç‰¹æ®Šçš„æ•´æ•°æ•°ç»„ï¼Œå…·å¤‡ä¸€äº›ç‰¹ç‚¹ï¼š</p><ul><li>Redisä¼šç¡®ä¿Intsetä¸­çš„å…ƒç´ å”¯ä¸€ã€æœ‰åº</li><li>å…·å¤‡ç±»å‹å‡çº§æœºåˆ¶ï¼Œå¯ä»¥èŠ‚çœå†…å­˜ç©ºé—´</li><li>åº•å±‚é‡‡ç”¨äºŒåˆ†æŸ¥æ‰¾æ–¹å¼æ¥æŸ¥è¯¢</li></ul><h3 id="dict" tabindex="-1"><a class="header-anchor" href="#dict"><span>Dict</span></a></h3><p>Redisæ˜¯ä¸€ä¸ªé”®å€¼å‹ï¼ˆKey-Value Pairï¼‰çš„æ•°æ®åº“ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®é”®å®ç°å¿«é€Ÿçš„å¢åˆ æ”¹æŸ¥ã€‚è€Œé”®ä¸å€¼çš„æ˜ å°„å…³ç³»æ­£æ˜¯é€šè¿‡Dictæ¥å®ç°çš„ã€‚<br> Dictç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼Œåˆ†åˆ«æ˜¯ï¼šå“ˆå¸Œè¡¨ï¼ˆDictHashTableï¼‰ã€å“ˆå¸ŒèŠ‚ç‚¹ï¼ˆDictEntryï¼‰ã€å­—å…¸ï¼ˆDictï¼‰</p><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior16.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>å½“æˆ‘ä»¬å‘Dictæ·»åŠ é”®å€¼å¯¹æ—¶ï¼ŒRedisé¦–å…ˆæ ¹æ®keyè®¡ç®—å‡ºhashå€¼ï¼ˆhï¼‰ï¼Œç„¶ååˆ©ç”¨ h &amp; sizemaskæ¥è®¡ç®—å…ƒç´ åº”è¯¥å­˜å‚¨åˆ°æ•°ç»„ä¸­çš„å“ªä¸ªç´¢å¼•ä½ç½®ã€‚æˆ‘ä»¬å­˜å‚¨k1=v1ï¼Œå‡è®¾k1çš„å“ˆå¸Œå€¼h=1ï¼Œåˆ™1&amp;3=1ï¼Œå› æ­¤k1=v1è¦å­˜å‚¨åˆ°æ•°ç»„è§’æ ‡1ä½ç½®ã€‚</p><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior17.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>Dictç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼Œåˆ†åˆ«æ˜¯ï¼šå“ˆå¸Œè¡¨ï¼ˆDictHashTableï¼‰ã€å“ˆå¸ŒèŠ‚ç‚¹ï¼ˆDictEntryï¼‰ã€å­—å…¸ï¼ˆDictï¼‰</p><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior18.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior19.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p><strong>Dictçš„æ‰©å®¹</strong></p><p>Dictä¸­çš„HashTableå°±æ˜¯æ•°ç»„ç»“åˆå•å‘é“¾è¡¨çš„å®ç°ï¼Œå½“é›†åˆä¸­å…ƒç´ è¾ƒå¤šæ—¶ï¼Œå¿…ç„¶å¯¼è‡´å“ˆå¸Œå†²çªå¢å¤šï¼Œé“¾è¡¨è¿‡é•¿ï¼Œåˆ™æŸ¥è¯¢æ•ˆç‡ä¼šå¤§å¤§é™ä½ã€‚<br> Dictåœ¨æ¯æ¬¡æ–°å¢é”®å€¼å¯¹æ—¶éƒ½ä¼šæ£€æŸ¥è´Ÿè½½å› å­ï¼ˆLoadFactor = used/sizeï¼‰ ï¼Œæ»¡è¶³ä»¥ä¸‹ä¸¤ç§æƒ…å†µæ—¶ä¼šè§¦å‘å“ˆå¸Œè¡¨æ‰©å®¹ï¼š</p><ul><li>å“ˆå¸Œè¡¨çš„ LoadFactor &gt;= 1ï¼Œå¹¶ä¸”æœåŠ¡å™¨æ²¡æœ‰æ‰§è¡Œ BGSAVE æˆ–è€… BGREWRITEAOF ç­‰åå°è¿›ç¨‹ï¼›</li><li>å“ˆå¸Œè¡¨çš„ LoadFactor &gt; 5 ï¼›</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior20.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior21.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p><strong>Dictçš„rehash</strong></p><p>ä¸ç®¡æ˜¯æ‰©å®¹è¿˜æ˜¯æ”¶ç¼©ï¼Œå¿…å®šä¼šåˆ›å»ºæ–°çš„å“ˆå¸Œè¡¨ï¼Œå¯¼è‡´å“ˆå¸Œè¡¨çš„sizeå’Œsizemaskå˜åŒ–ï¼Œè€Œkeyçš„æŸ¥è¯¢ä¸sizemaskæœ‰å…³ã€‚å› æ­¤å¿…é¡»å¯¹å“ˆå¸Œè¡¨ä¸­çš„æ¯ä¸€ä¸ªkeyé‡æ–°è®¡ç®—ç´¢å¼•ï¼Œæ’å…¥æ–°çš„å“ˆå¸Œè¡¨ï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºrehashã€‚è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š</p><ol><li><p>è®¡ç®—æ–°hashè¡¨çš„realeSizeï¼Œå€¼å–å†³äºå½“å‰è¦åšçš„æ˜¯æ‰©å®¹è¿˜æ˜¯æ”¶ç¼©ï¼š</p><ul><li>å¦‚æœæ˜¯æ‰©å®¹ï¼Œåˆ™æ–°sizeä¸ºç¬¬ä¸€ä¸ªå¤§äºç­‰äºdict.ht[0].used + 1çš„2^n</li><li>å¦‚æœæ˜¯æ”¶ç¼©ï¼Œåˆ™æ–°sizeä¸ºç¬¬ä¸€ä¸ªå¤§äºç­‰äºdict.ht[0].usedçš„2^n ï¼ˆä¸å¾—å°äº4ï¼‰</li></ul></li><li><p>æŒ‰ç…§æ–°çš„realeSizeç”³è¯·å†…å­˜ç©ºé—´ï¼Œåˆ›å»ºdicthtï¼Œå¹¶èµ‹å€¼ç»™dict.ht[1]</p></li><li><p>è®¾ç½®dict.rehashidx = 0ï¼Œæ ‡ç¤ºå¼€å§‹rehash</p></li><li><p>å°†dict.ht[0]ä¸­çš„æ¯ä¸€ä¸ªdictEntryéƒ½rehashåˆ°dict.ht[1]</p></li><li><p>å°†dict.ht[1]èµ‹å€¼ç»™dict.ht[0]ï¼Œç»™dict.ht[1]åˆå§‹åŒ–ä¸ºç©ºå“ˆå¸Œè¡¨ï¼Œé‡Šæ”¾åŸæ¥çš„dict.ht[0]çš„å†…å­˜</p></li><li><p>å°†rehashidxèµ‹å€¼ä¸º-1ï¼Œä»£è¡¨rehashç»“æŸ</p></li><li><p>åœ¨rehashè¿‡ç¨‹ä¸­ï¼Œæ–°å¢æ“ä½œï¼Œåˆ™ç›´æ¥å†™å…¥ht[1]ï¼ŒæŸ¥è¯¢ã€ä¿®æ”¹å’Œåˆ é™¤åˆ™ä¼šåœ¨dict.ht[0]å’Œdict.ht[1]ä¾æ¬¡æŸ¥æ‰¾å¹¶æ‰§è¡Œã€‚è¿™æ ·å¯ä»¥ç¡®ä¿ht[0]çš„æ•°æ®åªå‡ä¸å¢ï¼Œéšç€rehashæœ€ç»ˆä¸ºç©º</p></li></ol><p>æ•´ä¸ªè¿‡ç¨‹å¯ä»¥æè¿°æˆï¼š</p><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior22.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p><strong>æ€»ç»“</strong></p><p>Dictçš„ç»“æ„ï¼š</p><ul><li>ç±»ä¼¼Javaçš„HashTableï¼Œåº•å±‚æ˜¯æ•°ç»„åŠ é“¾è¡¨æ¥è§£å†³å“ˆå¸Œå†²çª</li><li>DictåŒ…å«ä¸¤ä¸ªå“ˆå¸Œè¡¨ï¼Œht[0]å¹³å¸¸ç”¨ï¼Œht[1]ç”¨æ¥rehash</li></ul><p>Dictçš„ä¼¸ç¼©ï¼š</p><ul><li>å½“LoadFactorå¤§äº5æˆ–è€…LoadFactorå¤§äº1å¹¶ä¸”æ²¡æœ‰å­è¿›ç¨‹ä»»åŠ¡æ—¶ï¼ŒDictæ‰©å®¹</li><li>å½“LoadFactorå°äº0.1æ—¶ï¼ŒDictæ”¶ç¼©</li><li>æ‰©å®¹å¤§å°ä¸ºç¬¬ä¸€ä¸ªå¤§äºç­‰äºused + 1çš„2^n</li><li>æ”¶ç¼©å¤§å°ä¸ºç¬¬ä¸€ä¸ªå¤§äºç­‰äºused çš„2^n</li><li>Dicté‡‡ç”¨æ¸è¿›å¼rehashï¼Œæ¯æ¬¡è®¿é—®Dictæ—¶æ‰§è¡Œä¸€æ¬¡rehash</li><li>rehashæ—¶ht[0]åªå‡ä¸å¢ï¼Œæ–°å¢æ“ä½œåªåœ¨ht[1]æ‰§è¡Œï¼Œå…¶å®ƒæ“ä½œåœ¨ä¸¤ä¸ªå“ˆå¸Œè¡¨</li></ul><h3 id="ziplist" tabindex="-1"><a class="header-anchor" href="#ziplist"><span>ZipList</span></a></h3><p>ZipList æ˜¯ä¸€ç§ç‰¹æ®Šçš„â€œåŒç«¯é“¾è¡¨â€ ï¼Œç”±ä¸€ç³»åˆ—ç‰¹æ®Šç¼–ç çš„è¿ç»­å†…å­˜å—ç»„æˆã€‚å¯ä»¥åœ¨ä»»æ„ä¸€ç«¯è¿›è¡Œå‹å…¥/å¼¹å‡ºæ“ä½œ, å¹¶ä¸”è¯¥æ“ä½œçš„æ—¶é—´å¤æ‚åº¦ä¸º O(1)ã€‚</p><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior23.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior24.png" alt="image-20241023090358960" tabindex="0" loading="lazy"><figcaption>image-20241023090358960</figcaption></figure><table><thead><tr><th>å±æ€§</th><th>ç±»å‹</th><th>é•¿åº¦</th><th>ç”¨é€”</th></tr></thead><tbody><tr><td>zlbytes</td><td>uint32_t</td><td>4å­—èŠ‚</td><td>è®°å½•æ•´ä¸ªå‹ç¼©åˆ—è¡¨å ç”¨çš„å†…å­˜å­—èŠ‚æ•°</td></tr><tr><td>zltail</td><td>uint32_t</td><td>4å­—èŠ‚</td><td>è®°å½•å‹ç¼©åˆ—è¡¨è¡¨å°¾èŠ‚ç‚¹è·ç¦»å‹ç¼©åˆ—è¡¨çš„èµ·å§‹åœ°å€æœ‰å¤šå°‘å­—èŠ‚ï¼Œé€šè¿‡è¿™ä¸ªåç§»é‡ï¼Œå¯ä»¥ç¡®å®šè¡¨å°¾èŠ‚ç‚¹çš„åœ°å€ã€‚</td></tr><tr><td>zllen</td><td>uint16_t</td><td>2å­—èŠ‚</td><td>è®°å½•äº†å‹ç¼©åˆ—è¡¨åŒ…å«çš„èŠ‚ç‚¹æ•°é‡ã€‚ æœ€å¤§å€¼ä¸ºUINT16_MAX ï¼ˆ65534ï¼‰ï¼Œå¦‚æœè¶…è¿‡è¿™ä¸ªå€¼ï¼Œæ­¤å¤„ä¼šè®°å½•ä¸º65535ï¼Œä½†èŠ‚ç‚¹çš„çœŸå®æ•°é‡éœ€è¦éå†æ•´ä¸ªå‹ç¼©åˆ—è¡¨æ‰èƒ½è®¡ç®—å¾—å‡ºã€‚</td></tr><tr><td>entry</td><td>åˆ—è¡¨èŠ‚ç‚¹</td><td>ä¸å®š</td><td>å‹ç¼©åˆ—è¡¨åŒ…å«çš„å„ä¸ªèŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹çš„é•¿åº¦ç”±èŠ‚ç‚¹ä¿å­˜çš„å†…å®¹å†³å®šã€‚</td></tr><tr><td>zlend</td><td>uint8_t</td><td>1å­—èŠ‚</td><td>ç‰¹æ®Šå€¼ 0xFF ï¼ˆåè¿›åˆ¶ 255 ï¼‰ï¼Œç”¨äºæ ‡è®°å‹ç¼©åˆ—è¡¨çš„æœ«ç«¯ã€‚</td></tr></tbody></table><p><strong>ZipListEntry</strong></p><p>ZipList ä¸­çš„Entryå¹¶ä¸åƒæ™®é€šé“¾è¡¨é‚£æ ·è®°å½•å‰åèŠ‚ç‚¹çš„æŒ‡é’ˆï¼Œå› ä¸ºè®°å½•ä¸¤ä¸ªæŒ‡é’ˆè¦å ç”¨16ä¸ªå­—èŠ‚ï¼Œæµªè´¹å†…å­˜ã€‚è€Œæ˜¯é‡‡ç”¨äº†ä¸‹é¢çš„ç»“æ„ï¼š</p><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior25.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li><p>previous_entry_lengthï¼šå‰ä¸€èŠ‚ç‚¹çš„é•¿åº¦ï¼Œå 1ä¸ªæˆ–5ä¸ªå­—èŠ‚ã€‚</p><ul><li>å¦‚æœå‰ä¸€èŠ‚ç‚¹çš„é•¿åº¦å°äº254å­—èŠ‚ï¼Œåˆ™é‡‡ç”¨1ä¸ªå­—èŠ‚æ¥ä¿å­˜è¿™ä¸ªé•¿åº¦å€¼</li><li>å¦‚æœå‰ä¸€èŠ‚ç‚¹çš„é•¿åº¦å¤§äº254å­—èŠ‚ï¼Œåˆ™é‡‡ç”¨5ä¸ªå­—èŠ‚æ¥ä¿å­˜è¿™ä¸ªé•¿åº¦å€¼ï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º0xfeï¼Œåå››ä¸ªå­—èŠ‚æ‰æ˜¯çœŸå®é•¿åº¦æ•°æ®</li></ul></li><li><p>encodingï¼šç¼–ç å±æ€§ï¼Œè®°å½•contentçš„æ•°æ®ç±»å‹ï¼ˆå­—ç¬¦ä¸²è¿˜æ˜¯æ•´æ•°ï¼‰ä»¥åŠé•¿åº¦ï¼Œå ç”¨1ä¸ªã€2ä¸ªæˆ–5ä¸ªå­—èŠ‚</p></li><li><p>contentsï¼šè´Ÿè´£ä¿å­˜èŠ‚ç‚¹çš„æ•°æ®ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²æˆ–æ•´æ•°</p></li></ul><p>ZipListä¸­æ‰€æœ‰å­˜å‚¨é•¿åº¦çš„æ•°å€¼å‡é‡‡ç”¨å°ç«¯å­—èŠ‚åºï¼Œå³ä½ä½å­—èŠ‚åœ¨å‰ï¼Œé«˜ä½å­—èŠ‚åœ¨åã€‚ä¾‹å¦‚ï¼šæ•°å€¼0x1234ï¼Œé‡‡ç”¨å°ç«¯å­—èŠ‚åºåå®é™…å­˜å‚¨å€¼ä¸ºï¼š0x3412</p><p><strong>Encodingç¼–ç </strong></p><p>ZipListEntryä¸­çš„encodingç¼–ç åˆ†ä¸ºå­—ç¬¦ä¸²å’Œæ•´æ•°ä¸¤ç§ï¼š<br> å­—ç¬¦ä¸²ï¼šå¦‚æœencodingæ˜¯ä»¥â€œ00â€ã€â€œ01â€æˆ–è€…â€œ10â€å¼€å¤´ï¼Œåˆ™è¯æ˜contentæ˜¯å­—ç¬¦ä¸²</p><table><thead><tr><th><strong>ç¼–ç </strong></th><th><strong>ç¼–ç é•¿åº¦</strong></th><th><strong>å­—ç¬¦ä¸²å¤§å°</strong></th></tr></thead><tbody><tr><td>|00pppppp|</td><td>1 bytes</td><td>&lt;= 63 bytes</td></tr><tr><td>|01pppppp|qqqqqqqq|</td><td>2 bytes</td><td>&lt;= 16383 bytes</td></tr><tr><td>|10000000|qqqqqqqq|rrrrrrrr|ssssssss|tttttttt|</td><td>5 bytes</td><td>&lt;= 4294967295 bytes</td></tr></tbody></table><p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬è¦ä¿å­˜å­—ç¬¦ä¸²ï¼šâ€œabâ€å’Œ â€œbcâ€</p><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior26.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>ZipListEntryä¸­çš„encodingç¼–ç åˆ†ä¸ºå­—ç¬¦ä¸²å’Œæ•´æ•°ä¸¤ç§ï¼š</p><ul><li>æ•´æ•°ï¼šå¦‚æœencodingæ˜¯ä»¥â€œ11â€å¼€å§‹ï¼Œåˆ™è¯æ˜contentæ˜¯æ•´æ•°ï¼Œä¸”encodingå›ºå®šåªå ç”¨1ä¸ªå­—èŠ‚</li></ul><table><thead><tr><th><strong>ç¼–ç </strong></th><th><strong>ç¼–ç é•¿åº¦</strong></th><th><strong>æ•´æ•°ç±»å‹</strong></th></tr></thead><tbody><tr><td>11000000</td><td>1</td><td>int16_tï¼ˆ2 bytesï¼‰</td></tr><tr><td>11010000</td><td>1</td><td>int32_tï¼ˆ4 bytesï¼‰</td></tr><tr><td>11100000</td><td>1</td><td>int64_tï¼ˆ8 bytesï¼‰</td></tr><tr><td>11110000</td><td>1</td><td>24ä½æœ‰ç¬¦æ•´æ•°(3 bytes)</td></tr><tr><td>11111110</td><td>1</td><td>8ä½æœ‰ç¬¦æ•´æ•°(1 bytes)</td></tr><tr><td>1111xxxx</td><td>1</td><td>ç›´æ¥åœ¨xxxxä½ç½®ä¿å­˜æ•°å€¼ï¼ŒèŒƒå›´ä»0001~1101ï¼Œå‡1åç»“æœä¸ºå®é™…å€¼</td></tr></tbody></table><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior27.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior28.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h4 id="è¿é”æ›´æ–°é—®é¢˜" tabindex="-1"><a class="header-anchor" href="#è¿é”æ›´æ–°é—®é¢˜"><span>è¿é”æ›´æ–°é—®é¢˜</span></a></h4><p>ZipListçš„æ¯ä¸ªEntryéƒ½åŒ…å«previous_entry_lengthæ¥è®°å½•ä¸Šä¸€ä¸ªèŠ‚ç‚¹çš„å¤§å°ï¼Œé•¿åº¦æ˜¯1ä¸ªæˆ–5ä¸ªå­—èŠ‚ï¼š<br> å¦‚æœå‰ä¸€èŠ‚ç‚¹çš„é•¿åº¦å°äº254å­—èŠ‚ï¼Œåˆ™é‡‡ç”¨1ä¸ªå­—èŠ‚æ¥ä¿å­˜è¿™ä¸ªé•¿åº¦å€¼<br> å¦‚æœå‰ä¸€èŠ‚ç‚¹çš„é•¿åº¦å¤§äºç­‰äº254å­—èŠ‚ï¼Œåˆ™é‡‡ç”¨5ä¸ªå­—èŠ‚æ¥ä¿å­˜è¿™ä¸ªé•¿åº¦å€¼ï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º0xfeï¼Œåå››ä¸ªå­—èŠ‚æ‰æ˜¯çœŸå®é•¿åº¦æ•°æ®<br> ç°åœ¨ï¼Œå‡è®¾æˆ‘ä»¬æœ‰Nä¸ªè¿ç»­çš„ã€é•¿åº¦ä¸º250~253å­—èŠ‚ä¹‹é—´çš„entryï¼Œå› æ­¤entryçš„previous_entry_lengthå±æ€§ç”¨1ä¸ªå­—èŠ‚å³å¯è¡¨ç¤ºï¼Œå¦‚å›¾æ‰€ç¤ºï¼š</p><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior29.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>ZipListè¿™ç§ç‰¹æ®Šæƒ…å†µä¸‹äº§ç”Ÿçš„è¿ç»­å¤šæ¬¡ç©ºé—´æ‰©å±•æ“ä½œç§°ä¹‹ä¸ºè¿é”æ›´æ–°ï¼ˆCascade Updateï¼‰ã€‚æ–°å¢ã€åˆ é™¤éƒ½å¯èƒ½å¯¼è‡´è¿é”æ›´æ–°çš„å‘ç”Ÿã€‚</p><p><strong>ZipListç‰¹æ€§æ€»ç»“</strong></p><ul><li>å‹ç¼©åˆ—è¡¨çš„å¯ä»¥çœ‹åšä¸€ç§è¿ç»­å†…å­˜ç©ºé—´çš„&quot;åŒå‘é“¾è¡¨&quot;</li><li>åˆ—è¡¨çš„èŠ‚ç‚¹ä¹‹é—´ä¸æ˜¯é€šè¿‡æŒ‡é’ˆè¿æ¥ï¼Œè€Œæ˜¯è®°å½•ä¸Šä¸€èŠ‚ç‚¹å’Œæœ¬èŠ‚ç‚¹é•¿åº¦æ¥å¯»å€ï¼Œå†…å­˜å ç”¨è¾ƒä½</li><li>å¦‚æœåˆ—è¡¨æ•°æ®è¿‡å¤šï¼Œå¯¼è‡´é“¾è¡¨è¿‡é•¿ï¼Œå¯èƒ½å½±å“æŸ¥è¯¢æ€§èƒ½</li><li>å¢æˆ–åˆ è¾ƒå¤§æ•°æ®æ—¶æœ‰å¯èƒ½å‘ç”Ÿè¿ç»­æ›´æ–°é—®é¢˜</li></ul><h3 id="quicklist" tabindex="-1"><a class="header-anchor" href="#quicklist"><span>QuickList</span></a></h3><p>é—®é¢˜1ï¼šZipListè™½ç„¶èŠ‚çœå†…å­˜ï¼Œä½†ç”³è¯·å†…å­˜å¿…é¡»æ˜¯è¿ç»­ç©ºé—´ï¼Œå¦‚æœå†…å­˜å ç”¨è¾ƒå¤šï¼Œç”³è¯·å†…å­˜æ•ˆç‡å¾ˆä½ã€‚æ€ä¹ˆåŠï¼Ÿ</p><p>â€‹ ç­”ï¼šä¸ºäº†ç¼“è§£è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¿…é¡»é™åˆ¶ZipListçš„é•¿åº¦å’Œentryå¤§å°ã€‚</p><p>é—®é¢˜2ï¼šä½†æ˜¯æˆ‘ä»¬è¦å­˜å‚¨å¤§é‡æ•°æ®ï¼Œè¶…å‡ºäº†ZipListæœ€ä½³çš„ä¸Šé™è¯¥æ€ä¹ˆåŠï¼Ÿ</p><p>â€‹ ç­”ï¼šæˆ‘ä»¬å¯ä»¥åˆ›å»ºå¤šä¸ªZipListæ¥åˆ†ç‰‡å­˜å‚¨æ•°æ®ã€‚</p><p>é—®é¢˜3ï¼šæ•°æ®æ‹†åˆ†åæ¯”è¾ƒåˆ†æ•£ï¼Œä¸æ–¹ä¾¿ç®¡ç†å’ŒæŸ¥æ‰¾ï¼Œè¿™å¤šä¸ªZipListå¦‚ä½•å»ºç«‹è”ç³»ï¼Ÿ</p><p>â€‹ ç­”ï¼šRedisåœ¨3.2ç‰ˆæœ¬å¼•å…¥äº†æ–°çš„æ•°æ®ç»“æ„QuickListï¼Œå®ƒæ˜¯ä¸€ä¸ªåŒç«¯é“¾è¡¨ï¼Œåªä¸è¿‡é“¾è¡¨ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ä¸€ä¸ªZipListã€‚</p><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior30.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>ä¸ºäº†é¿å…QuickListä¸­çš„æ¯ä¸ªZipListä¸­entryè¿‡å¤šï¼ŒRedisæä¾›äº†ä¸€ä¸ªé…ç½®é¡¹ï¼šlist-max-ziplist-sizeæ¥é™åˆ¶ã€‚<br> å¦‚æœå€¼ä¸ºæ­£ï¼Œåˆ™ä»£è¡¨ZipListçš„å…è®¸çš„entryä¸ªæ•°çš„æœ€å¤§å€¼<br> å¦‚æœå€¼ä¸ºè´Ÿï¼Œåˆ™ä»£è¡¨ZipListçš„æœ€å¤§å†…å­˜å¤§å°ï¼Œåˆ†5ç§æƒ…å†µï¼š</p><ul><li>-1ï¼šæ¯ä¸ªZipListçš„å†…å­˜å ç”¨ä¸èƒ½è¶…è¿‡4kb</li><li>-2ï¼šæ¯ä¸ªZipListçš„å†…å­˜å ç”¨ä¸èƒ½è¶…è¿‡8kb</li><li>-3ï¼šæ¯ä¸ªZipListçš„å†…å­˜å ç”¨ä¸èƒ½è¶…è¿‡16kb</li><li>-4ï¼šæ¯ä¸ªZipListçš„å†…å­˜å ç”¨ä¸èƒ½è¶…è¿‡32kb</li><li>-5ï¼šæ¯ä¸ªZipListçš„å†…å­˜å ç”¨ä¸èƒ½è¶…è¿‡64kb</li></ul><p>å…¶é»˜è®¤å€¼ä¸º -2ï¼š</p><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior31.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>ä»¥ä¸‹æ˜¯QuickListçš„å’ŒQuickListNodeçš„ç»“æ„æºç ï¼š</p><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior32.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>æˆ‘ä»¬æ¥ä¸‹æ¥ç”¨ä¸€æ®µæµç¨‹å›¾æ¥æè¿°å½“å‰çš„è¿™ä¸ªç»“æ„</p><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior33.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p><strong>QuickListç‰¹ç‚¹æ€»ç»“</strong></p><ul><li>æ˜¯ä¸€ä¸ªèŠ‚ç‚¹ä¸ºZipListçš„åŒç«¯é“¾è¡¨</li><li>èŠ‚ç‚¹é‡‡ç”¨ZipListï¼Œè§£å†³äº†ä¼ ç»Ÿé“¾è¡¨çš„å†…å­˜å ç”¨é—®é¢˜</li><li>æ§åˆ¶äº†ZipListå¤§å°ï¼Œè§£å†³è¿ç»­å†…å­˜ç©ºé—´ç”³è¯·æ•ˆç‡é—®é¢˜</li><li>ä¸­é—´èŠ‚ç‚¹å¯ä»¥å‹ç¼©ï¼Œè¿›ä¸€æ­¥èŠ‚çœäº†å†…å­˜</li></ul><h3 id="skiplist" tabindex="-1"><a class="header-anchor" href="#skiplist"><span>SkipList</span></a></h3><p>SkipListï¼ˆè·³è¡¨ï¼‰é¦–å…ˆæ˜¯é“¾è¡¨ï¼Œä½†ä¸ä¼ ç»Ÿé“¾è¡¨ç›¸æ¯”æœ‰å‡ ç‚¹å·®å¼‚ï¼š<br> å…ƒç´ æŒ‰ç…§å‡åºæ’åˆ—å­˜å‚¨<br> èŠ‚ç‚¹å¯èƒ½åŒ…å«å¤šä¸ªæŒ‡é’ˆï¼ŒæŒ‡é’ˆè·¨åº¦ä¸åŒã€‚</p><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior34.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>SkipListï¼ˆè·³è¡¨ï¼‰é¦–å…ˆæ˜¯é“¾è¡¨ï¼Œä½†ä¸ä¼ ç»Ÿé“¾è¡¨ç›¸æ¯”æœ‰å‡ ç‚¹å·®å¼‚ï¼š<br> å…ƒç´ æŒ‰ç…§å‡åºæ’åˆ—å­˜å‚¨<br> èŠ‚ç‚¹å¯èƒ½åŒ…å«å¤šä¸ªæŒ‡é’ˆï¼ŒæŒ‡é’ˆè·¨åº¦ä¸åŒã€‚</p><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior35.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>SkipListï¼ˆè·³è¡¨ï¼‰é¦–å…ˆæ˜¯é“¾è¡¨ï¼Œä½†ä¸ä¼ ç»Ÿé“¾è¡¨ç›¸æ¯”æœ‰å‡ ç‚¹å·®å¼‚ï¼š<br> å…ƒç´ æŒ‰ç…§å‡åºæ’åˆ—å­˜å‚¨<br> èŠ‚ç‚¹å¯èƒ½åŒ…å«å¤šä¸ªæŒ‡é’ˆï¼ŒæŒ‡é’ˆè·¨åº¦ä¸åŒã€‚</p><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior36.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p><strong>SkipListçš„ç‰¹ç‚¹æ€»ç»“</strong></p><ul><li>è·³è·ƒè¡¨æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½åŒ…å«scoreå’Œeleå€¼</li><li>èŠ‚ç‚¹æŒ‰ç…§scoreå€¼æ’åºï¼Œscoreå€¼ä¸€æ ·åˆ™æŒ‰ç…§eleå­—å…¸æ’åº</li><li>æ¯ä¸ªèŠ‚ç‚¹éƒ½å¯ä»¥åŒ…å«å¤šå±‚æŒ‡é’ˆï¼Œå±‚æ•°æ˜¯1åˆ°32ä¹‹é—´çš„éšæœºæ•°</li><li>ä¸åŒå±‚æŒ‡é’ˆåˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„è·¨åº¦ä¸åŒï¼Œå±‚çº§è¶Šé«˜ï¼Œè·¨åº¦è¶Šå¤§</li><li>å¢åˆ æ”¹æŸ¥æ•ˆç‡ä¸çº¢é»‘æ ‘åŸºæœ¬ä¸€è‡´ï¼Œå®ç°å´æ›´ç®€å•</li></ul><h3 id="redisobject" tabindex="-1"><a class="header-anchor" href="#redisobject"><span>RedisObject</span></a></h3><p>Redisä¸­çš„ä»»æ„æ•°æ®ç±»å‹çš„é”®å’Œå€¼éƒ½ä¼šè¢«å°è£…ä¸ºä¸€ä¸ªRedisObjectï¼Œä¹Ÿå«åšRediså¯¹è±¡ï¼Œæºç å¦‚ä¸‹ï¼š</p><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior37.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p><strong>ä»€ä¹ˆæ˜¯redisObjectï¼Ÿ</strong><br> ä»Redisçš„ä½¿ç”¨è€…çš„è§’åº¦æ¥çœ‹ï¼Œâ¼€ä¸ªRedisèŠ‚ç‚¹åŒ…å«å¤šä¸ªdatabaseï¼ˆéclusteræ¨¡å¼ä¸‹é»˜è®¤æ˜¯16ä¸ªï¼Œclusteræ¨¡å¼ä¸‹åªèƒ½æ˜¯1ä¸ªï¼‰ï¼Œè€Œä¸€ä¸ªdatabaseç»´æŠ¤äº†ä»key spaceåˆ°object spaceçš„æ˜ å°„å…³ç³»ã€‚è¿™ä¸ªæ˜ å°„å…³ç³»çš„keyæ˜¯stringç±»å‹ï¼Œâ½½valueå¯ä»¥æ˜¯å¤šç§æ•°æ®ç±»å‹ï¼Œæ¯”å¦‚ï¼š<br> string, list, hashã€setã€sorted setç­‰ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œkeyçš„ç±»å‹å›ºå®šæ˜¯stringï¼Œè€Œvalueå¯èƒ½çš„ç±»å‹æ˜¯å¤šä¸ªã€‚<br> â½½ä»Rediså†…éƒ¨å®ç°çš„â¾“åº¦æ¥çœ‹ï¼Œdatabaseå†…çš„è¿™ä¸ªæ˜ å°„å…³ç³»æ˜¯ç”¨â¼€ä¸ªdictæ¥ç»´æŠ¤çš„ã€‚dictçš„keyå›ºå®šç”¨â¼€ç§æ•°æ®ç»“æ„æ¥è¡¨è¾¾å°±å¤Ÿäº†ï¼Œè¿™å°±æ˜¯åŠ¨æ€å­—ç¬¦ä¸²sdsã€‚è€Œvalueåˆ™æ¯”è¾ƒå¤æ‚ï¼Œä¸ºäº†åœ¨åŒâ¼€ä¸ªdictå†…èƒ½å¤Ÿå­˜å‚¨ä¸åŒç±»å‹çš„valueï¼Œè¿™å°±éœ€è¦â¼€ä¸ªé€šâ½¤çš„æ•°æ®ç»“æ„ï¼Œè¿™ä¸ªé€šç”¨çš„æ•°æ®ç»“æ„å°±æ˜¯robjï¼Œå…¨åæ˜¯redisObjectã€‚</p><p><strong>Redisçš„ç¼–ç æ–¹å¼</strong></p><p>Redisä¸­ä¼šæ ¹æ®å­˜å‚¨çš„æ•°æ®ç±»å‹ä¸åŒï¼Œé€‰æ‹©ä¸åŒçš„ç¼–ç æ–¹å¼ï¼Œå…±åŒ…å«11ç§ä¸åŒç±»å‹ï¼š</p><table><thead><tr><th><strong>ç¼–å·</strong></th><th><strong>ç¼–ç æ–¹å¼</strong></th><th><strong>è¯´æ˜</strong></th></tr></thead><tbody><tr><td>0</td><td>OBJ_ENCODING_RAW</td><td>rawç¼–ç åŠ¨æ€å­—ç¬¦ä¸²</td></tr><tr><td>1</td><td>OBJ_ENCODING_INT</td><td>longç±»å‹çš„æ•´æ•°çš„å­—ç¬¦ä¸²</td></tr><tr><td>2</td><td>OBJ_ENCODING_HT</td><td>hashè¡¨ï¼ˆå­—å…¸dictï¼‰</td></tr><tr><td>3</td><td>OBJ_ENCODING_ZIPMAP</td><td>å·²åºŸå¼ƒ</td></tr><tr><td>4</td><td>OBJ_ENCODING_LINKEDLIST</td><td>åŒç«¯é“¾è¡¨</td></tr><tr><td>5</td><td>OBJ_ENCODING_ZIPLIST</td><td>å‹ç¼©åˆ—è¡¨</td></tr><tr><td>6</td><td>OBJ_ENCODING_INTSET</td><td>æ•´æ•°é›†åˆ</td></tr><tr><td>7</td><td>OBJ_ENCODING_SKIPLIST</td><td>è·³è¡¨</td></tr><tr><td>8</td><td>OBJ_ENCODING_EMBSTR</td><td>embstrçš„åŠ¨æ€å­—ç¬¦ä¸²</td></tr><tr><td>9</td><td>OBJ_ENCODING_QUICKLIST</td><td>å¿«é€Ÿåˆ—è¡¨</td></tr><tr><td>10</td><td>OBJ_ENCODING_STREAM</td><td>Streamæµ</td></tr></tbody></table><p><strong>äº”ç§æ•°æ®ç»“æ„</strong></p><p>Redisä¸­ä¼šæ ¹æ®å­˜å‚¨çš„æ•°æ®ç±»å‹ä¸åŒï¼Œé€‰æ‹©ä¸åŒçš„ç¼–ç æ–¹å¼ã€‚æ¯ç§æ•°æ®ç±»å‹çš„ä½¿ç”¨çš„ç¼–ç æ–¹å¼å¦‚ä¸‹ï¼š</p><table><thead><tr><th><strong>æ•°æ®ç±»å‹</strong></th><th><strong>ç¼–ç æ–¹å¼</strong></th></tr></thead><tbody><tr><td>OBJ_STRING</td><td>intã€embstrã€raw</td></tr><tr><td>OBJ_LIST</td><td>LinkedListå’ŒZipList(3.2ä»¥å‰)ã€QuickListï¼ˆ3.2ä»¥åï¼‰</td></tr><tr><td>OBJ_SET</td><td>intsetã€HT</td></tr><tr><td>OBJ_ZSET</td><td>ZipListã€HTã€SkipList</td></tr><tr><td>OBJ_HASH</td><td>ZipListã€HT</td></tr></tbody></table><h3 id="string" tabindex="-1"><a class="header-anchor" href="#string"><span>String</span></a></h3><p>Stringæ˜¯Redisä¸­æœ€å¸¸è§çš„æ•°æ®å­˜å‚¨ç±»å‹ï¼š</p><p>å…¶åŸºæœ¬ç¼–ç æ–¹å¼æ˜¯RAWï¼ŒåŸºäºç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆSDSï¼‰å®ç°ï¼Œå­˜å‚¨ä¸Šé™ä¸º512mbã€‚</p><p>å¦‚æœå­˜å‚¨çš„SDSé•¿åº¦å°äº44å­—èŠ‚ï¼Œåˆ™ä¼šé‡‡ç”¨EMBSTRç¼–ç ï¼Œæ­¤æ—¶object headä¸SDSæ˜¯ä¸€æ®µè¿ç»­ç©ºé—´ã€‚ç”³è¯·å†…å­˜æ—¶</p><p>åªéœ€è¦è°ƒç”¨ä¸€æ¬¡å†…å­˜åˆ†é…å‡½æ•°ï¼Œæ•ˆç‡æ›´é«˜ã€‚</p><p>ï¼ˆ1ï¼‰åº•å±‚å®ç°â½…å¼ï¼šåŠ¨æ€å­—ç¬¦ä¸²sds æˆ–è€… long<br> Stringçš„å†…éƒ¨å­˜å‚¨ç»“æ„â¼€èˆ¬æ˜¯sdsï¼ˆSimple Dynamic Stringï¼Œå¯ä»¥åŠ¨æ€æ‰©å±•å†…å­˜ï¼‰ï¼Œä½†æ˜¯å¦‚æœâ¼€ä¸ªStringç±»å‹çš„valueçš„å€¼æ˜¯æ•°å­—ï¼Œé‚£ä¹ˆRediså†…éƒ¨ä¼šæŠŠå®ƒè½¬æˆlongç±»å‹æ¥å­˜å‚¨ï¼Œä»â½½å‡å°‘å†…å­˜çš„ä½¿ç”¨ã€‚</p><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior38.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>å¦‚æœå­˜å‚¨çš„å­—ç¬¦ä¸²æ˜¯æ•´æ•°å€¼ï¼Œå¹¶ä¸”å¤§å°åœ¨LONG_MAXèŒƒå›´å†…ï¼Œåˆ™ä¼šé‡‡ç”¨INTç¼–ç ï¼šç›´æ¥å°†æ•°æ®ä¿å­˜åœ¨RedisObjectçš„ptræŒ‡é’ˆä½ç½®ï¼ˆåˆšå¥½8å­—èŠ‚ï¼‰ï¼Œä¸å†éœ€è¦SDSäº†ã€‚</p><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior39.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior40.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior41.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>ç¡®åˆ‡åœ°è¯´ï¼ŒStringåœ¨Redisä¸­æ˜¯â½¤â¼€ä¸ªrobjæ¥è¡¨ç¤ºçš„ã€‚</p><p>ç”¨æ¥è¡¨ç¤ºStringçš„robjå¯èƒ½ç¼–ç æˆ3ç§å†…éƒ¨è¡¨â½°ï¼šOBJ_ENCODING_RAWï¼ŒOBJ_ENCODING_EMBSTRï¼ŒOBJ_ENCODING_INTã€‚<br> å…¶ä¸­å‰ä¸¤ç§ç¼–ç ä½¿â½¤çš„æ˜¯sdsæ¥å­˜å‚¨ï¼Œæœ€åâ¼€ç§OBJ_ENCODING_INTç¼–ç ç›´æ¥æŠŠstringå­˜æˆäº†longå‹ã€‚<br> åœ¨å¯¹stringè¿›è¡Œincr, decrç­‰æ“ä½œçš„æ—¶å€™ï¼Œå¦‚æœå®ƒå†…éƒ¨æ˜¯OBJ_ENCODING_INTç¼–ç ï¼Œé‚£ä¹ˆå¯ä»¥ç›´æ¥è¡ŒåŠ å‡æ“ä½œï¼›å¦‚æœå®ƒå†…éƒ¨æ˜¯OBJ_ENCODING_RAWæˆ–OBJ_ENCODING_EMBSTRç¼–ç ï¼Œé‚£ä¹ˆRedisä¼šå…ˆè¯•å›¾æŠŠsdså­˜å‚¨çš„å­—ç¬¦ä¸²è½¬æˆlongå‹ï¼Œå¦‚æœèƒ½è½¬æˆåŠŸï¼Œå†è¿›è¡ŒåŠ å‡æ“ä½œã€‚å¯¹â¼€ä¸ªå†…éƒ¨è¡¨ç¤ºæˆlongå‹çš„stringæ‰§è¡Œappend, setbit, getrangeè¿™äº›å‘½ä»¤ï¼Œé’ˆå¯¹çš„ä»ç„¶æ˜¯stringçš„å€¼ï¼ˆå³â¼—è¿›åˆ¶è¡¨ç¤ºçš„å­—ç¬¦ä¸²ï¼‰ï¼Œè€Œä¸æ˜¯é’ˆå¯¹å†…éƒ¨è¡¨â½°çš„longå‹è¿›â¾æ“ä½œã€‚æ¯”å¦‚å­—ç¬¦ä¸²â€32â€ï¼Œå¦‚æœæŒ‰ç…§å­—ç¬¦æ•°ç»„æ¥è§£é‡Šï¼Œå®ƒåŒ…å«ä¸¤ä¸ªå­—ç¬¦ï¼Œå®ƒä»¬çš„ASCIIç åˆ†åˆ«æ˜¯0x33å’Œ0x32ã€‚å½“æˆ‘ä»¬æ‰§è¡Œå‘½ä»¤setbit key 7 0çš„æ—¶å€™ï¼Œç›¸å½“äºæŠŠå­—ç¬¦0x33å˜æˆäº†0x32ï¼Œè¿™æ ·å­—ç¬¦ä¸²çš„å€¼å°±å˜æˆäº†â€22â€ã€‚â½½å¦‚æœå°†å­—ç¬¦ä¸²â€32â€æŒ‰ç…§å†…éƒ¨çš„64ä½longå‹æ¥è§£é‡Šï¼Œé‚£ä¹ˆå®ƒæ˜¯0x0000000000000020ï¼Œåœ¨è¿™ä¸ªåŸºç¡€ä¸Šæ‰§â¾setbitä½æ“ä½œï¼Œç»“æœå°±å®Œå…¨ä¸å¯¹äº†ã€‚å› æ­¤ï¼Œåœ¨è¿™äº›å‘½ä»¤çš„å®ç°ä¸­ï¼Œä¼šæŠŠlongå‹å…ˆè½¬æˆå­—ç¬¦ä¸²å†è¿›è¡Œç›¸åº”çš„æ“ä½œã€‚</p><h3 id="list" tabindex="-1"><a class="header-anchor" href="#list"><span>List</span></a></h3><p>Redisçš„Listç±»å‹å¯ä»¥ä»é¦–ã€å°¾æ“ä½œåˆ—è¡¨ä¸­çš„å…ƒç´ ï¼š</p><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior42.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>å“ªä¸€ä¸ªæ•°æ®ç»“æ„èƒ½æ»¡è¶³ä¸Šè¿°ç‰¹å¾ï¼Ÿ</p><ul><li>LinkedList ï¼šæ™®é€šé“¾è¡¨ï¼Œå¯ä»¥ä»åŒç«¯è®¿é—®ï¼Œå†…å­˜å ç”¨è¾ƒé«˜ï¼Œå†…å­˜ç¢ç‰‡è¾ƒå¤š</li><li>ZipList ï¼šå‹ç¼©åˆ—è¡¨ï¼Œå¯ä»¥ä»åŒç«¯è®¿é—®ï¼Œå†…å­˜å ç”¨ä½ï¼Œå­˜å‚¨ä¸Šé™ä½</li><li>QuickListï¼šLinkedList + ZipListï¼Œå¯ä»¥ä»åŒç«¯è®¿é—®ï¼Œå†…å­˜å ç”¨è¾ƒä½ï¼ŒåŒ…å«å¤šä¸ªZipListï¼Œå­˜å‚¨ä¸Šé™é«˜</li></ul><p>Redisçš„Listç»“æ„ç±»ä¼¼ä¸€ä¸ªåŒç«¯é“¾è¡¨ï¼Œå¯ä»¥ä»é¦–ã€å°¾æ“ä½œåˆ—è¡¨ä¸­çš„å…ƒç´ ï¼š</p><p>åœ¨3.2ç‰ˆæœ¬ä¹‹å‰ï¼ŒRedisé‡‡ç”¨ZipListå’ŒLinkedListæ¥å®ç°Listï¼Œå½“å…ƒç´ æ•°é‡å°äº512å¹¶ä¸”å…ƒç´ å¤§å°å°äº64å­—èŠ‚æ—¶é‡‡ç”¨ZipListç¼–ç ï¼Œè¶…è¿‡åˆ™é‡‡ç”¨LinkedListç¼–ç ã€‚</p><p>åœ¨3.2ç‰ˆæœ¬ä¹‹åï¼ŒRedisç»Ÿä¸€é‡‡ç”¨QuickListæ¥å®ç°Listï¼š</p><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior43.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="set" tabindex="-1"><a class="header-anchor" href="#set"><span>Set</span></a></h3><p>Setæ˜¯Redisä¸­çš„å•åˆ—é›†åˆï¼Œæ»¡è¶³ä¸‹åˆ—ç‰¹ç‚¹ï¼š</p><ul><li>ä¸ä¿è¯æœ‰åºæ€§</li><li>ä¿è¯å…ƒç´ å”¯ä¸€</li><li>æ±‚äº¤é›†ã€å¹¶é›†ã€å·®é›†</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior44.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>å¯ä»¥çœ‹å‡ºï¼ŒSetå¯¹æŸ¥è¯¢å…ƒç´ çš„æ•ˆç‡è¦æ±‚éå¸¸é«˜ï¼Œæ€è€ƒä¸€ä¸‹ï¼Œä»€ä¹ˆæ ·çš„æ•°æ®ç»“æ„å¯ä»¥æ»¡è¶³ï¼Ÿ<br> HashTableï¼Œä¹Ÿå°±æ˜¯Redisä¸­çš„Dictï¼Œä¸è¿‡Dictæ˜¯åŒåˆ—é›†åˆï¼ˆå¯ä»¥å­˜é”®ã€å€¼å¯¹ï¼‰</p><p>Setæ˜¯Redisä¸­çš„é›†åˆï¼Œä¸ä¸€å®šç¡®ä¿å…ƒç´ æœ‰åºï¼Œå¯ä»¥æ»¡è¶³å…ƒç´ å”¯ä¸€ã€æŸ¥è¯¢æ•ˆç‡è¦æ±‚æé«˜ã€‚<br> ä¸ºäº†æŸ¥è¯¢æ•ˆç‡å’Œå”¯ä¸€æ€§ï¼Œseté‡‡ç”¨HTç¼–ç ï¼ˆDictï¼‰ã€‚Dictä¸­çš„keyç”¨æ¥å­˜å‚¨å…ƒç´ ï¼Œvalueç»Ÿä¸€ä¸ºnullã€‚<br> å½“å­˜å‚¨çš„æ‰€æœ‰æ•°æ®éƒ½æ˜¯æ•´æ•°ï¼Œå¹¶ä¸”å…ƒç´ æ•°é‡ä¸è¶…è¿‡set-max-intset-entriesæ—¶ï¼ŒSetä¼šé‡‡ç”¨IntSetç¼–ç ï¼Œä»¥èŠ‚çœå†…å­˜</p><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior45.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>ç»“æ„å¦‚ä¸‹ï¼š</p><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior46.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="zset" tabindex="-1"><a class="header-anchor" href="#zset"><span>ZSET</span></a></h3><p>ZSetä¹Ÿå°±æ˜¯SortedSetï¼Œå…¶ä¸­æ¯ä¸€ä¸ªå…ƒç´ éƒ½éœ€è¦æŒ‡å®šä¸€ä¸ªscoreå€¼å’Œmemberå€¼ï¼š</p><ul><li>å¯ä»¥æ ¹æ®scoreå€¼æ’åºå</li><li>memberå¿…é¡»å”¯ä¸€</li><li>å¯ä»¥æ ¹æ®memberæŸ¥è¯¢åˆ†æ•°</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior47.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>å› æ­¤ï¼Œzsetåº•å±‚æ•°æ®ç»“æ„å¿…é¡»æ»¡è¶³é”®å€¼å­˜å‚¨ã€é”®å¿…é¡»å”¯ä¸€ã€å¯æ’åºè¿™å‡ ä¸ªéœ€æ±‚ã€‚ä¹‹å‰å­¦ä¹ çš„å“ªç§ç¼–ç ç»“æ„å¯ä»¥æ»¡è¶³ï¼Ÿ</p><ul><li>SkipListï¼šå¯ä»¥æ’åºï¼Œå¹¶ä¸”å¯ä»¥åŒæ—¶å­˜å‚¨scoreå’Œeleå€¼ï¼ˆmemberï¼‰</li><li>HTï¼ˆDictï¼‰ï¼šå¯ä»¥é”®å€¼å­˜å‚¨ï¼Œå¹¶ä¸”å¯ä»¥æ ¹æ®keyæ‰¾value</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior48.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior49.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>å½“å…ƒç´ æ•°é‡ä¸å¤šæ—¶ï¼ŒHTå’ŒSkipListçš„ä¼˜åŠ¿ä¸æ˜æ˜¾ï¼Œè€Œä¸”æ›´è€—å†…å­˜ã€‚å› æ­¤zsetè¿˜ä¼šé‡‡ç”¨ZipListç»“æ„æ¥èŠ‚çœå†…å­˜ï¼Œä¸è¿‡éœ€è¦åŒæ—¶æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼š</p><ul><li>å…ƒç´ æ•°é‡å°äºzset_max_ziplist_entriesï¼Œé»˜è®¤å€¼128</li><li>æ¯ä¸ªå…ƒç´ éƒ½å°äºzset_max_ziplist_valueå­—èŠ‚ï¼Œé»˜è®¤å€¼64</li></ul><p>ziplistæœ¬èº«æ²¡æœ‰æ’åºåŠŸèƒ½ï¼Œè€Œä¸”æ²¡æœ‰é”®å€¼å¯¹çš„æ¦‚å¿µï¼Œå› æ­¤éœ€è¦æœ‰zseté€šè¿‡ç¼–ç å®ç°ï¼š</p><ul><li>ZipListæ˜¯è¿ç»­å†…å­˜ï¼Œå› æ­¤scoreå’Œelementæ˜¯ç´§æŒ¨åœ¨ä¸€èµ·çš„ä¸¤ä¸ªentryï¼Œ elementåœ¨å‰ï¼Œscoreåœ¨å</li><li>scoreè¶Šå°è¶Šæ¥è¿‘é˜Ÿé¦–ï¼Œscoreè¶Šå¤§è¶Šæ¥è¿‘é˜Ÿå°¾ï¼ŒæŒ‰ç…§scoreå€¼å‡åºæ’åˆ—</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior50.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior51.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="hash" tabindex="-1"><a class="header-anchor" href="#hash"><span>Hash</span></a></h3><p>Hashç»“æ„ä¸Redisä¸­çš„Zsetéå¸¸ç±»ä¼¼ï¼š</p><ul><li>éƒ½æ˜¯é”®å€¼å­˜å‚¨</li><li>éƒ½éœ€æ±‚æ ¹æ®é”®è·å–å€¼</li><li>é”®å¿…é¡»å”¯ä¸€</li></ul><p>åŒºåˆ«å¦‚ä¸‹ï¼š</p><ul><li>zsetçš„é”®æ˜¯memberï¼Œå€¼æ˜¯scoreï¼›hashçš„é”®å’Œå€¼éƒ½æ˜¯ä»»æ„å€¼</li><li>zsetè¦æ ¹æ®scoreæ’åºï¼›hashåˆ™æ— éœ€æ’åº</li></ul><p>ï¼ˆ1ï¼‰åº•å±‚å®ç°æ–¹å¼ï¼šå‹ç¼©åˆ—è¡¨ziplist æˆ–è€… å­—å…¸dict<br> å½“Hashä¸­æ•°æ®é¡¹æ¯”è¾ƒå°‘çš„æƒ…å†µä¸‹ï¼ŒHashåº•å±‚æ‰â½¤å‹ç¼©åˆ—è¡¨ziplistè¿›â¾å­˜å‚¨æ•°æ®ï¼Œéšç€æ•°æ®çš„å¢åŠ ï¼Œåº•å±‚çš„ziplistå°±å¯èƒ½ä¼šè½¬æˆdictï¼Œå…·ä½“é…ç½®å¦‚ä¸‹ï¼š</p><p>hash-max-ziplist-entries 512</p><p>hash-max-ziplist-value 64</p><p>å½“æ»¡è¶³ä¸Šé¢ä¸¤ä¸ªæ¡ä»¶å…¶ä¸­ä¹‹â¼€çš„æ—¶å€™ï¼ŒRediså°±ä½¿â½¤dictå­—å…¸æ¥å®ç°hashã€‚<br> Redisçš„hashä¹‹æ‰€ä»¥è¿™æ ·è®¾è®¡ï¼Œæ˜¯å› ä¸ºå½“ziplistå˜å¾—å¾ˆâ¼¤çš„æ—¶å€™ï¼Œå®ƒæœ‰å¦‚ä¸‹å‡ ä¸ªç¼ºç‚¹ï¼š</p><ul><li>æ¯æ¬¡æ’â¼Šæˆ–ä¿®æ”¹å¼•å‘çš„reallocæ“ä½œä¼šæœ‰æ›´â¼¤çš„æ¦‚ç‡é€ æˆå†…å­˜æ‹·è´ï¼Œä»è€Œé™ä½æ€§èƒ½ã€‚</li><li>â¼€æ—¦å‘ç”Ÿå†…å­˜æ‹·è´ï¼Œå†…å­˜æ‹·è´çš„æˆæœ¬ä¹Ÿç›¸åº”å¢åŠ ï¼Œå› ä¸ºè¦æ‹·è´æ›´â¼¤çš„â¼€å—æ•°æ®ã€‚</li><li>å½“ziplistæ•°æ®é¡¹è¿‡å¤šçš„æ—¶å€™ï¼Œåœ¨å®ƒä¸Šâ¾¯æŸ¥æ‰¾æŒ‡å®šçš„æ•°æ®é¡¹å°±ä¼šæ€§èƒ½å˜å¾—å¾ˆä½ï¼Œå› ä¸ºziplistä¸Šçš„æŸ¥æ‰¾éœ€è¦è¿›è¡Œéå†ã€‚</li></ul><p>æ€»ä¹‹ï¼Œziplistæœ¬æ¥å°±è®¾è®¡ä¸ºå„ä¸ªæ•°æ®é¡¹æŒ¨åœ¨â¼€èµ·ç»„æˆè¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œè¿™ç§ç»“æ„å¹¶ä¸æ“…é•¿åšä¿®æ”¹æ“ä½œã€‚â¼€æ—¦æ•°æ®å‘â½£æ”¹åŠ¨ï¼Œå°±ä¼šå¼•å‘å†…å­˜reallocï¼Œå¯èƒ½å¯¼è‡´å†…å­˜æ‹·è´ã€‚</p><p>hashç»“æ„å¦‚ä¸‹ï¼š</p><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior52.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>zseté›†åˆå¦‚ä¸‹ï¼š</p><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior53.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>å› æ­¤ï¼ŒHashåº•å±‚é‡‡ç”¨çš„ç¼–ç ä¸Zsetä¹ŸåŸºæœ¬ä¸€è‡´ï¼Œåªéœ€è¦æŠŠæ’åºæœ‰å…³çš„SkipListå»æ‰å³å¯ï¼š</p><p>Hashç»“æ„é»˜è®¤é‡‡ç”¨ZipListç¼–ç ï¼Œç”¨ä»¥èŠ‚çœå†…å­˜ã€‚ ZipListä¸­ç›¸é‚»çš„ä¸¤ä¸ªentry åˆ†åˆ«ä¿å­˜fieldå’Œvalue</p><p>å½“æ•°æ®é‡è¾ƒå¤§æ—¶ï¼ŒHashç»“æ„ä¼šè½¬ä¸ºHTç¼–ç ï¼Œä¹Ÿå°±æ˜¯Dictï¼Œè§¦å‘æ¡ä»¶æœ‰ä¸¤ä¸ªï¼š</p><ul><li>ZipListä¸­çš„å…ƒç´ æ•°é‡è¶…è¿‡äº†hash-max-ziplist-entriesï¼ˆé»˜è®¤512ï¼‰</li><li>ZipListä¸­çš„ä»»æ„entryå¤§å°è¶…è¿‡äº†hash-max-ziplist-valueï¼ˆé»˜è®¤64å­—èŠ‚ï¼‰</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior54.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="redisç½‘ç»œæ¨¡å‹" tabindex="-1"><a class="header-anchor" href="#redisç½‘ç»œæ¨¡å‹"><span>Redisç½‘ç»œæ¨¡å‹</span></a></h2><h3 id="ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸æ€ç©ºé—´" tabindex="-1"><a class="header-anchor" href="#ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸æ€ç©ºé—´"><span>ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸æ€ç©ºé—´</span></a></h3><p>æœåŠ¡å™¨å¤§å¤šéƒ½é‡‡ç”¨Linuxç³»ç»Ÿï¼Œè¿™é‡Œæˆ‘ä»¬ä»¥Linuxä¸ºä¾‹æ¥è®²è§£:</p><p>ubuntuå’ŒCentos éƒ½æ˜¯Linuxçš„å‘è¡Œç‰ˆï¼Œå‘è¡Œç‰ˆå¯ä»¥çœ‹æˆå¯¹linuxåŒ…äº†ä¸€å±‚å£³ï¼Œä»»ä½•Linuxå‘è¡Œç‰ˆï¼Œå…¶ç³»ç»Ÿå†…æ ¸éƒ½æ˜¯Linuxã€‚æˆ‘ä»¬çš„åº”ç”¨éƒ½éœ€è¦é€šè¿‡Linuxå†…æ ¸ä¸ç¡¬ä»¶äº¤äº’</p><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior55.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>ç”¨æˆ·çš„åº”ç”¨ï¼Œæ¯”å¦‚redisï¼Œmysqlç­‰å…¶å®æ˜¯æ²¡æœ‰åŠæ³•å»æ‰§è¡Œè®¿é—®æˆ‘ä»¬æ“ä½œç³»ç»Ÿçš„ç¡¬ä»¶çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡å‘è¡Œç‰ˆçš„è¿™ä¸ªå£³å­å»è®¿é—®å†…æ ¸ï¼Œå†é€šè¿‡å†…æ ¸å»è®¿é—®è®¡ç®—æœºç¡¬ä»¶</p><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior56.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>è®¡ç®—æœºç¡¬ä»¶åŒ…æ‹¬ï¼Œå¦‚cpuï¼Œå†…å­˜ï¼Œç½‘å¡ç­‰ç­‰ï¼Œå†…æ ¸ï¼ˆé€šè¿‡å¯»å€ç©ºé—´ï¼‰å¯ä»¥æ“ä½œç¡¬ä»¶çš„ï¼Œä½†æ˜¯å†…æ ¸éœ€è¦ä¸åŒè®¾å¤‡çš„é©±åŠ¨ï¼Œæœ‰äº†è¿™äº›é©±åŠ¨ä¹‹åï¼Œå†…æ ¸å°±å¯ä»¥å»å¯¹è®¡ç®—æœºç¡¬ä»¶å»è¿›è¡Œ å†…å­˜ç®¡ç†ï¼Œæ–‡ä»¶ç³»ç»Ÿçš„ç®¡ç†ï¼Œè¿›ç¨‹çš„ç®¡ç†ç­‰ç­‰</p><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior57.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>æˆ‘ä»¬æƒ³è¦ç”¨æˆ·çš„åº”ç”¨æ¥è®¿é—®ï¼Œè®¡ç®—æœºå°±å¿…é¡»è¦é€šè¿‡å¯¹å¤–æš´éœ²çš„ä¸€äº›æ¥å£ï¼Œæ‰èƒ½è®¿é—®åˆ°ï¼Œä»è€Œç®€ä»‹çš„å®ç°å¯¹å†…æ ¸çš„æ“æ§ï¼Œä½†æ˜¯å†…æ ¸æœ¬èº«ä¸Šæ¥è¯´ä¹Ÿæ˜¯ä¸€ä¸ªåº”ç”¨ï¼Œæ‰€ä»¥ä»–æœ¬èº«ä¹Ÿéœ€è¦ä¸€äº›å†…å­˜ï¼Œcpuç­‰è®¾å¤‡èµ„æºï¼Œç”¨æˆ·åº”ç”¨æœ¬èº«ä¹Ÿåœ¨æ¶ˆè€—è¿™äº›èµ„æºï¼Œå¦‚æœä¸åŠ ä»»ä½•é™åˆ¶ï¼Œç”¨æˆ·å»æ“ä½œéšæ„çš„å»æ“ä½œæˆ‘ä»¬çš„èµ„æºï¼Œå°±æœ‰å¯èƒ½å¯¼è‡´ä¸€äº›å†²çªï¼Œç”šè‡³æœ‰å¯èƒ½å¯¼è‡´æˆ‘ä»¬çš„ç³»ç»Ÿå‡ºç°æ— æ³•è¿è¡Œçš„é—®é¢˜ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æŠŠç”¨æˆ·å’Œ<strong>å†…æ ¸éš”ç¦»å¼€</strong></p><p>è¿›ç¨‹çš„å¯»å€ç©ºé—´åˆ’åˆ†æˆä¸¤éƒ¨åˆ†ï¼š<strong>å†…æ ¸ç©ºé—´ã€ç”¨æˆ·ç©ºé—´</strong></p><p>ä»€ä¹ˆæ˜¯å¯»å€ç©ºé—´å‘¢ï¼Ÿæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¹Ÿå¥½ï¼Œè¿˜æ˜¯å†…æ ¸ç©ºé—´ä¹Ÿå¥½ï¼Œéƒ½æ˜¯æ²¡æœ‰åŠæ³•ç›´æ¥å»ç‰©ç†å†…å­˜çš„ï¼Œè€Œæ˜¯é€šè¿‡åˆ†é…ä¸€äº›è™šæ‹Ÿå†…å­˜æ˜ å°„åˆ°ç‰©ç†å†…å­˜ä¸­ï¼Œæˆ‘ä»¬çš„å†…æ ¸å’Œåº”ç”¨ç¨‹åºå»è®¿é—®è™šæ‹Ÿå†…å­˜çš„æ—¶å€™ï¼Œå°±éœ€è¦ä¸€ä¸ªè™šæ‹Ÿåœ°å€ï¼Œè¿™ä¸ªåœ°å€æ˜¯ä¸€ä¸ªæ— ç¬¦å·çš„æ•´æ•°ï¼Œæ¯”å¦‚ä¸€ä¸ª32ä½çš„æ“ä½œç³»ç»Ÿï¼Œä»–çš„å¸¦å®½å°±æ˜¯32ï¼Œä»–çš„è™šæ‹Ÿåœ°å€å°±æ˜¯2çš„32æ¬¡æ–¹ï¼Œä¹Ÿå°±æ˜¯è¯´ä»–å¯»å€çš„èŒƒå›´å°±æ˜¯0~2çš„32æ¬¡æ–¹ï¼Œ è¿™ç‰‡å¯»å€ç©ºé—´å¯¹åº”çš„å°±æ˜¯2çš„32ä¸ªå­—èŠ‚ï¼Œå°±æ˜¯4GBï¼Œè¿™ä¸ª4GBï¼Œä¼šæœ‰3ä¸ªGBåˆ†ç»™ç”¨æˆ·ç©ºé—´ï¼Œä¼šæœ‰1GBç»™å†…æ ¸ç³»ç»Ÿ</p><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior58.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>åœ¨Linuxä¸­ï¼Œæƒé™åˆ†æˆä¸¤ä¸ªç­‰çº§ï¼Œ0å’Œ3ï¼Œç”¨æˆ·ç©ºé—´åªèƒ½æ‰§è¡Œå—é™çš„å‘½ä»¤ï¼ˆRing3ï¼‰ï¼Œè€Œä¸”ä¸èƒ½ç›´æ¥è°ƒç”¨ç³»ç»Ÿèµ„æºï¼Œå¿…é¡»é€šè¿‡å†…æ ¸æä¾›çš„æ¥å£æ¥è®¿é—®å†…æ ¸ç©ºé—´å¯ä»¥æ‰§è¡Œç‰¹æƒå‘½ä»¤ï¼ˆRing0ï¼‰ï¼Œè°ƒç”¨ä¸€åˆ‡ç³»ç»Ÿèµ„æºï¼Œæ‰€ä»¥ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œç”¨æˆ·çš„æ“ä½œæ˜¯è¿è¡Œåœ¨ç”¨æˆ·ç©ºé—´ï¼Œè€Œå†…æ ¸è¿è¡Œçš„æ•°æ®æ˜¯åœ¨å†…æ ¸ç©ºé—´çš„ï¼Œè€Œæœ‰çš„æƒ…å†µä¸‹ï¼Œä¸€ä¸ªåº”ç”¨ç¨‹åºéœ€è¦å»è°ƒç”¨ä¸€äº›ç‰¹æƒèµ„æºï¼Œå»è°ƒç”¨ä¸€äº›å†…æ ¸ç©ºé—´çš„æ“ä½œï¼Œæ‰€ä»¥æ­¤æ—¶ä»–ä¿©éœ€è¦åœ¨ç”¨æˆ·æ€å’Œå†…æ ¸æ€ä¹‹é—´è¿›è¡Œåˆ‡æ¢ã€‚</p><p>æ¯”å¦‚ï¼š</p><p>Linuxç³»ç»Ÿä¸ºäº†æé«˜IOæ•ˆç‡ï¼Œä¼šåœ¨ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´éƒ½åŠ å…¥ç¼“å†²åŒºï¼š</p><ul><li><p>å†™æ•°æ®æ—¶ï¼Œè¦æŠŠç”¨æˆ·ç¼“å†²æ•°æ®æ‹·è´åˆ°å†…æ ¸ç¼“å†²åŒºï¼Œç„¶åå†™å…¥è®¾å¤‡</p></li><li><p>è¯»æ•°æ®æ—¶ï¼Œè¦ä»è®¾å¤‡è¯»å–æ•°æ®åˆ°å†…æ ¸ç¼“å†²åŒºï¼Œç„¶åæ‹·è´åˆ°ç”¨æˆ·ç¼“å†²åŒº</p></li></ul><p>é’ˆå¯¹è¿™ä¸ªæ“ä½œï¼šæˆ‘ä»¬çš„ç”¨æˆ·åœ¨å†™è¯»æ•°æ®æ—¶ï¼Œä¼šå»å‘å†…æ ¸æ€ç”³è¯·ï¼Œæƒ³è¦è¯»å–å†…æ ¸çš„æ•°æ®ï¼Œè€Œå†…æ ¸æ•°æ®è¦å»ç­‰å¾…é©±åŠ¨ç¨‹åºä»ç¡¬ä»¶ä¸Šè¯»å–æ•°æ®ï¼Œå½“ä»ç£ç›˜ä¸ŠåŠ è½½åˆ°æ•°æ®ä¹‹åï¼Œå†…æ ¸ä¼šå°†æ•°æ®å†™å…¥åˆ°å†…æ ¸çš„ç¼“å†²åŒºä¸­ï¼Œç„¶åå†å°†æ•°æ®æ‹·è´åˆ°ç”¨æˆ·æ€çš„bufferä¸­ï¼Œç„¶åå†è¿”å›ç»™åº”ç”¨ç¨‹åºï¼Œæ•´ä½“è€Œè¨€ï¼Œé€Ÿåº¦æ…¢ï¼Œå°±æ˜¯è¿™ä¸ªåŸå› ï¼Œä¸ºäº†åŠ é€Ÿï¼Œæˆ‘ä»¬å¸Œæœ›readä¹Ÿå¥½ï¼Œè¿˜æ˜¯wait for dataä¹Ÿæœ€å¥½éƒ½ä¸è¦ç­‰å¾…ï¼Œæˆ–è€…æ—¶é—´å°½é‡çš„çŸ­ã€‚</p><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior59.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="é˜»å¡io" tabindex="-1"><a class="header-anchor" href="#é˜»å¡io"><span>é˜»å¡IO</span></a></h3><p>åœ¨ã€ŠUNIXç½‘ç»œç¼–ç¨‹ã€‹ä¸€ä¹¦ä¸­ï¼Œæ€»ç»“å½’çº³äº†5ç§IOæ¨¡å‹ï¼š</p><ul><li>é˜»å¡IOï¼ˆBlocking IOï¼‰</li><li>éé˜»å¡IOï¼ˆNonblocking IOï¼‰</li><li>IOå¤šè·¯å¤ç”¨ï¼ˆIO Multiplexingï¼‰</li><li>ä¿¡å·é©±åŠ¨IOï¼ˆSignal Driven IOï¼‰</li><li>å¼‚æ­¥IOï¼ˆAsynchronous IOï¼‰</li></ul><p>åº”ç”¨ç¨‹åºæƒ³è¦å»è¯»å–æ•°æ®ï¼Œä»–æ˜¯æ— æ³•ç›´æ¥å»è¯»å–ç£ç›˜æ•°æ®çš„ï¼Œä»–éœ€è¦å…ˆåˆ°å†…æ ¸é‡Œè¾¹å»ç­‰å¾…å†…æ ¸æ“ä½œç¡¬ä»¶æ‹¿åˆ°æ•°æ®ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±æ˜¯1ï¼Œæ˜¯éœ€è¦ç­‰å¾…çš„ï¼Œç­‰åˆ°å†…æ ¸ä»ç£ç›˜ä¸ŠæŠŠæ•°æ®åŠ è½½å‡ºæ¥ä¹‹åï¼Œå†æŠŠè¿™ä¸ªæ•°æ®å†™ç»™ç”¨æˆ·çš„ç¼“å­˜åŒºï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯2ï¼Œå¦‚æœæ˜¯é˜»å¡IOï¼Œé‚£ä¹ˆæ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œç”¨æˆ·ä»å‘èµ·è¯»è¯·æ±‚å¼€å§‹ï¼Œä¸€ç›´åˆ°è¯»å–åˆ°æ•°æ®ï¼Œéƒ½æ˜¯ä¸€ä¸ªé˜»å¡çŠ¶æ€ã€‚</p><p>å…·ä½“æµç¨‹å¦‚ä¸‹å›¾ï¼š</p><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior60.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>ç”¨æˆ·å»è¯»å–æ•°æ®æ—¶ï¼Œä¼šå»å…ˆå‘èµ·1ä¸ª<code>recvform</code>å‘½ä»¤ï¼Œå»å°è¯•ä»å†…æ ¸ä¸ŠåŠ è½½æ•°æ®ï¼Œå¦‚æœå†…æ ¸æ²¡æœ‰æ•°æ®ï¼Œé‚£ä¹ˆç”¨æˆ·å°±ä¼šç­‰å¾…ï¼Œæ­¤æ—¶å†…æ ¸ä¼šå»ä»ç¡¬ä»¶ä¸Šè¯»å–æ•°æ®ï¼Œå†…æ ¸è¯»å–æ•°æ®ä¹‹åï¼Œä¼šæŠŠæ•°æ®æ‹·è´åˆ°ç”¨æˆ·æ€ï¼Œå¹¶ä¸”è¿”å›okï¼Œæ•´ä¸ªè¿‡ç¨‹ï¼Œéƒ½æ˜¯é˜»å¡ç­‰å¾…çš„ï¼Œè¿™å°±æ˜¯é˜»å¡IO</p><p><strong>æ€»ç»“</strong></p><p>é¡¾åæ€ä¹‰ï¼Œé˜»å¡IOå°±æ˜¯ä¸¤ä¸ªé˜¶æ®µéƒ½å¿…é¡»é˜»å¡ç­‰å¾…ï¼š</p><p><strong>é˜¶æ®µä¸€ï¼š</strong></p><ul><li>ç”¨æˆ·è¿›ç¨‹å°è¯•è¯»å–æ•°æ®ï¼ˆæ¯”å¦‚ç½‘å¡æ•°æ®ï¼‰</li><li>æ­¤æ—¶æ•°æ®å°šæœªåˆ°è¾¾ï¼Œå†…æ ¸éœ€è¦ç­‰å¾…æ•°æ®</li><li>æ­¤æ—¶ç”¨æˆ·è¿›ç¨‹ä¹Ÿå¤„äºé˜»å¡çŠ¶æ€</li></ul><p><strong>é˜¶æ®µäºŒï¼š</strong></p><ul><li>æ•°æ®åˆ°è¾¾å¹¶æ‹·è´åˆ°å†…æ ¸ç¼“å†²åŒºï¼Œä»£è¡¨å·²å°±ç»ª</li><li>å°†å†…æ ¸æ•°æ®æ‹·è´åˆ°ç”¨æˆ·ç¼“å†²åŒº</li><li>æ‹·è´è¿‡ç¨‹ä¸­ï¼Œç”¨æˆ·è¿›ç¨‹ä¾ç„¶é˜»å¡ç­‰å¾…</li><li>æ‹·è´å®Œæˆï¼Œç”¨æˆ·è¿›ç¨‹è§£é™¤é˜»å¡ï¼Œå¤„ç†æ•°æ®</li></ul><p>å¯ä»¥çœ‹åˆ°ï¼Œé˜»å¡IOæ¨¡å‹ä¸­ï¼Œç”¨æˆ·è¿›ç¨‹åœ¨ä¸¤ä¸ªé˜¶æ®µéƒ½æ˜¯é˜»å¡çŠ¶æ€ã€‚</p><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior61.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="éé˜»å¡io" tabindex="-1"><a class="header-anchor" href="#éé˜»å¡io"><span>éé˜»å¡IO</span></a></h3><p>é¡¾åæ€ä¹‰ï¼Œéé˜»å¡IOçš„<code>recvfrom</code>æ“ä½œä¼šç«‹å³è¿”å›ç»“æœè€Œä¸æ˜¯é˜»å¡ç”¨æˆ·è¿›ç¨‹ã€‚</p><p><strong>é˜¶æ®µä¸€ï¼š</strong></p><ul><li>ç”¨æˆ·è¿›ç¨‹å°è¯•è¯»å–æ•°æ®ï¼ˆæ¯”å¦‚ç½‘å¡æ•°æ®ï¼‰</li><li>æ­¤æ—¶æ•°æ®å°šæœªåˆ°è¾¾ï¼Œå†…æ ¸éœ€è¦ç­‰å¾…æ•°æ®</li><li>è¿”å›å¼‚å¸¸ç»™ç”¨æˆ·è¿›ç¨‹</li><li>ç”¨æˆ·è¿›ç¨‹æ‹¿åˆ°erroråï¼Œå†æ¬¡å°è¯•è¯»å–</li><li>å¾ªç¯å¾€å¤ï¼Œç›´åˆ°æ•°æ®å°±ç»ª</li></ul><p><strong>é˜¶æ®µäºŒï¼š</strong></p><ul><li>å°†å†…æ ¸æ•°æ®æ‹·è´åˆ°ç”¨æˆ·ç¼“å†²åŒº</li><li>æ‹·è´è¿‡ç¨‹ä¸­ï¼Œç”¨æˆ·è¿›ç¨‹ä¾ç„¶é˜»å¡ç­‰å¾…</li><li>æ‹·è´å®Œæˆï¼Œç”¨æˆ·è¿›ç¨‹è§£é™¤é˜»å¡ï¼Œå¤„ç†æ•°æ®</li><li>å¯ä»¥çœ‹åˆ°ï¼Œéé˜»å¡IOæ¨¡å‹ä¸­ï¼Œç”¨æˆ·è¿›ç¨‹åœ¨ç¬¬ä¸€ä¸ªé˜¶æ®µæ˜¯éé˜»å¡ï¼Œç¬¬äºŒä¸ªé˜¶æ®µæ˜¯é˜»å¡çŠ¶æ€ã€‚è™½ç„¶æ˜¯éé˜»å¡ï¼Œä½†æ€§èƒ½å¹¶æ²¡æœ‰å¾—åˆ°æé«˜ã€‚è€Œä¸”å¿™ç­‰æœºåˆ¶ä¼šå¯¼è‡´CPUç©ºè½¬ï¼ŒCPUä½¿ç”¨ç‡æš´å¢</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior62.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="ioå¤šè·¯å¤ç”¨" tabindex="-1"><a class="header-anchor" href="#ioå¤šè·¯å¤ç”¨"><span>IOå¤šè·¯å¤ç”¨</span></a></h3><p>æ— è®ºæ˜¯é˜»å¡IOè¿˜æ˜¯éé˜»å¡IOï¼Œç”¨æˆ·åº”ç”¨åœ¨ä¸€é˜¶æ®µéƒ½éœ€è¦è°ƒç”¨recvfromæ¥è·å–æ•°æ®ï¼Œå·®åˆ«åœ¨äºæ— æ•°æ®æ—¶çš„å¤„ç†æ–¹æ¡ˆï¼š</p><ul><li>å¦‚æœè°ƒç”¨recvfromæ—¶ï¼Œæ°å¥½æ²¡æœ‰æ•°æ®ï¼Œé˜»å¡IOä¼šä½¿CPUé˜»å¡ï¼Œéé˜»å¡IOä½¿CPUç©ºè½¬ï¼Œéƒ½ä¸èƒ½å……åˆ†å‘æŒ¥CPUçš„ä½œç”¨</li><li>å¦‚æœè°ƒç”¨recvfromæ—¶ï¼Œæ°å¥½æœ‰æ•°æ®ï¼Œåˆ™ç”¨æˆ·è¿›ç¨‹å¯ä»¥ç›´æ¥è¿›å…¥ç¬¬äºŒé˜¶æ®µï¼Œè¯»å–å¹¶å¤„ç†æ•°æ®</li></ul><p>æ‰€ä»¥æ€ä¹ˆçœ‹èµ·æ¥ä»¥ä¸Šä¸¤ç§æ–¹å¼æ€§èƒ½éƒ½ä¸å¥½</p><p>è€Œåœ¨å•çº¿ç¨‹æƒ…å†µä¸‹ï¼Œåªèƒ½ä¾æ¬¡å¤„ç†IOäº‹ä»¶ï¼Œå¦‚æœæ­£åœ¨å¤„ç†çš„IOäº‹ä»¶æ°å¥½æœªå°±ç»ªï¼ˆæ•°æ®ä¸å¯è¯»æˆ–ä¸å¯å†™ï¼‰ï¼Œçº¿ç¨‹å°±ä¼šè¢«é˜»å¡ï¼Œæ‰€æœ‰IOäº‹ä»¶éƒ½å¿…é¡»ç­‰å¾…ï¼Œæ€§èƒ½è‡ªç„¶ä¼šå¾ˆå·®ã€‚</p><p>å°±æ¯”å¦‚æœåŠ¡å‘˜ç»™é¡¾å®¢ç‚¹é¤ï¼Œ<strong>åˆ†ä¸¤æ­¥</strong>ï¼š</p><ul><li>é¡¾å®¢æ€è€ƒè¦åƒä»€ä¹ˆï¼ˆç­‰å¾…æ•°æ®å°±ç»ªï¼‰</li><li>é¡¾å®¢æƒ³å¥½äº†ï¼Œå¼€å§‹ç‚¹é¤ï¼ˆè¯»å–æ•°æ®ï¼‰</li></ul><p>è¦æé«˜æ•ˆç‡æœ‰å‡ ç§åŠæ³•ï¼Ÿ</p><ul><li><p>æ–¹æ¡ˆä¸€ï¼šå¢åŠ æ›´å¤šæœåŠ¡å‘˜ï¼ˆå¤šçº¿ç¨‹ï¼‰</p></li><li><p>æ–¹æ¡ˆäºŒï¼šä¸æ’é˜Ÿï¼Œè°æƒ³å¥½äº†åƒä»€ä¹ˆï¼ˆæ•°æ®å°±ç»ªäº†ï¼‰ï¼ŒæœåŠ¡å‘˜å°±ç»™è°ç‚¹é¤ï¼ˆç”¨æˆ·åº”ç”¨å°±å»è¯»å–æ•°æ®ï¼‰</p></li></ul><p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼šç”¨æˆ·è¿›ç¨‹å¦‚ä½•çŸ¥é“å†…æ ¸ä¸­æ•°æ®æ˜¯å¦å°±ç»ªå‘¢ï¼Ÿ</p><p>æ‰€ä»¥æ¥ä¸‹æ¥å°±éœ€è¦è¯¦ç»†çš„æ¥è§£å†³å¤šè·¯å¤ç”¨æ¨¡å‹æ˜¯å¦‚ä½•çŸ¥é“åˆ°åº•æ€ä¹ˆçŸ¥é“å†…æ ¸æ•°æ®æ˜¯å¦å°±ç»ªçš„é—®é¢˜äº†</p><p>è¿™ä¸ªé—®é¢˜çš„è§£å†³ä¾èµ–äºæå‡ºçš„ <strong>æ–‡ä»¶æè¿°ç¬¦</strong>ï¼ˆFile Descriptorï¼‰ï¼šç®€ç§°FDï¼Œæ˜¯ä¸€ä¸ªä» 0 å¼€å§‹çš„æ— ç¬¦å·æ•´æ•°ï¼Œç”¨æ¥å…³è”Linuxä¸­çš„ä¸€ä¸ªæ–‡ä»¶ã€‚åœ¨Linuxä¸­ï¼Œä¸€åˆ‡çš†æ–‡ä»¶ï¼Œä¾‹å¦‚å¸¸è§„æ–‡ä»¶ã€è§†é¢‘ã€ç¡¬ä»¶è®¾å¤‡ç­‰ï¼Œå½“ç„¶ä¹ŸåŒ…æ‹¬ç½‘ç»œå¥—æ¥å­—ï¼ˆSocketï¼‰ã€‚</p><p>é€šè¿‡FDï¼Œç½‘ç»œæ¨¡å‹å¯ä»¥åˆ©ç”¨ä¸€ä¸ªçº¿ç¨‹ç›‘å¬å¤šä¸ªFDï¼Œå¹¶åœ¨æŸä¸ªFDå¯è¯»ã€å¯å†™æ—¶å¾—åˆ°é€šçŸ¥ï¼Œä»è€Œé¿å…æ— æ•ˆçš„ç­‰å¾…ï¼Œå……åˆ†åˆ©ç”¨CPUèµ„æºã€‚</p><p><strong>é˜¶æ®µä¸€ï¼š</strong></p><ul><li>ç”¨æˆ·è¿›ç¨‹è°ƒç”¨selectï¼ŒæŒ‡å®šè¦ç›‘å¬çš„FDé›†åˆ</li><li>æ ¸ç›‘å¬FDå¯¹åº”çš„å¤šä¸ªsocket</li><li>ä»»æ„ä¸€ä¸ªæˆ–å¤šä¸ªsocketæ•°æ®å°±ç»ªåˆ™è¿”å›readable</li><li>æ­¤è¿‡ç¨‹ä¸­ç”¨æˆ·è¿›ç¨‹é˜»å¡</li></ul><p><strong>é˜¶æ®µäºŒï¼š</strong></p><ul><li>ç”¨æˆ·è¿›ç¨‹æ‰¾åˆ°å°±ç»ªçš„socket</li><li>ä¾æ¬¡è°ƒç”¨recvfromè¯»å–æ•°æ®</li><li>å†…æ ¸å°†æ•°æ®æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´</li><li>ç”¨æˆ·è¿›ç¨‹å¤„ç†æ•°æ®</li></ul><p>å½“ç”¨æˆ·å»è¯»å–æ•°æ®çš„æ—¶å€™ï¼Œä¸å†å»ç›´æ¥è°ƒç”¨recvfromäº†ï¼Œè€Œæ˜¯è°ƒç”¨selectçš„å‡½æ•°ï¼Œselectå‡½æ•°ä¼šå°†éœ€è¦ç›‘å¬çš„æ•°æ®äº¤ç»™å†…æ ¸ï¼Œç”±å†…æ ¸å»æ£€æŸ¥è¿™äº›æ•°æ®æ˜¯å¦å°±ç»ªäº†ï¼Œå¦‚æœè¯´è¿™ä¸ªæ•°æ®å°±ç»ªäº†ï¼Œå°±ä¼šé€šçŸ¥åº”ç”¨ç¨‹åºæ•°æ®å°±ç»ªï¼Œç„¶åæ¥è¯»å–æ•°æ®ï¼Œå†ä»å†…æ ¸ä¸­æŠŠæ•°æ®æ‹·è´ç»™ç”¨æˆ·æ€ï¼Œå®Œæˆæ•°æ®å¤„ç†ï¼Œå¦‚æœNå¤šä¸ªFDä¸€ä¸ªéƒ½æ²¡å¤„ç†å®Œï¼Œæ­¤æ—¶å°±è¿›è¡Œç­‰å¾…ã€‚</p><p>ç”¨IOå¤ç”¨æ¨¡å¼ï¼Œå¯ä»¥ç¡®ä¿å»è¯»æ•°æ®çš„æ—¶å€™ï¼Œæ•°æ®æ˜¯ä¸€å®šå­˜åœ¨çš„ï¼Œä»–çš„æ•ˆç‡æ¯”åŸæ¥çš„é˜»å¡IOå’Œéé˜»å¡IOæ€§èƒ½éƒ½è¦é«˜</p><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior63.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>IOå¤šè·¯å¤ç”¨æ˜¯åˆ©ç”¨å•ä¸ªçº¿ç¨‹æ¥åŒæ—¶ç›‘å¬å¤šä¸ªFDï¼Œå¹¶åœ¨æŸä¸ªFDå¯è¯»ã€å¯å†™æ—¶å¾—åˆ°é€šçŸ¥ï¼Œä»è€Œé¿å…æ— æ•ˆçš„ç­‰å¾…ï¼Œå……åˆ†åˆ©ç”¨CPUèµ„æºã€‚ä¸è¿‡ç›‘å¬FDçš„æ–¹å¼ã€é€šçŸ¥çš„æ–¹å¼åˆæœ‰å¤šç§å®ç°ï¼Œå¸¸è§çš„æœ‰ï¼š</p><ul><li>select</li><li>poll</li><li>epoll</li></ul><p>å…¶ä¸­selectå’Œpoolç›¸å½“äºæ˜¯å½“è¢«ç›‘å¬çš„æ•°æ®å‡†å¤‡å¥½ä¹‹åï¼Œä»–ä¼šæŠŠä½ ç›‘å¬çš„FDæ•´ä¸ªæ•°æ®éƒ½å‘ç»™ä½ ï¼Œä½ éœ€è¦åˆ°æ•´ä¸ªFDä¸­å»æ‰¾ï¼Œå“ªäº›æ˜¯å¤„ç†å¥½äº†çš„ï¼Œéœ€è¦é€šè¿‡éå†çš„æ–¹å¼ï¼Œæ‰€ä»¥æ€§èƒ½ä¹Ÿå¹¶ä¸æ˜¯é‚£ä¹ˆå¥½</p><p>è€Œepollï¼Œåˆ™ç›¸å½“äºå†…æ ¸å‡†å¤‡å¥½äº†ä¹‹åï¼Œä»–ä¼šæŠŠå‡†å¤‡å¥½çš„æ•°æ®ï¼Œç›´æ¥å‘ç»™ä½ ï¼Œå°±çœå»äº†éå†çš„åŠ¨ä½œã€‚</p><h4 id="select" tabindex="-1"><a class="header-anchor" href="#select"><span>Select</span></a></h4><p>selectæ˜¯Linuxæœ€æ—©æ˜¯ç”±çš„I/Oå¤šè·¯å¤ç”¨æŠ€æœ¯ï¼š</p><p>ç®€å•è¯´ï¼Œå°±æ˜¯æˆ‘ä»¬æŠŠéœ€è¦å¤„ç†çš„æ•°æ®å°è£…æˆFDï¼Œç„¶ååœ¨ç”¨æˆ·æ€æ—¶åˆ›å»ºä¸€ä¸ªfdçš„é›†åˆï¼ˆè¿™ä¸ªé›†åˆçš„å¤§å°æ˜¯è¦ç›‘å¬çš„é‚£ä¸ªFDçš„æœ€å¤§å€¼+1ï¼Œä½†æ˜¯å¤§å°æ•´ä½“æ˜¯æœ‰é™åˆ¶çš„ ï¼‰ï¼Œè¿™ä¸ªé›†åˆçš„é•¿åº¦å¤§å°æ˜¯æœ‰é™åˆ¶çš„ï¼ŒåŒæ—¶åœ¨è¿™ä¸ªé›†åˆä¸­ï¼Œæ ‡æ˜å‡ºæ¥æˆ‘ä»¬è¦æ§åˆ¶å“ªäº›æ•°æ®ã€‚</p><p>æ¯”å¦‚è¦ç›‘å¬çš„æ•°æ®ï¼Œæ˜¯1,2,5ä¸‰ä¸ªæ•°æ®ï¼Œæ­¤æ—¶ä¼šæ‰§è¡Œselectå‡½æ•°ï¼Œç„¶åå°†æ•´ä¸ªFDå‘ç»™å†…æ ¸æ€ï¼Œå†…æ ¸æ€ä¼šå»éå†ç”¨æˆ·æ€ä¼ é€’è¿‡æ¥çš„æ•°æ®ï¼Œå¦‚æœå‘ç°è¿™é‡Œè¾¹éƒ½æ•°æ®éƒ½æ²¡æœ‰å°±ç»ªï¼Œå°±ä¼‘çœ ï¼Œç›´åˆ°æœ‰æ•°æ®å‡†å¤‡å¥½æ—¶ï¼Œå°±ä¼šè¢«å”¤é†’ï¼Œå”¤é†’ä¹‹åï¼Œå†æ¬¡éå†ä¸€éï¼Œçœ‹çœ‹è°å‡†å¤‡å¥½äº†ï¼Œç„¶åå†å¤„ç†æ‰æ²¡æœ‰å‡†å¤‡å¥½çš„æ•°æ®ï¼Œæœ€åå†å°†è¿™ä¸ªFDé›†åˆå†™å›åˆ°ç”¨æˆ·æ€ä¸­å»ï¼Œæ­¤æ—¶ç”¨æˆ·æ€å°±çŸ¥é“æœ‰äººå‡†å¤‡å¥½äº†ï¼Œä½†æ˜¯å¯¹äºç”¨æˆ·æ€è€Œè¨€ï¼Œå¹¶ä¸çŸ¥é“è°å¤„ç†å¥½äº†ï¼Œæ‰€ä»¥ç”¨æˆ·æ€ä¹Ÿéœ€è¦å»è¿›è¡Œéå†ï¼Œç„¶åæ‰¾åˆ°å¯¹åº”å‡†å¤‡å¥½æ•°æ®çš„èŠ‚ç‚¹ï¼Œå†å»å‘èµ·è¯»è¯·æ±‚ã€‚</p><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior64.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>selectæ¨¡å¼å­˜åœ¨çš„é—®é¢˜ï¼š</p><ul><li>éœ€è¦å°†æ•´ä¸ªfd_setä»ç”¨æˆ·ç©ºé—´æ‹·è´åˆ°å†…æ ¸ç©ºé—´ï¼Œselectç»“æŸè¿˜è¦å†æ¬¡æ‹·è´å›ç”¨æˆ·ç©ºé—´</li><li>selectæ— æ³•å¾—çŸ¥å…·ä½“æ˜¯å“ªä¸ªfdå°±ç»ªï¼Œéœ€è¦éå†æ•´ä¸ªfd_set</li><li>fd_setç›‘å¬çš„fdæ•°é‡ä¸èƒ½è¶…è¿‡1024</li></ul><h4 id="poll" tabindex="-1"><a class="header-anchor" href="#poll"><span>Poll</span></a></h4><p>pollæ¨¡å¼å¯¹selectæ¨¡å¼åšäº†ç®€å•æ”¹è¿›ï¼Œä½†æ€§èƒ½æå‡ä¸æ˜æ˜¾ï¼Œéƒ¨åˆ†å…³é”®ä»£ç å¦‚ä¸‹ï¼š</p><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior65.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>IOæµç¨‹ï¼š</p><ul><li>åˆ›å»ºpollfdæ•°ç»„ï¼Œå‘å…¶ä¸­æ·»åŠ å…³æ³¨çš„fdä¿¡æ¯ï¼Œæ•°ç»„å¤§å°è‡ªå®šä¹‰</li><li>è°ƒç”¨pollå‡½æ•°ï¼Œå°†pollfdæ•°ç»„æ‹·è´åˆ°å†…æ ¸ç©ºé—´ï¼Œè½¬é“¾è¡¨å­˜å‚¨ï¼Œæ— ä¸Šé™</li><li>å†…æ ¸éå†fdï¼Œåˆ¤æ–­æ˜¯å¦å°±ç»ª</li><li>æ•°æ®å°±ç»ªæˆ–è¶…æ—¶åï¼Œæ‹·è´pollfdæ•°ç»„åˆ°ç”¨æˆ·ç©ºé—´ï¼Œè¿”å›å°±ç»ªfdæ•°é‡n</li><li>ç”¨æˆ·è¿›ç¨‹åˆ¤æ–­næ˜¯å¦å¤§äº0,å¤§äº0åˆ™éå†pollfdæ•°ç»„ï¼Œæ‰¾åˆ°å°±ç»ªçš„fd</li></ul><p><strong>ä¸selectå¯¹æ¯”ï¼š</strong></p><ul><li>selectæ¨¡å¼ä¸­çš„fd_setå¤§å°å›ºå®šä¸º1024ï¼Œè€Œpollfdåœ¨å†…æ ¸ä¸­é‡‡ç”¨é“¾è¡¨ï¼Œç†è®ºä¸Šæ— ä¸Šé™</li><li>ç›‘å¬FDè¶Šå¤šï¼Œæ¯æ¬¡éå†æ¶ˆè€—æ—¶é—´ä¹Ÿè¶Šä¹…ï¼Œæ€§èƒ½åè€Œä¼šä¸‹é™</li></ul><h4 id="epoll" tabindex="-1"><a class="header-anchor" href="#epoll"><span>EPoll</span></a></h4><div class="language-c line-numbers-mode" data-ext="c" data-title="c"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">eventpoll</span> <span class="token punctuation">{</span>
    <span class="token comment">//...</span>
    <span class="token keyword">struct</span> <span class="token class-name">rb_root</span>  rbr<span class="token punctuation">;</span> <span class="token comment">// ä¸€é¢—çº¢é»‘æ ‘ï¼Œè®°å½•è¦ç›‘å¬çš„FD</span>
    <span class="token keyword">struct</span> <span class="token class-name">list_head</span> rdlist<span class="token punctuation">;</span><span class="token comment">// ä¸€ä¸ªé“¾è¡¨ï¼Œè®°å½•å°±ç»ªçš„FD</span>
    <span class="token comment">//...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 1.åˆ›å»ºä¸€ä¸ªepollå®ä¾‹,å†…éƒ¨æ˜¯event pollï¼Œè¿”å›å¯¹åº”çš„å¥æŸ„epfd</span>
<span class="token keyword">int</span> <span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token keyword">int</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 2.å°†ä¸€ä¸ªFDæ·»åŠ åˆ°epollçš„çº¢é»‘æ ‘ä¸­ï¼Œå¹¶è®¾ç½®ep_poll_callback</span>
<span class="token comment">// callbackè§¦å‘æ—¶ï¼Œå°±æŠŠå¯¹åº”çš„FDåŠ å…¥åˆ°rdlistè¿™ä¸ªå°±ç»ªåˆ—è¡¨ä¸­</span>
<span class="token keyword">int</span> <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>
    <span class="token keyword">int</span> epfd<span class="token punctuation">,</span>  <span class="token comment">// epollå®ä¾‹çš„å¥æŸ„</span>
    <span class="token keyword">int</span> op<span class="token punctuation">,</span>    <span class="token comment">// è¦æ‰§è¡Œçš„æ“ä½œï¼ŒåŒ…æ‹¬ï¼šADDã€MODã€DEL</span>
    <span class="token keyword">int</span> fd<span class="token punctuation">,</span>    <span class="token comment">// è¦ç›‘å¬çš„FD</span>
    <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> <span class="token operator">*</span>event <span class="token comment">// è¦ç›‘å¬çš„äº‹ä»¶ç±»å‹ï¼šè¯»ã€å†™ã€å¼‚å¸¸ç­‰</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 3.æ£€æŸ¥rdliståˆ—è¡¨æ˜¯å¦ä¸ºç©ºï¼Œä¸ä¸ºç©ºåˆ™è¿”å›å°±ç»ªçš„FDçš„æ•°é‡</span>
<span class="token keyword">int</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span>
    <span class="token keyword">int</span> epfd<span class="token punctuation">,</span>                   <span class="token comment">// epollå®ä¾‹çš„å¥æŸ„</span>
    <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> <span class="token operator">*</span>events<span class="token punctuation">,</span> <span class="token comment">// ç©ºeventæ•°ç»„ï¼Œç”¨äºæ¥æ”¶å°±ç»ªçš„FD</span>
    <span class="token keyword">int</span> maxevents<span class="token punctuation">,</span>              <span class="token comment">// eventsæ•°ç»„çš„æœ€å¤§é•¿åº¦</span>
    <span class="token keyword">int</span> timeout   <span class="token comment">// è¶…æ—¶æ—¶é—´ï¼Œ-1ç”¨ä¸è¶…æ—¶ï¼›0ä¸é˜»å¡ï¼›å¤§äº0ä¸ºé˜»å¡æ—¶é—´</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>epollæ¨¡å¼æ˜¯å¯¹selectå’Œpollçš„æ”¹è¿›ï¼Œå®ƒæä¾›äº†ä¸‰ä¸ªå‡½æ•°ï¼š</p><p>ç¬¬ä¸€ä¸ªæ˜¯<code>eventpoll</code>å‡½æ•°ï¼Œä»–å†…éƒ¨åŒ…å«ä¸¤ä¸ªä¸œè¥¿</p><ul><li>çº¢é»‘æ ‘-&gt;è®°å½•çš„äº‹è¦ç›‘å¬çš„FD</li><li>é“¾è¡¨-&gt;è®°å½•çš„æ˜¯å°±ç»ªçš„FD</li></ul><p>ç´§æ¥ç€è°ƒç”¨<code>epoll_ctl</code>æ“ä½œï¼Œå°†è¦ç›‘å¬çš„æ•°æ®æ·»åŠ åˆ°çº¢é»‘æ ‘ä¸Šå»ï¼Œå¹¶ä¸”ç»™æ¯ä¸ªfdè®¾ç½®ä¸€ä¸ªç›‘å¬å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¼šåœ¨fdæ•°æ®å°±ç»ªæ—¶è§¦å‘ã€‚å‡†å¤‡å¥½äº†å°±æŠŠfdæ•°æ®æ·»åŠ åˆ°list_headä¸­ã€‚</p><p><code>epoll_wait</code>å‡½æ•°</p><p>å°±å»ç­‰å¾…ï¼Œåœ¨ç”¨æˆ·æ€åˆ›å»ºä¸€ä¸ªç©ºçš„eventsæ•°ç»„ï¼Œå½“å°±ç»ªä¹‹åï¼Œæˆ‘ä»¬çš„å›è°ƒå‡½æ•°ä¼šæŠŠæ•°æ®æ·»åŠ åˆ°list_headä¸­å»ï¼Œå½“è°ƒç”¨è¿™ä¸ªå‡½æ•°çš„æ—¶å€™ï¼Œä¼šå»æ£€æŸ¥list_headï¼Œå½“ç„¶è¿™ä¸ªè¿‡ç¨‹éœ€è¦å‚è€ƒé…ç½®çš„ç­‰å¾…æ—¶é—´ï¼Œå¯ä»¥ç­‰ä¸€å®šæ—¶é—´ï¼Œä¹Ÿå¯ä»¥ä¸€ç›´ç­‰ï¼Œ å¦‚æœåœ¨æ­¤è¿‡ç¨‹ä¸­ï¼Œæ£€æŸ¥åˆ°äº†list_headä¸­æœ‰æ•°æ®ä¼šå°†æ•°æ®æ·»åŠ åˆ°é“¾è¡¨ä¸­ï¼Œæ­¤æ—¶å°†æ•°æ®æ”¾å…¥åˆ°eventsæ•°ç»„ä¸­ï¼Œå¹¶ä¸”è¿”å›å¯¹åº”çš„æ“ä½œçš„æ•°é‡ï¼Œç”¨æˆ·æ€çš„æ­¤æ—¶æ”¶åˆ°å“åº”åï¼Œä»eventsä¸­æ‹¿åˆ°å¯¹åº”å‡†å¤‡å¥½çš„æ•°æ®çš„èŠ‚ç‚¹ï¼Œå†å»è°ƒç”¨æ–¹æ³•å»æ‹¿æ•°æ®ã€‚</p><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior66.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><hr><p><strong>æ€»ç»“ï¼š</strong></p><p>selectæ¨¡å¼å­˜åœ¨çš„ä¸‰ä¸ªé—®é¢˜ï¼š</p><ul><li>èƒ½ç›‘å¬çš„FDæœ€å¤§ä¸è¶…è¿‡1024</li><li>æ¯æ¬¡selectéƒ½éœ€è¦æŠŠæ‰€æœ‰è¦ç›‘å¬çš„FDéƒ½æ‹·è´åˆ°å†…æ ¸ç©ºé—´</li><li>æ¯æ¬¡éƒ½è¦éå†æ‰€æœ‰FDæ¥åˆ¤æ–­å°±ç»ªçŠ¶æ€</li></ul><p>pollæ¨¡å¼çš„é—®é¢˜ï¼š</p><ul><li>pollåˆ©ç”¨é“¾è¡¨è§£å†³äº†selectä¸­ç›‘å¬FDä¸Šé™çš„é—®é¢˜ï¼Œä½†ä¾ç„¶è¦éå†æ‰€æœ‰FDï¼Œå¦‚æœç›‘å¬è¾ƒå¤šï¼Œæ€§èƒ½ä¼šä¸‹é™</li></ul><p>epollæ¨¡å¼ä¸­å¦‚ä½•è§£å†³è¿™äº›é—®é¢˜çš„ï¼Ÿ</p><ul><li>åŸºäºepollå®ä¾‹ä¸­çš„çº¢é»‘æ ‘ä¿å­˜è¦ç›‘å¬çš„FDï¼Œç†è®ºä¸Šæ— ä¸Šé™ï¼Œè€Œä¸”å¢åˆ æ”¹æŸ¥æ•ˆç‡éƒ½éå¸¸é«˜</li><li>æ¯ä¸ªFDåªéœ€è¦æ‰§è¡Œä¸€æ¬¡epoll_ctlæ·»åŠ åˆ°çº¢é»‘æ ‘ï¼Œä»¥åæ¯æ¬¡epol_waitæ— éœ€ä¼ é€’ä»»ä½•å‚æ•°ï¼Œæ— éœ€é‡å¤æ‹·è´FDåˆ°å†…æ ¸ç©ºé—´</li><li>åˆ©ç”¨ep_poll_callbackæœºåˆ¶æ¥ç›‘å¬FDçŠ¶æ€ï¼Œæ— éœ€éå†æ‰€æœ‰FDï¼Œå› æ­¤æ€§èƒ½ä¸ä¼šéšç›‘å¬çš„FDæ•°é‡å¢å¤šè€Œä¸‹é™</li></ul><h5 id="æ°´å¹³è§¦å‘lt" tabindex="-1"><a class="header-anchor" href="#æ°´å¹³è§¦å‘lt"><span>æ°´å¹³è§¦å‘LT</span></a></h5><p>åœ¨æ°´å¹³è§¦å‘æ¨¡å¼ä¸‹ï¼Œåªè¦æ–‡ä»¶æè¿°ç¬¦çš„äº‹ä»¶ï¼ˆå¦‚å¯è¯»ã€å¯å†™ï¼‰æ²¡æœ‰è¢«å®Œå…¨å¤„ç†ï¼Œ<code>epoll_wait()</code> è°ƒç”¨å°±ä¼šä¸æ–­è¿”å›è¯¥æ–‡ä»¶æè¿°ç¬¦ã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœåº”ç”¨ç¨‹åºæ²¡æœ‰è¯»å–æˆ–å†™å…¥è¶³å¤Ÿçš„æ•°æ®æ¥æ¸…é™¤æ–‡ä»¶æè¿°ç¬¦ä¸Šçš„äº‹ä»¶ï¼Œå®ƒå°†è¢«å¤šæ¬¡è¿”å›ã€‚</p><p><strong>ç‰¹ç‚¹</strong>ï¼š</p><ul><li>åº”ç”¨ç¨‹åºéœ€è¦æ‰‹åŠ¨å¤„ç†äº‹ä»¶ï¼Œç›´åˆ°æ–‡ä»¶æè¿°ç¬¦ä¸Šæ²¡æœ‰æ›´å¤šçš„äº‹ä»¶ã€‚</li><li>åº”ç”¨ç¨‹åºå¯èƒ½ä¼šå¤šæ¬¡æ”¶åˆ°ç›¸åŒçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå³ä½¿äº‹ä»¶å°šæœªå¤„ç†ã€‚</li><li>é€‚ç”¨äºç®€å•çš„äº‹ä»¶å¤„ç†ï¼Œä¸éœ€è¦å¤æ‚çš„çŠ¶æ€ç®¡ç†ã€‚</li></ul><h5 id="è¾¹ç¼˜è§¦å‘et" tabindex="-1"><a class="header-anchor" href="#è¾¹ç¼˜è§¦å‘et"><span>è¾¹ç¼˜è§¦å‘ET</span></a></h5><p>åœ¨è¾¹ç¼˜è§¦å‘æ¨¡å¼ä¸‹ï¼Œ<code>epoll_wait()</code> åªåœ¨æ–‡ä»¶æè¿°ç¬¦ä¸Šçš„äº‹ä»¶çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶è¿”å›ä¸€æ¬¡ã€‚è¿™æ„å‘³ç€ï¼Œåº”ç”¨ç¨‹åºå¿…é¡»åœ¨ä¸€æ¬¡ <code>epoll_wait()</code> è°ƒç”¨ä¸­å¤„ç†å®Œæ‰€æœ‰çš„æ•°æ®ï¼Œå¦åˆ™å¯èƒ½ä¼šé”™è¿‡äº‹ä»¶ã€‚</p><p><strong>ç‰¹ç‚¹</strong>ï¼š</p><ul><li>åº”ç”¨ç¨‹åºé€šå¸¸åªéœ€è¦å¤„ç†ä¸€æ¬¡æ–‡ä»¶æè¿°ç¬¦ä¸Šçš„äº‹ä»¶ã€‚</li><li>å¯ä»¥å‡å°‘ <code>epoll_wait()</code> çš„è°ƒç”¨æ¬¡æ•°ï¼Œæé«˜æ•ˆç‡ã€‚</li><li>éœ€è¦æ›´å¤æ‚çš„çŠ¶æ€ç®¡ç†ï¼Œä»¥ç¡®ä¿æ•°æ®è¢«å®Œå…¨å¤„ç†ã€‚</li><li>é€‚ç”¨äºéœ€è¦é«˜æ•ˆå¤„ç†å¤§é‡æ•°æ®çš„åœºæ™¯ã€‚</li></ul><p><strong>é€‰æ‹©æŒ‡å—</strong></p><ul><li><strong>æ•°æ®å®Œæ•´æ€§</strong>ï¼šå¦‚æœä½ éœ€è¦ç¡®ä¿æ•°æ®çš„å®Œæ•´æ€§ï¼Œå¹¶ä¸”å¸Œæœ›åœ¨æ•°æ®åˆ°è¾¾æ—¶ç«‹å³å¤„ç†ï¼ŒET å¯èƒ½æ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚</li><li><strong>ç®€å•æ€§</strong>ï¼šå¦‚æœä½ çš„åº”ç”¨ç¨‹åºé€»è¾‘ç®€å•ï¼Œæˆ–è€…ä½ ä¸å¸Œæœ›å¤„ç†å¤æ‚çš„çŠ¶æ€ç®¡ç†ï¼ŒLT å¯èƒ½æ›´åˆé€‚ã€‚</li><li><strong>æ€§èƒ½</strong>ï¼šET é€šå¸¸åœ¨å¤„ç†å¤§é‡æ•°æ®æ—¶æä¾›æ›´å¥½çš„æ€§èƒ½ï¼Œå› ä¸ºå®ƒå‡å°‘äº†ç³»ç»Ÿè°ƒç”¨çš„æ¬¡æ•°ã€‚</li><li><strong>èµ„æºä½¿ç”¨</strong>ï¼šLT å¯èƒ½ä¼šå› ä¸ºå¤šæ¬¡è¿”å›ç›¸åŒçš„æ–‡ä»¶æè¿°ç¬¦è€Œå¯¼è‡´èµ„æºä½¿ç”¨å¢åŠ ï¼Œå°¤å…¶æ˜¯åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ã€‚</li></ul><p>åœ¨å®é™…åº”ç”¨ä¸­ï¼ŒET æ¨¡å¼é€šå¸¸è¢«è®¤ä¸ºæ›´é«˜æ•ˆï¼Œå› ä¸ºå®ƒå‡å°‘äº†ä¸å¿…è¦çš„ <code>epoll_wait()</code> è°ƒç”¨ã€‚ä½†æ˜¯ï¼Œå®ƒä¹Ÿéœ€è¦åº”ç”¨ç¨‹åºèƒ½å¤Ÿå¿«é€Ÿä¸”å®Œå…¨åœ°å¤„ç†äº‹ä»¶ï¼Œå¦åˆ™å¯èƒ½ä¼šä¸¢å¤±æ•°æ®ã€‚å› æ­¤ï¼Œé€‰æ‹©å“ªç§æ¨¡å¼å–å†³äºå…·ä½“çš„åº”ç”¨éœ€æ±‚å’Œè®¾è®¡ã€‚</p><h3 id="åŸºäºepollçš„æœåŠ¡ç«¯æµç¨‹" tabindex="-1"><a class="header-anchor" href="#åŸºäºepollçš„æœåŠ¡ç«¯æµç¨‹"><span>åŸºäºEPollçš„æœåŠ¡ç«¯æµç¨‹</span></a></h3><p>æœåŠ¡å™¨å¯åŠ¨ä»¥åï¼ŒæœåŠ¡ç«¯ä¼šå»è°ƒç”¨epoll_createï¼Œåˆ›å»ºä¸€ä¸ªepollå®ä¾‹ï¼Œepollå®ä¾‹ä¸­åŒ…å«ä¸¤ä¸ªæ•°æ®</p><ul><li>çº¢é»‘æ ‘ï¼ˆä¸ºç©ºï¼‰ï¼šrb_root ç”¨æ¥å»è®°å½•éœ€è¦è¢«ç›‘å¬çš„FD</li><li>é“¾è¡¨ï¼ˆä¸ºç©ºï¼‰ï¼šlist_headï¼Œç”¨æ¥å­˜æ”¾å·²ç»å°±ç»ªçš„FD</li></ul><p>åˆ›å»ºå¥½äº†ä¹‹åï¼Œä¼šå»è°ƒç”¨<code>epoll_ctl</code>å‡½æ•°ï¼Œæ­¤å‡½æ•°ä¼šä¼šå°†éœ€è¦ç›‘å¬çš„æ•°æ®æ·»åŠ åˆ°<code>rb_root</code>ä¸­å»ï¼Œå¹¶ä¸”å¯¹å½“å‰è¿™äº›å­˜åœ¨äºçº¢é»‘æ ‘çš„èŠ‚ç‚¹è®¾ç½®å›è°ƒå‡½æ•°ï¼Œå½“è¿™äº›è¢«ç›‘å¬çš„æ•°æ®ä¸€æ—¦å‡†å¤‡å®Œæˆï¼Œå°±ä¼šè¢«è°ƒç”¨ï¼Œè€Œè°ƒç”¨çš„ç»“æœå°±æ˜¯å°†çº¢é»‘æ ‘çš„FDæ·»åŠ åˆ°<code>list_head</code>ä¸­å»(ä½†æ˜¯æ­¤æ—¶å¹¶æ²¡æœ‰å®Œæˆ)</p><p>å½“ç¬¬äºŒæ­¥å®Œæˆåï¼Œå°±ä¼šè°ƒç”¨<code>epoll_wait</code>å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¼šå»æ ¡éªŒæ˜¯å¦æœ‰æ•°æ®å‡†å¤‡å®Œæ¯•ï¼ˆå› ä¸ºæ•°æ®ä¸€æ—¦å‡†å¤‡å°±ç»ªï¼Œå°±ä¼šè¢«å›è°ƒå‡½æ•°æ·»åŠ åˆ°<code>list_head</code>ä¸­ï¼Œåœ¨ç­‰å¾…äº†ä¸€æ®µæ—¶é—´å(å¯ä»¥è¿›è¡Œé…ç½®)ï¼Œå¦‚æœç­‰å¤Ÿäº†è¶…æ—¶æ—¶é—´ï¼Œåˆ™è¿”å›æ²¡æœ‰æ•°æ®ï¼Œå¦‚æœæœ‰ï¼Œåˆ™è¿›ä¸€æ­¥åˆ¤æ–­å½“å‰æ˜¯ä»€ä¹ˆäº‹ä»¶ï¼Œå¦‚æœæ˜¯å»ºç«‹è¿æ¥æ—¶é—´ï¼Œåˆ™è°ƒç”¨<code>accept()</code> æ¥å—å®¢æˆ·ç«¯socketï¼Œæ‹¿åˆ°å»ºç«‹è¿æ¥çš„socketï¼Œç„¶åå»ºç«‹èµ·æ¥è¿æ¥ï¼Œå¦‚æœæ˜¯å…¶ä»–äº‹ä»¶ï¼Œåˆ™æŠŠæ•°æ®è¿›è¡Œå†™å‡º</p><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior67.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="ä¿¡å·é©±åŠ¨" tabindex="-1"><a class="header-anchor" href="#ä¿¡å·é©±åŠ¨"><span>ä¿¡å·é©±åŠ¨</span></a></h3><p>ä¿¡å·é©±åŠ¨IOæ˜¯ä¸å†…æ ¸å»ºç«‹SIGIOçš„ä¿¡å·å…³è”å¹¶è®¾ç½®å›è°ƒï¼Œå½“å†…æ ¸æœ‰FDå°±ç»ªæ—¶ï¼Œä¼šå‘å‡ºSIGIOä¿¡å·é€šçŸ¥ç”¨æˆ·ï¼ŒæœŸé—´ç”¨æˆ·åº”ç”¨å¯ä»¥æ‰§è¡Œå…¶å®ƒä¸šåŠ¡ï¼Œæ— éœ€é˜»å¡ç­‰å¾…ã€‚</p><p>é˜¶æ®µä¸€ï¼š</p><ul><li>ç”¨æˆ·è¿›ç¨‹è°ƒç”¨sigactionï¼Œæ³¨å†Œä¿¡å·å¤„ç†å‡½æ•°</li><li>å†…æ ¸è¿”å›æˆåŠŸï¼Œå¼€å§‹ç›‘å¬FD</li><li>ç”¨æˆ·è¿›ç¨‹ä¸é˜»å¡ç­‰å¾…ï¼Œå¯ä»¥æ‰§è¡Œå…¶å®ƒä¸šåŠ¡</li><li>å½“å†…æ ¸æ•°æ®å°±ç»ªåï¼Œå›è°ƒç”¨æˆ·è¿›ç¨‹çš„SIGIOå¤„ç†å‡½æ•°</li></ul><p>é˜¶æ®µäºŒï¼š</p><ul><li>æ”¶åˆ°SIGIOå›è°ƒä¿¡å·</li><li>è°ƒç”¨recvfromï¼Œè¯»å–</li><li>å†…æ ¸å°†æ•°æ®æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´</li><li>ç”¨æˆ·è¿›ç¨‹å¤„ç†æ•°æ®</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior68.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>å½“æœ‰å¤§é‡IOæ“ä½œæ—¶ï¼Œä¿¡å·è¾ƒå¤šï¼ŒSIGIOå¤„ç†å‡½æ•°ä¸èƒ½åŠæ—¶å¤„ç†å¯èƒ½å¯¼è‡´ä¿¡å·é˜Ÿåˆ—æº¢å‡ºï¼Œè€Œä¸”å†…æ ¸ç©ºé—´ä¸ç”¨æˆ·ç©ºé—´çš„é¢‘ç¹ä¿¡å·äº¤äº’æ€§èƒ½ä¹Ÿè¾ƒä½ã€‚</p><h3 id="å¼‚æ­¥io" tabindex="-1"><a class="header-anchor" href="#å¼‚æ­¥io"><span>å¼‚æ­¥IO</span></a></h3><p>è¿™ç§æ–¹å¼ï¼Œä¸ä»…ä»…æ˜¯ç”¨æˆ·æ€åœ¨è¯•å›¾è¯»å–æ•°æ®åï¼Œä¸é˜»å¡ï¼Œè€Œä¸”å½“å†…æ ¸çš„æ•°æ®å‡†å¤‡å®Œæˆåï¼Œä¹Ÿä¸ä¼šé˜»å¡</p><p>ä»–ä¼šç”±å†…æ ¸å°†æ‰€æœ‰æ•°æ®å¤„ç†å®Œæˆåï¼Œç”±å†…æ ¸å°†æ•°æ®å†™å…¥åˆ°ç”¨æˆ·æ€ä¸­ï¼Œç„¶åæ‰ç®—å®Œæˆï¼Œæ‰€ä»¥æ€§èƒ½æé«˜ï¼Œä¸ä¼šæœ‰ä»»ä½•é˜»å¡ï¼Œå…¨éƒ¨éƒ½ç”±å†…æ ¸å®Œæˆï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå¼‚æ­¥IOæ¨¡å‹ä¸­ï¼Œç”¨æˆ·è¿›ç¨‹åœ¨ä¸¤ä¸ªé˜¶æ®µéƒ½æ˜¯éé˜»å¡çŠ¶æ€ã€‚</p><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior69.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="å„æ¨¡å‹å¯¹æ¯”" tabindex="-1"><a class="header-anchor" href="#å„æ¨¡å‹å¯¹æ¯”"><span>å„æ¨¡å‹å¯¹æ¯”</span></a></h3><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior70.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="å•çº¿ç¨‹ä¸å¤šçº¿ç¨‹" tabindex="-1"><a class="header-anchor" href="#å•çº¿ç¨‹ä¸å¤šçº¿ç¨‹"><span>å•çº¿ç¨‹ä¸å¤šçº¿ç¨‹</span></a></h2><p><strong>Redisåˆ°åº•æ˜¯å•çº¿ç¨‹è¿˜æ˜¯å¤šçº¿ç¨‹ï¼Ÿ</strong></p><ul><li>å¦‚æœä»…ä»…èŠRedisçš„æ ¸å¿ƒä¸šåŠ¡éƒ¨åˆ†ï¼ˆå‘½ä»¤å¤„ç†ï¼‰ï¼Œç­”æ¡ˆæ˜¯å•çº¿ç¨‹</li><li>å¦‚æœæ˜¯èŠæ•´ä¸ªRedisï¼Œé‚£ä¹ˆç­”æ¡ˆå°±æ˜¯å¤šçº¿ç¨‹</li></ul><p>åœ¨Redisç‰ˆæœ¬è¿­ä»£è¿‡ç¨‹ä¸­ï¼Œåœ¨ä¸¤ä¸ªé‡è¦çš„æ—¶é—´èŠ‚ç‚¹ä¸Šå¼•å…¥äº†å¤šçº¿ç¨‹çš„æ”¯æŒï¼š</p><ul><li>Redis v4.0ï¼šå¼•å…¥å¤šçº¿ç¨‹å¼‚æ­¥å¤„ç†ä¸€äº›è€—æ—¶è¾ƒä¹…çš„ä»»åŠ¡ï¼Œä¾‹å¦‚å¼‚æ­¥åˆ é™¤å‘½ä»¤<code>unlink</code></li><li>Redis v6.0ï¼šåœ¨æ ¸å¿ƒç½‘ç»œæ¨¡å‹ä¸­å¼•å…¥å¤šçº¿ç¨‹ï¼Œè¿›ä¸€æ­¥æé«˜å¯¹äºå¤šæ ¸CPUçš„åˆ©ç”¨ç‡</li></ul><p>å› æ­¤ï¼Œå¯¹äºRedisçš„æ ¸å¿ƒç½‘ç»œæ¨¡å‹ï¼Œåœ¨Redis 6.0ä¹‹å‰éƒ½æ˜¯å•çº¿ç¨‹ã€‚æ˜¯åˆ©ç”¨epollï¼ˆLinuxç³»ç»Ÿï¼‰è¿™æ ·çš„IOå¤šè·¯å¤ç”¨æŠ€æœ¯åœ¨äº‹ä»¶å¾ªç¯ä¸­ä¸æ–­å¤„ç†å®¢æˆ·ç«¯æƒ…å†µã€‚</p><p><strong>ä¸ºä»€ä¹ˆRedisè¦é€‰æ‹©å•çº¿ç¨‹ï¼Ÿ</strong></p><ul><li>æŠ›å¼€æŒä¹…åŒ–ä¸è°ˆï¼ŒRedisæ˜¯çº¯å†…å­˜æ“ä½œï¼Œæ‰§è¡Œé€Ÿåº¦éå¸¸å¿«ï¼Œå®ƒçš„æ€§èƒ½ç“¶é¢ˆæ˜¯ç½‘ç»œå»¶è¿Ÿè€Œä¸æ˜¯æ‰§è¡Œé€Ÿåº¦ï¼Œå› æ­¤å¤šçº¿ç¨‹å¹¶ä¸ä¼šå¸¦æ¥å·¨å¤§çš„æ€§èƒ½æå‡ã€‚</li><li>å¤šçº¿ç¨‹ä¼šå¯¼è‡´è¿‡å¤šçš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå¸¦æ¥ä¸å¿…è¦çš„å¼€é”€</li><li>å¼•å…¥å¤šçº¿ç¨‹ä¼šé¢ä¸´çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œå¿…ç„¶è¦å¼•å…¥çº¿ç¨‹é”è¿™æ ·çš„å®‰å…¨æ‰‹æ®µï¼Œå®ç°å¤æ‚åº¦å¢é«˜ï¼Œè€Œä¸”æ€§èƒ½ä¹Ÿä¼šå¤§æ‰“æŠ˜æ‰£</li></ul><p><strong>Rediså•çº¿ç¨‹ä¸å¤šçº¿ç¨‹ç½‘ç»œæ¨¡å‹å˜æ›´</strong></p><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior71.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior72.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>å½“å®¢æˆ·ç«¯æƒ³è¦å»è¿æ¥æœåŠ¡å™¨ï¼Œä¼šå…ˆåˆ°IOå¤šè·¯å¤ç”¨æ¨¡å‹è¿›è¡Œæ’é˜Ÿï¼Œæ­¤æ—¶ä¼šæœ‰ä¸€ä¸ªè¿æ¥åº”ç­”å¤„ç†å™¨æ¥å—è¯»è¯·æ±‚ï¼Œç„¶ååˆæŠŠè¯»è¯·æ±‚æ³¨å†Œåˆ°å…·ä½“æ¨¡å‹ä¸­å»ï¼Œæ­¤æ—¶è¿™äº›å»ºç«‹èµ·æ¥çš„è¿æ¥ï¼Œå¦‚æœæ˜¯å®¢æˆ·ç«¯è¯·æ±‚å¤„ç†å™¨å»è¿›è¡Œæ‰§è¡Œå‘½ä»¤æ—¶ï¼Œä»–ä¼šå»æŠŠæ•°æ®è¯»å–å‡ºæ¥ï¼Œç„¶åæŠŠæ•°æ®æ”¾å…¥åˆ°clientä¸­ï¼Œ clinetå»è§£æå½“å‰çš„å‘½ä»¤è½¬åŒ–ä¸ºredisè®¤è¯†çš„å‘½ä»¤ï¼Œæ¥ä¸‹æ¥å°±å¼€å§‹å¤„ç†è¿™äº›å‘½ä»¤ï¼Œä»redisä¸­çš„commandä¸­æ‰¾åˆ°è¿™äº›å‘½ä»¤ï¼Œç„¶åå°±çœŸæ­£çš„å»æ“ä½œå¯¹åº”çš„æ•°æ®äº†ï¼Œå½“æ•°æ®æ“ä½œå®Œæˆåï¼Œä¼šå»æ‰¾åˆ°å‘½ä»¤å›å¤å¤„ç†å™¨ï¼Œå†ç”±ä»–å°†æ•°æ®å†™å‡ºã€‚</p><h2 id="respåè®®" tabindex="-1"><a class="header-anchor" href="#respåè®®"><span>RESPåè®®</span></a></h2><p>Redisæ˜¯ä¸€ä¸ªCSæ¶æ„çš„è½¯ä»¶ï¼Œé€šä¿¡ä¸€èˆ¬åˆ†ä¸¤æ­¥ï¼ˆä¸åŒ…æ‹¬pipelineå’ŒPubSubï¼‰ï¼š</p><ul><li>å®¢æˆ·ç«¯ï¼ˆclientï¼‰å‘æœåŠ¡ç«¯ï¼ˆserverï¼‰å‘é€ä¸€æ¡å‘½ä»¤</li><li>æœåŠ¡ç«¯è§£æå¹¶æ‰§è¡Œå‘½ä»¤ï¼Œè¿”å›å“åº”ç»“æœç»™å®¢æˆ·ç«¯å› æ­¤å®¢æˆ·ç«¯å‘é€å‘½ä»¤çš„æ ¼å¼ã€æœåŠ¡ç«¯å“åº”ç»“æœçš„æ ¼å¼å¿…é¡»æœ‰ä¸€ä¸ªè§„èŒƒï¼Œè¿™ä¸ªè§„èŒƒå°±æ˜¯é€šä¿¡åè®®ã€‚</li></ul><p>è€Œåœ¨Redisä¸­é‡‡ç”¨çš„æ˜¯RESPï¼ˆRedis Serialization Protocolï¼‰åè®®ï¼š</p><ul><li>Redis 1.2ç‰ˆæœ¬å¼•å…¥äº†RESPåè®®</li><li>Redis 2.0ç‰ˆæœ¬ä¸­æˆä¸ºä¸RedisæœåŠ¡ç«¯é€šä¿¡çš„æ ‡å‡†ï¼Œç§°ä¸ºRESP2</li><li>Redis 6.0ç‰ˆæœ¬ä¸­ï¼Œä»RESP2å‡çº§åˆ°äº†RESP3åè®®ï¼Œå¢åŠ äº†æ›´å¤šæ•°æ®ç±»å‹å¹¶ä¸”æ”¯æŒ6.0çš„æ–°ç‰¹æ€§--å®¢æˆ·ç«¯ç¼“å­˜</li></ul><p>ç›®å‰ï¼Œé»˜è®¤ä½¿ç”¨çš„ä¾ç„¶æ˜¯RESP2åè®®ã€‚</p><p>åœ¨RESPä¸­ï¼Œé€šè¿‡é¦–å­—èŠ‚çš„å­—ç¬¦æ¥åŒºåˆ†ä¸åŒæ•°æ®ç±»å‹ï¼Œå¸¸ç”¨çš„æ•°æ®ç±»å‹åŒ…æ‹¬5ç§ï¼š</p><ul><li>å•è¡Œå­—ç¬¦ä¸²ï¼šé¦–å­—èŠ‚æ˜¯ â€˜+â€™ ï¼Œåé¢è·Ÿä¸Šå•è¡Œå­—ç¬¦ä¸²ï¼Œä»¥CRLFï¼ˆ &quot;\r\n&quot; ï¼‰ç»“å°¾ã€‚ä¾‹å¦‚è¿”å›&quot;OK&quot;ï¼š &quot;+OK\r\n&quot;</li><li>é”™è¯¯ï¼ˆErrorsï¼‰ï¼šé¦–å­—èŠ‚æ˜¯ â€˜-â€™ ï¼Œä¸å•è¡Œå­—ç¬¦ä¸²æ ¼å¼ä¸€æ ·ï¼Œåªæ˜¯å­—ç¬¦ä¸²æ˜¯å¼‚å¸¸ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼š&quot;-Error message\r\n&quot;</li><li>æ•°å€¼ï¼šé¦–å­—èŠ‚æ˜¯ â€˜:â€™ ï¼Œåé¢è·Ÿä¸Šæ•°å­—æ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œä»¥CRLFç»“å°¾ã€‚ä¾‹å¦‚ï¼š&quot;:10\r\n&quot;</li><li>å¤šè¡Œå­—ç¬¦ä¸²ï¼šé¦–å­—èŠ‚æ˜¯ â€˜$â€™ ï¼Œè¡¨ç¤ºäºŒè¿›åˆ¶å®‰å…¨çš„å­—ç¬¦ä¸²ï¼Œæœ€å¤§æ”¯æŒ512MBï¼š <ul><li>å¦‚æœå¤§å°ä¸º0ï¼Œåˆ™ä»£è¡¨ç©ºå­—ç¬¦ä¸²ï¼š&quot;$0\r\n\r\n&quot;</li><li>å¦‚æœå¤§å°ä¸º-1ï¼Œåˆ™ä»£è¡¨ä¸å­˜åœ¨ï¼š&quot;$-1\r\n&quot;</li></ul></li><li>æ•°ç»„ï¼šé¦–å­—èŠ‚æ˜¯ â€˜*â€™ï¼Œåé¢è·Ÿä¸Šæ•°ç»„å…ƒç´ ä¸ªæ•°ï¼Œå†è·Ÿä¸Šå…ƒç´ ï¼Œå…ƒç´ æ•°æ®ç±»å‹ä¸é™</li></ul><figure><img src="https://gcore.jsdelivr.net/gh/Okita1027/knowledge-database-images@main/database/redis/senior73.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure></div><!----><footer class="vp-page-meta"><div class="vp-meta-item edit-link"><a class="vp-link vp-external-link-icon vp-meta-label" href="https://github.com/Okita1027/kd//edit/main/database/redis/senior.md" rel="noopener noreferrer" target="_blank" aria-label="ç¼–è¾‘æ­¤é¡µ"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon" name="edit"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->ç¼–è¾‘æ­¤é¡µ<!----></a></div><div class="vp-meta-item git-info"><!----><!----></div></footer><nav class="vp-page-nav"><a class="route-link vp-link prev" href="/kd/database/redis/practical.html" aria-label="å®æˆ˜ç¯‡"><div class="hint"><span class="arrow start"></span>ä¸Šä¸€é¡µ</div><div class="link"><!---->å®æˆ˜ç¯‡</div></a><!----></nav><!----><!----><!--]--></main><!--]--><!----></div><!--]--><!--]--><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/kd/assets/app-CJZ--YWM.js" defer></script>
  </body>
</html>
